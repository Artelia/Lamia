

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lamia.toolabstract.Lamia_abstract_tool &mdash; Documentation LAMIA 1.0</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> LAMIA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../D_marche_g_n_rale__license.html">Démarche générale, license</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tutoriel.html">Tutoriel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developpement.html">Developpement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">LAMIA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Code du module</a> &raquo;</li>
        
      <li>Lamia.toolabstract.Lamia_abstract_tool</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Code source de Lamia.toolabstract.Lamia_abstract_tool</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file is part of LAMIA.</span>

<span class="sd">    LAMIA is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    LAMIA is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with Foobar.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  * Copyright (c) 2017-2020 ARTELIA Commit &lt;lamia@arteliagroup.com&gt;</span>
<span class="sd">  * </span>
<span class="sd">  * SPDX-License-Identifier: GPL-3.0-or-later</span>
<span class="sd">  * License-Filename: LICENSING.md</span>
<span class="sd"> &quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">qgis</span>
<span class="kn">import</span> <span class="nn">qgis.utils</span>
<span class="kn">from</span> <span class="nn">qgis.PyQt</span> <span class="k">import</span> <span class="n">uic</span><span class="p">,</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">qgis.PyQt.QtGui</span> <span class="k">import</span> <span class="p">(</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QTableWidget</span><span class="p">,</span>
                                 <span class="n">QHeaderView</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span> <span class="n">QSpinBox</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QDateEdit</span><span class="p">,</span><span class="n">QDateTimeEdit</span><span class="p">,</span> <span class="n">QTextEdit</span><span class="p">,</span>
                                 <span class="n">QDoubleSpinBox</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QTreeWidget</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">,</span>
                                 <span class="n">QLabel</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QTextBrowser</span><span class="p">,</span> <span class="n">QTableWidgetItem</span><span class="p">,</span><span class="n">QApplication</span><span class="p">,</span><span class="n">QToolButton</span><span class="p">,</span> <span class="n">QAbstractItemView</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">qgis.PyQt.QtWidgets</span> <span class="k">import</span> <span class="p">(</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QTableWidget</span><span class="p">,</span>
                                     <span class="n">QHeaderView</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span> <span class="n">QSpinBox</span><span class="p">,</span><span class="n">QCheckBox</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QDateEdit</span><span class="p">,</span><span class="n">QDateTimeEdit</span><span class="p">,</span> <span class="n">QTextEdit</span><span class="p">,</span>
                                     <span class="n">QDoubleSpinBox</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QTreeWidget</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">,</span>
                                     <span class="n">QLabel</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QTextBrowser</span><span class="p">,</span> <span class="n">QTableWidgetItem</span><span class="p">,</span><span class="n">QApplication</span><span class="p">,</span><span class="n">QToolButton</span><span class="p">,</span> <span class="n">QAbstractItemView</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">pprint</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">..dialog.InspectionDigue_linkage</span> <span class="k">import</span> <span class="n">LinkageDialog</span>
<span class="kn">from</span> <span class="nn">..maptool.mapTools</span> <span class="k">import</span> <span class="n">mapToolCapture</span>


<span class="n">debugconnector</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="AbstractLamiaTool"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool">[docs]</a><span class="k">class</span> <span class="nc">AbstractLamiaTool</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is the abstract class for every widget loaded in the right part of te dockwidget.</span>
<span class="sd">    If you want another widget, you have :</span>

<span class="sd">    - create a file in Lamia.toolpostpro.[the_job]</span>

<span class="sd">    - Fill it with the following code :</span>


<span class="sd">    .. code-block:: python</span>

<span class="sd">        class ExampleTool(AbstractLamiaTool):</span>
<span class="sd">            TOOLNAME = &#39;test_module&#39;          #is TOOLNAME exists, lamia recognize it as postpro tool</span>

<span class="sd">            def __init__(self, dbase, dialog=None, linkedtreewidget=None, gpsutil=None,parentwidget=None, parent=None):</span>
<span class="sd">                super(ExampleTool, self).__init__(dbase, dialog, linkedtreewidget, gpsutil,parentwidget, parent=parent)</span>

<span class="sd">            def initTool(self):     # it s inside this function that we configure the minimal behaviour</span>
<span class="sd">                self.CAT = &#39;Synthese&#39;       #The first col tree widget in the left side of lamia dock</span>
<span class="sd">                self.NAME = &#39;Couts&#39;        #The second col tree widget in the left side of lamia dock</span>
<span class="sd">                self.visualmode = [4]       # put in list in which visual mode you want to see the widget (4 for post pro)</span>

<span class="sd">                self.groupBox_elements.setParent(None)      # disable managing part of he widget</span>
<span class="sd">                self.frame_editing.setParent(None)          # disable editing part of he widget</span>

<span class="sd">            def initFieldUI(self):      # load the widget to appear</span>
<span class="sd">                if self.userwdgfield is None:</span>
<span class="sd">                    self.userwdgfield = UserUI()</span>

<span class="sd">        class UserUI(QWidget):                  #load the ui made with QT Designer</span>
<span class="sd">            def __init__(self, parent=None):</span>
<span class="sd">                super(UserUI, self).__init__(parent=parent)</span>
<span class="sd">                uipath = os.path.join(os.path.dirname(__file__), &#39;test_module.ui&#39;)</span>
<span class="sd">                uic.loadUi(uipath, self)</span>


<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">saveFeatureSignal</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">currentFeatureChanged</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">lamiageomChanged</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">postInitFeaturePropertiesActivated</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="n">specialfieldui</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dialog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linkedtreewidget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gpsutil</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parentwidget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of AbstractLamiaTool</span>

<span class="sd">        :param dbase:              The DBaseParser class</span>
<span class="sd">        :param dialog:             The Lamia.dialog.InspectionDigue_windowwidget class</span>
<span class="sd">        :param linkedtreewidget:   The QTreeWidget Wwhee the ids appears</span>
<span class="sd">        :param gpsutil:            the GpsUtil class for maning GPS connexion</span>
<span class="sd">        :param parentwidget:       the parentWidget class, in case of use in prepro</span>
<span class="sd">        :param parent:             the Qt parent</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debugtime</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span>
            <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">AbstractLamiaTool</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start init </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="n">uipath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;dialog&#39;</span><span class="p">,</span> <span class="s1">&#39;InspectionDigue_propertieswidget.ui&#39;</span><span class="p">)</span>
        <span class="n">uic</span><span class="o">.</span><span class="n">loadUi</span><span class="p">(</span><span class="n">uipath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step1 prop wdg </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
        <span class="c1"># ***************************************************************</span>
        <span class="c1"># ******************   Variables def ****************************</span>
        <span class="c1"># ***************************************************************</span>

        <span class="c1"># ***** Data base var</span>
        <span class="c1">#  the dbaseparser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span> <span class="o">=</span> <span class="n">dbase</span>
        <span class="c1"># the gpsutil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span> <span class="o">=</span> <span class="n">gpsutil</span>
        <span class="c1">#  the current widget feature selected in self.linkedtreewidget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeature</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#  the current feature selected when widget is linked withh a parent feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentparentfeature</span> <span class="o">=</span> <span class="kc">None</span>    <span class="c1"># not used</span>
        <span class="c1">#  the FK tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fktables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="o">=</span> <span class="n">parentwidget</span>
        <span class="c1">#  ids to load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idstoload</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self.linkageids = None</span>
        <span class="c1"># data for datas in config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ***** Ui var</span>
        <span class="c1">#  Name used for rool tree in main qtreewidget - must be implemented</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CAT</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#  Name used for child tree in main qtreewidget - must be implemented</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#  Table name linked with widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbtablename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#  iconpath -  can be implemented</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iconpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># enable multipleselection in ElemtreeWidget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multipleselection</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#  Main window widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="o">=</span> <span class="n">dialog</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">windowdialog</span>
        <span class="c1">#  MaintreeWidget qtreewidgetitem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#  the qtreewidget within the features are displayed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="o">=</span> <span class="n">linkedtreewidget</span>
        <span class="c1"># list of feature in linkedtreewidget : [...[id,QTreeWidgetItem([str(id)])] ...]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treefeatlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># show only inside feature mapcanvas  in linkedtreewidget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowsonlyfeature</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#  the child widgets</span>
        <span class="c1">#whildwdg change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgdesktop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># user widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userwdgfield</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdgfield</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userwdgdesktop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdgdesktop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span> <span class="o">=</span> <span class="kc">None</span>             <span class="c1">#current userwdg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="o">=</span> <span class="kc">None</span>             <span class="c1">#current linkuserwdg</span>
        <span class="c1"># wile saving new feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeatureVersion</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#lastidselected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastidselected</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># linked disorder</span>
        <span class="c1">#self.linkeddisorder = None</span>
        <span class="c1"># self.linkeddisorder = {&#39;specificfield&#39;: &#39;OUH&#39;,</span>
        <span class="c1">#                         &#39;groupedesordre&#39;: &#39;NOD&#39;}</span>
        <span class="c1"># linked geom : [..[tablename,linkfield of tablename],...]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkedgeom</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step2 end var  </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="c1">#  tablewidget - expert widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span> <span class="o">=</span> <span class="n">QTableWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">setResizeMode</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>
            <span class="n">header</span><span class="o">.</span><span class="n">setResizeMode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="o">.</span><span class="n">ResizeToContents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>
            <span class="n">header</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="o">.</span><span class="n">ResizeToContents</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setColumnWidth</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setColumnWidth</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step3 table wdg </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="c1"># header.setResizeMode(2, QHeaderView.ResizeToContents)</span>
        <span class="c1"># header.setResizeMode(3, QHeaderView.ResizeToContents)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span> <span class="o">=</span> <span class="s1">&#39;Nouvelle entree&#39;</span>
        <span class="c1"># user widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#  field name to be displayd in qtreewidget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetfields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#  when gps info need to be displayed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># self.dbaseressourcesfield = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capturetype</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ***** QGis var</span>
        <span class="c1">#  qgis map canvas</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">canvas</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># layer shown in cnvas or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layerdisplayed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># capture mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PointENABLED</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LineENABLED</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PolygonENABLED</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magicfunctionENABLED</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># ruberband</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># captured geoemtry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># the dbasetable - loaded once a dbase is loaded in DBaseParser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># use for picking</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolEmitPoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>   <span class="c1"># maptoolused for picking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># qgsmaptoolcapture used for capturing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1">#for coping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepcopy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#for lid choosers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamiawidgets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># *******************************************************</span>
        <span class="c1"># raw connection</span>
        <span class="c1"># *******************************************************</span>
        <span class="c1"># load tools - must be kept in this order</span>
        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;before initTool </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initTool</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;After initTool </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="c1"># *******************************************************</span>
        <span class="c1"># Post inittool things</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_savefeature</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveFeature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_addFeature</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addFeature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_delFeature</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deleteFeature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_deselect</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deselectFeature</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_copy</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copyAtributes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_paste</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pasteAtributes</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_impression</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">printWidget</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_deepcopy</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_deepcopy</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepCopy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_deepcopyselect</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepCopy</span><span class="p">)</span>

        <span class="c1">#work even with postpro tool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changePropertiesWidget</span><span class="p">()</span>
        <span class="c1"># connect signals of inherited widget</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">currentItemChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onActivationRaw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end change propertie wdg  </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initWidgets</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end init widget </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>


<div class="viewcode-block" id="AbstractLamiaTool.initTool"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.initTool">[docs]</a>    <span class="k">def</span> <span class="nf">initTool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to be overloaded in herited class. thie function is called during he __init__ function.</span>
<span class="sd">        You can specify :</span>

<span class="sd">        - self.CAT = &#39;Ressources&#39; # the name of the fist column QTreeWidget in upper left part of Lamia dock</span>

<span class="sd">        - self.NAME = &#39;Croquis&#39;     # the name of the second column QTreeWidget in upper left part of Lamia dock</span>

<span class="sd">        - self.visualmode = [ 1, 2] # the visual modes you want this widget to appear (1 : prepro, 2 desktop, 4 postpro)</span>

<span class="sd">        - self.iconpath = [file_path]     # the file path of the Icon of the second column QTreeWidget in upper left part of Lamia dock</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractLamiaTool.initFieldUI"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.initFieldUI">[docs]</a>    <span class="k">def</span> <span class="nf">initFieldUI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function called during the first loading of the lamia dbase. It loads the widgets in self.userwdgfield variable</span>

<span class="sd">        Exemple of minimal code :</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            if self.userwdgfield is None:       #prevent to load multiple times</span>
<span class="sd">                self.userwdgfield = UserUI()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractLamiaTool.initDesktopUI"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.initDesktopUI">[docs]</a>    <span class="k">def</span> <span class="nf">initDesktopUI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function called When destop visual mode is loaded. function to be overload if desktop widget is different from</span>
<span class="sd">        base widget. You must load the widget in  self.userwdgdesktop variable</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initFieldUI</span><span class="p">()</span></div>

    <span class="c1"># ******************************************************************************************************************</span>
    <span class="c1"># **********************************    on dbase loaded   methods        *******************************************</span>
    <span class="c1"># ******************************************************************************************************************</span>

<div class="viewcode-block" id="AbstractLamiaTool.magicFunction"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.magicFunction">[docs]</a>    <span class="k">def</span> <span class="nf">magicFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function called when the magic icon is clicked. function to be overload you want a special action</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractLamiaTool.changePropertiesWidget"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.changePropertiesWidget">[docs]</a>    <span class="k">def</span> <span class="nf">changePropertiesWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interfacename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function activated when visual mode is changed. Assign self.userwdgfield  or self.userwdgdesktop  to</span>
<span class="sd">        self.userwdg which is the current widget used.</span>
<span class="sd">        Activate changePropertiesWidget for the self.dbasechildwdg also.</span>

<span class="sd">        visualmode = 0 is for base interface</span>
<span class="sd">        visualmode = 1 is for destop interface</span>
<span class="sd">        visualmode = 4 is for postpro interface</span>

<span class="sd">        :param interfacename: TODO</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start init </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="c1"># clear groupBox_properties</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># disconnect currentFeatureChanged signal to dbasechildwdg</span>
        <span class="k">for</span> <span class="n">childwdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeatureChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">childwdg</span><span class="o">.</span><span class="n">loadChildFeatureinWidget</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;befor  set wdg  </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># load proper widget</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="c1"># define self.userwdg, self.linkuserwdg and self.dbasechildwdg</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">interfacename</span> <span class="ow">is</span> <span class="kc">None</span>
                            <span class="ow">or</span> <span class="p">(</span><span class="n">interfacename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                    <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interfacename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
                                         <span class="ow">or</span> <span class="n">interfacename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specialfieldui</span><span class="p">)</span> <span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">initFieldUI</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdgfield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdgfield</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdgfield</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">typeinterface</span> <span class="o">=</span> <span class="n">interfacename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;self.initFieldUI_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">typeinterface</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;()&#39;</span><span class="p">)</span>
                        <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;self.userwdg = self.userwdgfield_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">typeinterface</span><span class="p">))</span>
                        <span class="n">exec</span> <span class="p">(</span><span class="s1">&#39;self.linkuserwdg = self.linkuserwdgfield_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">typeinterface</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initDesktopUI</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdgdesktop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdgdesktop</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdgdesktop</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdgfield</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdgfield</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgdesktop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgdesktop</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initDesktopUI</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdgfield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdgfield</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdgfield</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdgfield</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="c1">#init fields</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initWidgetUI</span><span class="p">()</span>
                <span class="c1"># load userwdg</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># reconnect currentFeatureChanged signal to dbasechildwdg</span>
        <span class="k">for</span> <span class="n">childwdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeatureChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">childwdg</span><span class="o">.</span><span class="n">loadChildFeatureinWidget</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debugconnector</span><span class="p">:</span>
                <span class="n">tempparentwdg</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="n">tempresult</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">childwdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">childwdg</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">tempparentwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tempresult</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tempparentwdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tempparentwdg</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
                    <span class="n">tempparentwdg</span> <span class="o">=</span> <span class="n">tempparentwdg</span><span class="o">.</span><span class="n">parentWidget</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;currentFeatureChanged connection : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tempresult</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;befor  changePropertiesWidget </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="c1"># dbasechildwdg change</span>
        <span class="k">for</span> <span class="n">childwdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">:</span>
            <span class="n">childwdg</span><span class="o">.</span><span class="n">changePropertiesWidget</span><span class="p">(</span><span class="n">interfacename</span><span class="o">=</span><span class="n">interfacename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;after  changePropertiesWidget </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="c1"># load the widgets in main tree</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualmode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadWidgetinMainTree</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unloadWidgetinMainTree</span><span class="p">()</span>

        <span class="c1"># reload state (feature selected before changes)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tempitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">currentItem</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tempitem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">currentItem</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tempitemid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tempitem</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">onActivationRaw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">currentItem</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tempitemid</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end init </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.loadWidgetinMainTree"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.loadWidgetinMainTree">[docs]</a>    <span class="k">def</span> <span class="nf">loadWidgetinMainTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called on the widget creation in windowsdialog</span>
<span class="sd">        load the widget in the main stacked widget</span>
<span class="sd">        call onActivationRaw when qtreewidgetitem is clicked in MaintreeWidget</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># add qtreewidget item in MaintreeWidget</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arb</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CAT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">arb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">unicode</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">arb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">arb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">arb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="o">.</span><span class="n">flags</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iconpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iconpath</span><span class="p">))</span>
            <span class="n">wdgitem</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span>
            <span class="n">child_count</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">childCount</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">child_count</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">arb</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">wdgitem</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">wdgitem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wdgitem</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">()</span>
                <span class="n">wdgitem</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">arb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">addTopLevelItems</span><span class="p">([</span><span class="n">wdgitem</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">wdgitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wdgitem</span><span class="o">.</span><span class="n">childCount</span><span class="p">())]:</span>
                <span class="n">wdgitem</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="p">)</span>
            <span class="n">wdgitem</span><span class="o">.</span><span class="n">setExpanded</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.unloadWidgetinMainTree"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.unloadWidgetinMainTree">[docs]</a>    <span class="k">def</span> <span class="nf">unloadWidgetinMainTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unload the widget in the main stacked widget</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">arb</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CAT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wdgitem</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span>
            <span class="n">child_count</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">childCount</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">child_count</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">arb</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">wdgitem</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">wdgitem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wdgitem</span> <span class="o">=</span> <span class="n">root</span>
            <span class="n">wdgitem</span><span class="o">.</span><span class="n">removeChild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wdgitem</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span> <span class="ow">and</span> <span class="n">wdgitem</span><span class="o">.</span><span class="n">childCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span><span class="o">.</span><span class="n">removeChild</span><span class="p">(</span><span class="n">wdgitem</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">disconnectIdsGui</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.initWidgets"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.initWidgets">[docs]</a>    <span class="k">def</span> <span class="nf">initWidgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by  __init__</span>
<span class="sd">        Init QTableWidget for &quot;pro&quot; interface</span>
<span class="sd">        Init widget geometry buttons</span>
<span class="sd">        Init GPS management</span>
<span class="sd">        Init magic function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># **********************************************************</span>
        <span class="c1"># PRO Table Things</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">templinkuserwgd</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">templinkuserwgd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span>

        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">templinkuserwgd</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">rowPosition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">)</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">field</span><span class="p">)</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">wdg</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="n">description</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wdg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;ParFldCst&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">listfieldname</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span>
                                             <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())]</span>
                            <span class="n">indexparentfield</span> <span class="o">=</span> <span class="n">listfieldname</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                                <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;ParFldCst&#39;</span><span class="p">])</span>
                            <span class="n">nameparenttalbe</span><span class="p">,</span> <span class="n">nameparentfield</span> <span class="o">=</span> <span class="n">listfieldname</span><span class="p">[</span><span class="n">indexparentfield</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                            <span class="n">comboparent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">indexparentfield</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">comboparent</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboparentValueChanged</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;error </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;INTEGER&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id_&#39;</span><span class="p">,</span> <span class="s1">&#39;pk_&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lpk_&#39;</span><span class="p">]:</span>
                            <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

                            <span class="n">wdg2</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Show&#39;</span><span class="p">)</span>
                            <span class="n">wdg2</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wdg2</span><span class="p">)</span>
                            <span class="n">wdg2</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawtablePushButtonClicked</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">wdg</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
                            <span class="n">wdg</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9999999</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wdg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lid_&#39;</span><span class="p">]:</span>
                            <span class="n">wdg2</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Pick&#39;</span><span class="p">)</span>
                            <span class="n">wdg2</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wdg2</span><span class="p">)</span>
                            <span class="n">wdg2</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawtablePushButtonClicked</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;VARCHAR&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s1">&#39;datetime&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]:</span>
                            <span class="n">wdg</span> <span class="o">=</span> <span class="n">QDateTimeEdit</span><span class="p">()</span>
                            <span class="n">wdg</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                            <span class="n">wdg</span><span class="o">.</span><span class="n">setCalendarPopup</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wdg</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
                            <span class="n">wdg</span> <span class="o">=</span> <span class="n">QDateEdit</span><span class="p">()</span>
                            <span class="n">wdg</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                            <span class="n">wdg</span><span class="o">.</span><span class="n">setCalendarPopup</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wdg</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">wdg</span> <span class="o">=</span> <span class="n">QTextEdit</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wdg</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setRowHeight</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s1">&#39;File&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
                                <span class="n">wdg</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wdg</span><span class="p">)</span>
                                <span class="n">wdg</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawtablePushButtonClicked</span><span class="p">)</span>
                                <span class="n">wdg</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Open&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">wdg</span><span class="p">)</span>
                                <span class="n">wdg</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawtablePushButtonClicked</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;NUMERIC&#39;</span>  <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]</span>
                                <span class="ow">or</span> <span class="s1">&#39;REAL&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]):</span>
                        <span class="n">wdg</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">()</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9999999</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">rowPosition</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wdg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;FK&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># print(dbasetable[&#39;fields&#39;][field][&#39;FK&#39;].split(&#39;(&#39;)[0])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fktables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;FK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tablename</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>

        <span class="c1"># **********************************************************</span>
        <span class="c1"># geoemtry:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_goto</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goToFeaturePressed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_goto</span><span class="o">.</span><span class="n">released</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goToFeatureReleased</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_rajoutPointGPS</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_rajoutPointGPS</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addGPSPoint</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_rajoutPoint</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addPoint</span><span class="p">)</span>
            <span class="c1"># self.pushButton_rajoutPointGPS.clicked.connect(self.captureGeometry)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LineENABLED</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">PolygonENABLED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_editgeom</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_editgeom</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">editFeature</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_editgeom</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PointENABLED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_addPoint</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">captureGeometry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_addPoint</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LineENABLED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_addLine</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">captureGeometry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_addLine</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PolygonENABLED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_addPolygon</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">captureGeometry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_addPolygon</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># map tool for capturing</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">mtoolpoint</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtoolline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">mtoolline</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpolygon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">mtoolpolygon</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_geom</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1">#self.groupBox_geom.setVisible(False)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_goto</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># GPS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">GPSConnected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayGPS</span><span class="p">)</span>

        <span class="c1"># Magic button</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">magicfunctionENABLED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_magic</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magicFunction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_magic</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_linkage</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manageLinkage</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_linkage</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_linkage</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.initWidgetUI"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.initWidgetUI">[docs]</a>    <span class="k">def</span> <span class="nf">initWidgetUI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by changePropertiesWidget</span>

<span class="sd">        - Init combobox with default values</span>

<span class="sd">        - Init Parent/child combobox behaviour</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">templinkuserwgd</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">templinkuserwgd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span>


        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">templinkuserwgd</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">linkuserwdg</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">tablename</span> <span class="ow">in</span> <span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                <span class="ow">and</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">wdgs</span> <span class="o">=</span> <span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="c1"># combox filling with constraints</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">QComboBox</span><span class="p">)):</span>

                                    <span class="n">templist</span> <span class="o">=</span> <span class="p">[</span><span class="n">description</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span>
                                                <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]]</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">):</span>
                                        <span class="n">wdgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">wdgs</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="n">wdgs</span><span class="p">:</span>
                                        <span class="n">wdg</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                                        <span class="n">wdg</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">templist</span><span class="p">)</span>

                            <span class="k">if</span> <span class="s1">&#39;ParFldCst&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">nameparentfield</span> <span class="o">=</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;ParFldCst&#39;</span><span class="p">]</span>
                                <span class="c1"># userwidget</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">tablename</span> <span class="ow">in</span> <span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;widgets&#39;</span> <span class="ow">in</span> <span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                        <span class="ow">and</span> <span class="n">nameparentfield</span> <span class="ow">in</span> <span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">nameparentfield</span><span class="p">],</span> <span class="n">QComboBox</span><span class="p">)):</span>
                                    <span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">nameparentfield</span><span class="p">]</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboparentValueChanged</span><span class="p">)</span>

                            <span class="c1"># multiple wdg for field management</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">QComboBox</span><span class="p">):</span>
                                    <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="n">wdgs</span><span class="p">:</span>
                                        <span class="n">wdg</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manageMultipleWidgetField</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">QSpinBox</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">QDoubleSpinBox</span><span class="p">):</span>
                                    <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="n">wdgs</span><span class="p">:</span>
                                        <span class="n">wdg</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manageMultipleWidgetField</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.manageMultipleWidgetField"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.manageMultipleWidgetField">[docs]</a>    <span class="k">def</span> <span class="nf">manageMultipleWidgetField</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activated by widget.valueChanged or widget.currentIndexChanged signal</span>

<span class="sd">        Manage multiple combobox or spinbox linked to one table field</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">senderwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">wdgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdgs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">senderwdg</span> <span class="ow">in</span> <span class="n">wdgs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">senderwdg</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="n">wdgs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">wdg</span> <span class="o">!=</span> <span class="n">senderwdg</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">wdg</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manageMultipleWidgetField</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="n">wdg</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">senderwdg</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">())</span>
                                <span class="n">wdg</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manageMultipleWidgetField</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">senderwdg</span><span class="p">,</span> <span class="n">QSpinBox</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">senderwdg</span><span class="p">,</span> <span class="n">QDoubleSpinBox</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="n">wdgs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">wdg</span> <span class="o">!=</span> <span class="n">senderwdg</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">wdg</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manageMultipleWidgetField</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="n">wdg</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">senderwdg</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
                                <span class="n">wdg</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manageMultipleWidgetField</span><span class="p">)</span>
                        <span class="k">break</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.comboparentValueChanged"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.comboparentValueChanged">[docs]</a>    <span class="k">def</span> <span class="nf">comboparentValueChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activated by currentIndexChanged</span>

<span class="sd">        Manage paret/child combobox</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">senderwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**&#39;</span><span class="p">,</span> <span class="n">senderwdg</span><span class="o">.</span><span class="n">objectName</span><span class="p">())</span>

        <span class="n">senderwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">senderwdg</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">)</span> <span class="ow">and</span> <span class="n">senderwdg</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># case triple descendant and parent not filled</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">parenttablename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">parentfieldname</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">userwdg</span><span class="p">:</span>
            <span class="n">comefromrawtable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">senderwdg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]:</span>
                            <span class="n">parenttablename</span> <span class="o">=</span> <span class="n">tablename</span>
                            <span class="n">parentfieldname</span> <span class="o">=</span> <span class="n">fieldname</span>
                            <span class="k">break</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="n">senderwdg</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>
            <span class="n">parenttablename</span><span class="p">,</span> <span class="n">parentfieldname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">comefromrawtable</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">parenttablename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">parentcstvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getConstraintRawValueFromText</span><span class="p">(</span><span class="n">parenttablename</span><span class="p">,</span> <span class="n">parentfieldname</span><span class="p">,</span>
                                                                      <span class="n">senderwdg</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;error </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">parenttablename</span><span class="p">,</span> <span class="n">parentfieldname</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">parenttablename</span><span class="p">]</span>
        <span class="c1"># get child index and combochild</span>
        <span class="n">listparentcst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;ParFldCst&#39;</span><span class="p">]</span>
                         <span class="k">if</span> <span class="s1">&#39;ParFldCst&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
                         <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="n">childfieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">listparentcst</span><span class="p">))</span>
                           <span class="k">if</span> <span class="n">parentfieldname</span> <span class="o">==</span> <span class="n">listparentcst</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">comefromrawtable</span><span class="p">:</span>
            <span class="n">listfieldname</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())]</span>
            <span class="k">for</span> <span class="n">childfieldname</span> <span class="ow">in</span> <span class="n">childfieldnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">parentfieldname</span><span class="p">][</span>
                    <span class="s1">&#39;PGtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;INT&#39;</span> <span class="ow">and</span> <span class="n">parentcstvalue</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">parentcstvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parentcstvalue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parentcstvalue</span><span class="p">)</span>
                <span class="n">listtoadd</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">childfieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span> <span class="k">if</span>
                             <span class="n">parentcstvalue</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">indexchildintable</span> <span class="o">=</span> <span class="n">listfieldname</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parenttablename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">childfieldname</span><span class="p">)</span>
                <span class="n">combochild</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">indexchildintable</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">combochild</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listtoadd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">combochild</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">listtoadd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">childfieldname</span> <span class="ow">in</span> <span class="n">childfieldnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">parentfieldname</span><span class="p">][</span>
                    <span class="s1">&#39;PGtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;INT&#39;</span> <span class="ow">and</span> <span class="n">parentcstvalue</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">parentcstvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parentcstvalue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parentcstvalue</span><span class="p">)</span>
                <span class="n">listtoadd</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">childfieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span> <span class="k">if</span>
                             <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">parentcstvalue</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                <span class="k">if</span> <span class="n">childfieldname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">parenttablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]:</span>
                    <span class="n">combochild</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">parenttablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">childfieldname</span><span class="p">]</span>
                    <span class="n">combochild</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listtoadd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">combochild</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">listtoadd</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.manageLinkage"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.manageLinkage">[docs]</a>    <span class="k">def</span> <span class="nf">manageLinkage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by self.pushButton_linkage.clicked.connect(self.manageLinkage)</span>

<span class="sd">        Open dialog when linkage button is clicked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">[</span><span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dlg_linkage</span> <span class="o">=</span> <span class="n">LinkageDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dlg_linkage</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dlg_linkage</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadFeaturesinTreeWdg</span><span class="p">()</span>
        <span class="n">idwidgetindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentid</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">idwidgetindex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnectIdsGui</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">idwidgetindex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">idwidgetindex</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.initLinkageFromGeometry"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.initLinkageFromGeometry">[docs]</a>    <span class="k">def</span> <span class="nf">initLinkageFromGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linkagekey</span><span class="p">,</span> <span class="n">idsourcevalue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ?</span>
<span class="sd">        :param linkagekey:</span>
<span class="sd">        :param idsourcevalue:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idslink</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">linkagetemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span><span class="p">[</span><span class="n">linkagekey</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">idsourcevalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idsourcevalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">[</span><span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;idsource&#39;</span><span class="p">]]</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;tabletc&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE  &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;idtcsource&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; =  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idsourcevalue</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
        <span class="c1"># print(sql)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span><span class="p">[</span><span class="n">linkagekey</span><span class="p">][</span><span class="s1">&#39;desttable&#39;</span><span class="p">]:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;iddest&#39;</span><span class="p">]</span>  <span class="o">+</span><span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE ST_Within(ST_MakeValid(&quot;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;.geom),ST_MakeValid(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s2">&quot;.geom))&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;.id_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idstemp</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
                <span class="n">idslink</span> <span class="o">+=</span> <span class="n">idstemp</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">idslink</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;tabletc&#39;</span><span class="p">]</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;idtcsource&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;idtcdest&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;) &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;VALUES(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idsourcevalue</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;);&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.rawtablePushButtonClicked"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.rawtablePushButtonClicked">[docs]</a>    <span class="k">def</span> <span class="nf">rawtablePushButtonClicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pro interface - click manager</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">senderwdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="n">senderwdg</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>
        <span class="n">tablename</span><span class="p">,</span> <span class="n">fieldname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">senderwdg</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;File&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getOpenFileNameAndFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Choose the file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                                     <span class="s1">&#39;All (*.*)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setValueInWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">file</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">senderwdg</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Open&#39;</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValueFromWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">completePathOfFile</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">senderwdg</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Pick&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickfield</span> <span class="o">=</span> <span class="n">fieldname</span>
            <span class="c1"># print(&#39;pick&#39;, self.pickfield )</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickFeature</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">senderwdg</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Show&#39;</span><span class="p">:</span>
            <span class="n">idrequested</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">FKtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;FK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;widget&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">FKtable</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">FKtable</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnectIdsGui</span><span class="p">()</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">disconnectIdsGui</span><span class="p">()</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">(</span><span class="n">idrequested</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span> <span class="o">=</span> <span class="n">QDialog</span><span class="p">()</span>
                <span class="n">vboxlayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
                <span class="n">vboxlayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">wdg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">vboxlayout</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



    <span class="c1"># *******************************************************************************************************************</span>
    <span class="c1"># **********************************    on activation/des methods        *******************************************</span>
    <span class="c1"># ******************************************************************************************************************</span>

<div class="viewcode-block" id="AbstractLamiaTool.onActivationRaw"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.onActivationRaw">[docs]</a>    <span class="k">def</span> <span class="nf">onActivationRaw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage the activation of widget when tool&#39;s icon is clicked on main QTreeWidget</span>

<span class="sd">        Do:</span>

<span class="sd">        - display tool widget</span>

<span class="sd">        - load features in ElemtreeWidget</span>

<span class="sd">        - connect ElemtreeWidget click to featureSelected</span>

<span class="sd">        - Finaly, call postOnActivation method, which is a function to be overloaded</span>

<span class="sd">        TODO : display or not the layer</span>


<span class="sd">        :param param1:  a QTreeWidgetItem (the one activated in main QTreeWidget)</span>
<span class="sd">        :param param2: a QTreeWidgetItem (the one desactivated in main QTreeWidget)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">param2</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">)</span> <span class="ow">or</span> <span class="n">param2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>    <span class="c1"># signal from treeWidget_utils</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step 1 </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">param1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">param1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="p">,</span> <span class="n">param2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">param2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">param2</span> <span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step 2 desactivation </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">param2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onDesactivationRaw</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">postOnDesactivation</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">param2</span> <span class="o">==</span> <span class="n">param1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lastidselected</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">param1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step 3 activation </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">param1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">param2</span><span class="p">)</span>
                <span class="c1"># manage display in canvas</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_checkLayerVisibility</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipleselection</span>  <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">ExtendedSelection</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">SingleSelection</span><span class="p">)</span>

                <span class="c1"># add child widget</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loadChildWidgets</span><span class="p">()</span>

                <span class="c1"># manage widget display</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;TOOLNAME&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                <span class="c1"># load feature in bottom qtreewidget</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">))):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loadFeaturesinTreeWdg</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastidselected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                            <span class="n">idwidgetindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastidselected</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">idwidgetindex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">:</span> <span class="c1">#-1 not found</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">idwidgetindex</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">setExpanded</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">initFeatureProperties</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                <span class="c1">#change active layer in canvas</span>
                <span class="k">if</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]:</span>
                    <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">setActiveLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">])</span>

                <span class="c1"># Specific method</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">postOnActivation</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.loadChildWidgets"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.loadChildWidgets">[docs]</a>    <span class="k">def</span> <span class="nf">loadChildWidgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the childs widgets - called by onActivationRaw</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">tabWidget_childs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># childwdg change</span>
        <span class="k">for</span> <span class="n">childwdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">childwdg</span><span class="o">.</span><span class="n">NAME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">tabWidget_childs</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="n">childwdg</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="n">childwdg</span><span class="o">.</span><span class="n">iconpath</span><span class="p">),</span> <span class="n">childwdg</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.postOnActivation"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.postOnActivation">[docs]</a>    <span class="k">def</span> <span class="nf">postOnActivation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method - must be implemented</span>
<span class="sd">        called by onActivationRaw</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractLamiaTool.onDesactivationRaw"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.onDesactivationRaw">[docs]</a>    <span class="k">def</span> <span class="nf">onDesactivationRaw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by onActivationRaw when idetifying he deselected item</span>

<span class="sd">        Reinit things (rubberband, disconnect signals)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reinit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;layerqgis&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">removeSelection</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># self.rubberBand = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># disconnection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectIdsGui</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.postOnDesactivation"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.postOnDesactivation">[docs]</a>    <span class="k">def</span> <span class="nf">postOnDesactivation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;!</span>
<span class="sd">        Abstract method - must be implemented</span>
<span class="sd">        called by onDesactivationRaw</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>




    <span class="k">def</span> <span class="nf">_checkLayerVisibility</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layerdisplayed</span><span class="p">:</span>
            <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">setActiveLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="o">.</span><span class="n">checkState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">layerdisplayed</span><span class="p">:</span>
            <span class="c1"># qgis.core.QgsMapLayerRegistry.instance().addMapLayer(self.dbasetable[&#39;layer&#39;],True)</span>
            <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">legendInterface</span><span class="p">()</span><span class="o">.</span><span class="n">setLayerVisible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># self.dbasetable[&#39;layer&#39;].setOpacity(1.0)</span>
            <span class="c1"># print(&#39;active&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layerdisplayed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetitem</span><span class="o">.</span><span class="n">checkState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">layerdisplayed</span><span class="p">:</span>
            <span class="c1"># qgis.core.QgsMapLayerRegistry.instance().removeMapLayer (self.dbasetable[&#39;layer&#39;])</span>
            <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">legendInterface</span><span class="p">()</span><span class="o">.</span><span class="n">setLayerVisible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># self.dbasetable[&#39;layer&#39;].setOpacity(0.0)</span>
            <span class="c1"># print(&#39;unactive&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layerdisplayed</span> <span class="o">=</span> <span class="kc">False</span>



<div class="viewcode-block" id="AbstractLamiaTool.loadChildFeatureinWidget"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.loadChildFeatureinWidget">[docs]</a>    <span class="k">def</span> <span class="nf">loadChildFeatureinWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by currentFeatureChanged emited by parent widget if it exists</span>
<span class="sd">        Call loadFeaturesinTreeWdg</span>
<span class="sd">        Manage behaviour of the widget</span>
<span class="sd">        emit currentFeatureChanged for child widgets</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadFeaturesinTreeWdg</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">itemText</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;TOOLNAME&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initFeatureProperties</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postInitFeatureProperties</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">itemText</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initFeatureProperties</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;End </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span><span class="n">starttime</span> <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">currentFeatureChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.loadFeaturesinTreeWdg"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.loadFeaturesinTreeWdg">[docs]</a>    <span class="k">def</span> <span class="nf">loadFeaturesinTreeWdg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load features in self.linkedtreewidget</span>
<span class="sd">        called whenever the list need to be reinitialized (ex : click in maintreewidget,...)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectIdsGui</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="p">)</span>

        <span class="c1"># clear treewidget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clearLinkedTreeWidget</span><span class="p">()</span>

        <span class="c1"># mise en forme du linkedtreewidget et definition du &quot;parentitem&quot; qui correspond au nom de la table</span>
        <span class="n">parentitem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headerlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetfields</span><span class="p">)</span>
            <span class="n">headerlist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ID&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">headerlist</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setHeaderItem</span><span class="p">(</span><span class="n">QTreeWidgetItem</span><span class="p">(</span><span class="n">headerlist</span><span class="p">))</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">header</span><span class="p">()</span>
            <span class="n">lenheaderlist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">headerlist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lenheaderlist</span><span class="p">):</span>
                    <span class="n">header</span><span class="o">.</span><span class="n">setResizeMode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="o">.</span><span class="n">ResizeToContents</span><span class="p">)</span>
                <span class="n">header</span><span class="o">.</span><span class="n">setResizeMode</span><span class="p">(</span><span class="n">lenheaderlist</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>
            <span class="k">elif</span>  <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lenheaderlist</span><span class="p">):</span>
                    <span class="n">header</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="o">.</span><span class="n">ResizeToContents</span><span class="p">)</span>
                <span class="n">header</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="n">lenheaderlist</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>

            <span class="n">parentitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span>
            <span class="n">indexchild</span> <span class="o">=</span> <span class="p">[</span><span class="n">root</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">childCount</span><span class="p">())]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">))</span>
            <span class="n">tempitem</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">indexchild</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                <span class="n">parentfeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="p">)</span>
                <span class="n">parentid</span> <span class="o">=</span> <span class="n">parentfeat</span><span class="p">[</span><span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">]</span>
                <span class="n">indexchild</span> <span class="o">=</span> <span class="p">[</span><span class="n">tempitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tempitem</span><span class="o">.</span><span class="n">childCount</span><span class="p">())]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">parentid</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indexchild</span> <span class="o">=</span> <span class="p">[</span><span class="n">tempitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tempitem</span><span class="o">.</span><span class="n">childCount</span><span class="p">())]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
            <span class="n">parentitem</span> <span class="o">=</span> <span class="n">tempitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">indexchild</span><span class="p">)</span>

        <span class="c1"># selection of particular feature to load (if parentfeature, or window only mode)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadIds</span><span class="p">()</span>


        <span class="c1"># creation de la liste des elements qui figurent dans le linkedtreewidget</span>
        <span class="n">lenqtreewidg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetfields</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">treefeatlist</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">QTreeWidgetItem</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unicode</span><span class="p">)</span> <span class="k">else</span> <span class="nb">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lenqtreewidg</span><span class="p">)])]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">treefeatlist</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">QTreeWidgetItem</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lenqtreewidg</span><span class="p">)])]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>

        <span class="c1"># ajout des ids dans le qtreewidgetitem parent</span>
        <span class="k">if</span> <span class="n">parentitem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parentqtreewdgitem</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">parentitem</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parentitem</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">childCount</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">parentitem</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">parentitem</span><span class="p">:</span>
                        <span class="n">parentitem</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">takeChildren</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">parentitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parentitem</span><span class="o">.</span><span class="n">childCount</span><span class="p">())]:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">parentitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parentitem</span><span class="o">.</span><span class="n">childCount</span><span class="p">())]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span>
                    <span class="n">parentitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">takeChildren</span><span class="p">()</span>
                    <span class="n">parentqtreewdgitem</span> <span class="o">=</span> <span class="n">parentitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parentqtreewdgitem</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">(</span><span class="n">parentitem</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parentqtreewdgitem</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">(</span><span class="n">parentitem</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">])</span>
                <span class="c1"># print(parentqtreewdgitem.text(0))</span>

            <span class="n">parentqtreewdgitem</span><span class="o">.</span><span class="n">addChildren</span><span class="p">([</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">treefeatlist</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;feat list </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">treefeatlist</span><span class="p">))</span>

        <span class="c1"># enable/disable le widget selon que des ids ont ete trouves</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">treefeatlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_geom</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">treefeatlist</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_geom</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initFeatureProperties</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end  </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.disconnectIdsGui"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.disconnectIdsGui">[docs]</a>    <span class="k">def</span> <span class="nf">disconnectIdsGui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disconnect self.featureSelected from main QTreeWidget and comboBox_featurelist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#self.linkedtreewidget.currentItemChanged.disconnect(self.featureSelected)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.connectIdsGui"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.connectIdsGui">[docs]</a>    <span class="k">def</span> <span class="nf">connectIdsGui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect self.featureSelected from main QTreeWidget and comboBox_featurelist</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="p">,</span> <span class="n">QTreeWidget</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_clearLinkedTreeWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear LinkedTreeWidget and linked combobox</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="p">,</span> <span class="n">QTreeWidget</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<div class="viewcode-block" id="AbstractLamiaTool.updateWorkingDate"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.updateWorkingDate">[docs]</a>    <span class="k">def</span> <span class="nf">updateWorkingDate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        No more used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subsetstring</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">subsetstring</span> <span class="o">=</span> <span class="s1">&#39;&quot;datetimecreation&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingdate</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;datetimedestruction&quot; IS NOT NULL  THEN &quot;datetimedestruction&quot; &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingdate</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE 1 END&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">subsetstring</span> <span class="o">=</span> <span class="s1">&#39;&quot;datetimecreation&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingdate</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;datetimedestruction&quot; IS NOT NULL  THEN &quot;datetimedestruction&quot; &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingdate</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE TRUE END&#39;</span>
        <span class="k">return</span> <span class="n">subsetstring</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.loadIds"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.loadIds">[docs]</a>    <span class="k">def</span> <span class="nf">loadIds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by loadFeaturesinTreeWdg</span>

<span class="sd">        :return: ids : an array of the wanted ids, with eventualy more value defined in self.qtreewidgetfields</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">strid</span> <span class="o">=</span> <span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="n">strid</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetfields</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetfields</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span>

            <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; WHERE &#39;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dateVersionConstraintSQL</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">linkagespeckey</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;desttable&#39;</span><span class="p">]:</span>
                        <span class="n">linkagespeckey</span> <span class="o">=</span> <span class="n">key</span>
                <span class="k">if</span> <span class="n">linkagespeckey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">linkagetemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span><span class="p">[</span><span class="n">linkagespeckey</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;tabletc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="c1">#linkagedest</span>
                        <span class="n">sqltemp</span> <span class="o">=</span> <span class="s2">&quot; SELECT &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;iddest&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>

                        <span class="n">linkagedest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqltemp</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">linkagedest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># print(&#39;None find&#39;)</span>
                            <span class="k">return</span> <span class="p">[]</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;idsource&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">linkagedest</span><span class="p">)</span>
                        <span class="c1">#TODO versionning</span>

                    <span class="k">elif</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;tabletc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;within&#39;</span><span class="p">:</span>
                        <span class="n">sqltemp</span> <span class="o">=</span> <span class="s2">&quot; SELECT &quot;</span><span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;iddest&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetfields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetfields</span><span class="p">)</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_now&quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; WHERE ST_WITHIN(ST_MakeValid(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.geom) , &quot;</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot;ST_MakeValid(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_now.geom) )&quot;</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; AND pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                        <span class="n">sqltemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">updateQueryTableNow</span><span class="p">(</span><span class="n">sqltemp</span><span class="p">)</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="n">sqltemp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#get parent feature field for link</span>
                        <span class="n">sqltemp</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;iddest&#39;</span><span class="p">]</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqltemp</span><span class="p">)</span>
                        <span class="n">linkidparent</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                        <span class="n">sqltemp</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;idtcsource&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;tabletc&#39;</span><span class="p">]</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; WHERE &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;idtcdest&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span>
                        <span class="c1">#sqltemp += str(self.parentWidget.currentFeature[linkagetemp[&#39;iddest&#39;]])</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">linkidparent</span><span class="p">)</span>
                        <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_begin &lt;= &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                            <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; AND CASE WHEN lpk_revision_end IS NOT NULL THEN &quot;</span>
                            <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; lpk_revision_end &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                            <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; ELSE TRUE END &quot;</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                            <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; AND CASE WHEN lpk_revision_end IS NOT NULL THEN &quot;</span>
                            <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; lpk_revision_end &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                            <span class="n">sqltemp</span> <span class="o">+=</span> <span class="s2">&quot; ELSE 1 END&quot;</span>

                        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqltemp</span><span class="p">)</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                            <span class="n">idstemp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
                            <span class="n">idssql</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idstemp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span> <span class="o">+</span> <span class="n">linkagetemp</span><span class="p">[</span><span class="s1">&#39;idsource&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; IN &quot;</span> <span class="o">+</span> <span class="n">idssql</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">ids</span>

            <span class="n">sqlbeforepost</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postloadIds</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sql</span> <span class="o">==</span> <span class="n">sqlbeforepost</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">strid</span> <span class="o">=</span> <span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; ORDER BY &#39;</span> <span class="o">+</span> <span class="n">strid</span>

            <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">query</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
                <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ids</span> <span class="p">:</span>
                    <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="o">+</span><span class="p">[[]]</span>
                    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">row</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getConstraintTextFromRawValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">qtreewidgetfields</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                                                                <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])]</span>
                        <span class="k">else</span> <span class="p">:</span>
                            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
                        <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">res</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">):</span>
            <span class="c1"># print(&#39;load ids file&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#pathrecentproject = os.path.join(os.path.dirname(__file__), &#39;..&#39;, &#39;config&#39;, &#39;path.txt&#39;)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="c1"># ids = range(len(self.dbasefiledata))</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="p">))]</span>

        <span class="k">return</span> <span class="n">ids</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.postloadIds"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.postloadIds">[docs]</a>    <span class="k">def</span> <span class="nf">postloadIds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sqlin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable to modify the sql used to get ids</span>

<span class="sd">        :param sqlin: the normal sql generated by loadIds</span>

<span class="sd">        :return: the modified sql tu use in loadIds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sqlin</span></div>



    <span class="c1"># *******************************************************************************************************************</span>
    <span class="c1"># **********************************    core methods        *******************************************</span>
    <span class="c1"># ******************************************************************************************************************</span>

<div class="viewcode-block" id="AbstractLamiaTool.featureSelected"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.featureSelected">[docs]</a>    <span class="k">def</span> <span class="nf">featureSelected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">itemisid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Action when a feature is selected somewhere (Main QTreeWidget, ids-Combobox)</span>

<span class="sd">        :param item: a QTreeWidgetItem or a Combobox index</span>
<span class="sd">        :param itemisid: if True, item is an pk</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">currentItem</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;*******&#39;</span><span class="p">)</span>
        <span class="c1">#if debug : logging.getLogger(&quot;Lamia&quot;).debug(&#39;start sender : %s&#39;, self.sender(), self.sender().objectName())</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">itemisid</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">)</span> <span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start item.text : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>


        <span class="c1"># ************** init thing *********************************</span>
        <span class="c1"># remove selection in canvas</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">removeSelection</span><span class="p">()</span>
        <span class="c1"># init thing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectIdsGui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeature</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#case deep copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepCopyDisconnect</span><span class="p">()</span>

        <span class="c1"># remove new entry if exists</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">itemintree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">findItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MatchExactly</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MatchRecursive</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span><span class="o">.</span><span class="n">removeChild</span><span class="p">(</span><span class="n">itemintree</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># ************** get id selected and link treewidget and combobox *********************************</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># print(&#39;featsel&#39;,item.parent().text(0),self.dbasetablename)</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">:</span>    <span class="c1"># treewdgitem has no parent</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;item with parent as current widget&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">]:</span>   <span class="c1"># treewdgitem has parent : child item</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;item with parent as child widget&#39;</span><span class="p">)</span>
                <span class="c1"># self.currentFeature = savedcurrentFeature</span>
                <span class="n">childindex</span> <span class="o">=</span> <span class="p">[</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">tabWidget_childs</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">childindex</span><span class="p">)</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">childcomboindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">[</span><span class="n">childindex</span><span class="p">]</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">[</span><span class="n">childindex</span><span class="p">]</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">childcomboindex</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;generic child widget selected&#39;</span><span class="p">)</span>
                <span class="c1"># self.currentFeature = savedcurrentFeature</span>
                <span class="n">childindex</span> <span class="o">=</span> <span class="p">[</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">tabWidget_childs</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">childindex</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;no self.dbasetable&#39;</span><span class="p">)</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;no item.parent()&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>      <span class="c1"># item text is not an id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">itemisid</span><span class="p">:</span>        <span class="c1">#feature selected with combobox</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;come from combobox&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">itemText</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="p">,</span> <span class="n">QTreeWidget</span><span class="p">)</span> <span class="p">:</span>

                    <span class="n">parentitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">findItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MatchExactly</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MatchRecursive</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">indexchild</span> <span class="o">=</span> <span class="p">[</span><span class="n">parentitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parentitem</span><span class="o">.</span><span class="n">childCount</span><span class="p">())]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
                    <span class="n">itemtodisplay</span> <span class="o">=</span> <span class="n">parentitem</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">indexchild</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setCurrentItem</span><span class="p">(</span><span class="n">itemtodisplay</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemisid</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">itemisid</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemisid</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1">#new feature</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>



        <span class="c1"># **************** gui things when selected ***************************************************************</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>        <span class="c1"># item clicked in treewidget</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastidselected</span> <span class="o">=</span> <span class="nb">id</span>
                <span class="c1"># print(&#39;self.lastidselected&#39;, self.dbasetablename, self.lastidselected)</span>
                <span class="c1">#print(&#39;ok&#39;, self.dbasetable[&#39;fields&#39;].keys())</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPkFromId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>

                <span class="c1"># print(&#39;id&#39;, id, pk,self.currentFeaturePK)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipleselection</span> <span class="p">:</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">()]</span>
                        <span class="n">pks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureById</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">selectByIds</span><span class="p">(</span><span class="n">pks</span><span class="p">)</span>
                        <span class="c1"># print(&#39;***&#39;, ids, pk)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">selectByIds</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_linkage</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>                       <span class="c1"># new item</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="p">,</span> <span class="n">QTreeWidget</span><span class="p">):</span>
                    <span class="n">itemtemp</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">addTopLevelItems</span><span class="p">([</span><span class="n">itemtemp</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setCurrentItem</span><span class="p">(</span><span class="n">itemtemp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_geom</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_linkage</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">):</span> <span class="c1">#widget has file linked</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># item clicked in treewidget</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
                    <span class="c1"># self.currentFeaturePK =</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># new item</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="p">,</span> <span class="n">QTreeWidget</span><span class="p">):</span>
                    <span class="n">itemtemp</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">addTopLevelItems</span><span class="p">([</span><span class="n">itemtemp</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setCurrentItem</span><span class="p">(</span><span class="n">itemtemp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newentrytext</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_properties</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_geom</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># init raw table with attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postInitFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">)</span>

        <span class="c1"># signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentFeatureChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectIdsGui</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.createParentFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.createParentFeature">[docs]</a>    <span class="k">def</span> <span class="nf">createParentFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new line in Objet table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pkobjet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createNewObjet</span><span class="p">()</span></div>




<div class="viewcode-block" id="AbstractLamiaTool.initFeatureProperties"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.initFeatureProperties">[docs]</a>    <span class="k">def</span> <span class="nf">initFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">inputtablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fieldname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by featureSelected</span>
<span class="sd">        Fill the fields in the widget</span>

<span class="sd">        :param feat: the selected  QgsFeature - if None it s a new feature</span>
<span class="sd">        :param inputtablename:  To init a specific table with specific field and a specific value</span>
<span class="sd">        :param fieldname:  specific field</span>
<span class="sd">        :param value:  specific value</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">templinkuserwgd</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">templinkuserwgd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span>

            <span class="k">if</span> <span class="n">inputtablename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tablestoiterate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tablestoiterate</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputtablename</span><span class="p">]</span>

            <span class="c1">#Then get values</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tablestoiterate</span><span class="p">:</span>
                <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="p">[</span><span class="n">tablename</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">feat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fieldname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fieldstoiterate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fieldstoiterate</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fieldstoiterate</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s2">&quot;_qgis &quot;</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fieldname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fieldstoiterate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicttablefieldtoinit</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fieldstoiterate</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fieldstoiterate</span><span class="p">):</span>
                    <span class="c1"># raw table</span>
                    <span class="k">if</span> <span class="n">feat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">valuetoset</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">valuetoset</span> <span class="o">=</span> <span class="n">value</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">isAttributeNull</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">):</span>
                        <span class="n">valuetoset</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">tablename</span> <span class="ow">in</span> <span class="n">templinkuserwgd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                <span class="ow">and</span> <span class="n">templinkuserwgd</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="ow">and</span> <span class="s1">&#39;widgets&#39;</span> <span class="ow">in</span> <span class="n">templinkuserwgd</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                <span class="ow">and</span> <span class="n">field</span> <span class="ow">in</span>  <span class="n">templinkuserwgd</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">templinkuserwgd</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">setValueInWidget</span><span class="p">(</span><span class="n">templinkuserwgd</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">valuetoset</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">setValueInWidget</span><span class="p">(</span><span class="n">templinkuserwgd</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">],</span> <span class="n">valuetoset</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span><span class="n">field</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                        <span class="n">listfieldname</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())]</span>
                        <span class="n">itemindex</span> <span class="o">=</span> <span class="n">listfieldname</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">field</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">itemindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">setValueInWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">itemindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">valuetoset</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">itemindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">valuetoset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">itemindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">itemindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">))</span>

        <span class="c1">#lidchoosers</span>
        <span class="k">for</span> <span class="n">lidchooser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamiawidgets</span><span class="p">:</span>
            <span class="n">lidchooser</span><span class="o">.</span><span class="n">initProperties</span><span class="p">()</span>

        <span class="c1"># current prestation case:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_savefeature</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">feat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;Marche&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkagespec</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">currentprestationid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># search table with lk prestation</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">218</span><span class="p">:</span>
                <span class="n">isspatial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isspatial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isSpatial</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">isspatial</span><span class="p">:</span>
                <span class="c1"># if self.dbasetable[&#39;layerview&#39;].isSpatial():</span>
                <span class="c1"># lk_presta = self.dbasetable[&#39;layerview&#39;].getFeatures(qgis.core.QgsFeatureRequest(feat.id())).next()[&#39;lk_marche&#39;]</span>
                <span class="n">lk_presta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureById</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">feat</span><span class="o">.</span><span class="n">id</span><span class="p">())[</span><span class="s1">&#39;lk_marche&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">listfeat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">())</span>
                <span class="n">featid</span> <span class="o">=</span> <span class="p">[</span><span class="n">fet</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="k">for</span> <span class="n">fet</span> <span class="ow">in</span> <span class="n">listfeat</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">featid</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
                <span class="n">lk_presta</span> <span class="o">=</span> <span class="n">listfeat</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;lk_marche&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lk_presta</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">currentprestationid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_savefeature</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.setValueInWidget"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.setValueInWidget">[docs]</a>    <span class="k">def</span> <span class="nf">setValueInWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wdg</span><span class="p">,</span> <span class="n">valuetoset</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by initFeatureProperties when iterating the fields</span>

<span class="sd">        :param wdg:         the widget to set a value to</span>
<span class="sd">        :param valuetoset:  the value</span>
<span class="sd">        :param table:       the table of the value</span>
<span class="sd">        :param field:       the field of the value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QTextEdit</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">valuetoset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QSpinBox</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDoubleSpinBox</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valuetoset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;error </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span><span class="n">field</span> <span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valuetoset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getConstraintTextFromRawValue</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">valuetoset</span><span class="p">)</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;error </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">field</span> <span class="p">,</span>  <span class="n">e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDateEdit</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">valuetoset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setDateTime</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QDateTime</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">))</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="p">):</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setDate</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setDate</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="s1">&#39;0001-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDateTimeEdit</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">valuetoset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setDateTime</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QDateTime</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd hh:mm:ss&#39;</span><span class="p">))</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="p">):</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setDate</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setDate</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="s1">&#39;0001-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">valuetoset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valuetoset</span><span class="p">:</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">valuetoset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getConstraintTextFromRawValue</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">valuetoset</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">valuetoset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.saveFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.saveFeature">[docs]</a>    <span class="k">def</span> <span class="nf">saveFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pushbuttonsignal</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">showsavemessage</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Action when save feature is clicked</span>

<span class="sd">        1. Create feat and save properties. Manage versioning:</span>

<span class="sd">                new version : save old version(just revision_end) -&gt; create new and copy old feat to new -&gt; save properties</span>

<span class="sd">                new : createnew and save properties</span>

<span class="sd">                existing : save properties</span>

<span class="sd">        2. reload treewidget and widget with new feat properties</span>


<span class="sd">        :param pushbuttonsignal: to catch a button signal</span>
<span class="sd">        :param showsavemessage:  show save message in qgis interface</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># *************************</span>
        <span class="c1"># save previous feature</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span>
            <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeature</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeaturePK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeature</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeaturePK</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># *************************</span>
        <span class="c1"># set geometry first - if geometry false or error :  return and noing is created/modified</span>
        <span class="c1"># create self.currentFeature if newfeature case (with only geometry info)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">editfeatureworking</span><span class="p">:</span>
            <span class="c1">#tempgeom = self.windowdialog.editfeaturelayer.selectedFeatures()[0].geometry()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">closeEditFeature</span><span class="p">(</span><span class="n">savechanges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">geometryisvalid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setGeometryToFeature</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">geometryisvalid</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># manage version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manageFeatureCreationOrUpdate</span><span class="p">()</span>

            <span class="c1">#get feature of dbasetablename saved (only geom saved)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveQGisFeature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>


            <span class="c1"># if debug: logging.getLogger(&quot;Lamia&quot;).debug(&#39;saveQGisFeature done with geom  : %s&#39;,self.currentFeature.geometry().exportToWkt())</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;time  </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

            <span class="c1"># *************************</span>
            <span class="c1"># save attributes</span>
            <span class="c1"># first assure that parent features are created</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createParentFeature</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeatureVersion</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createParentFeature</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updateParentFeature</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;createParentFeature ok&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;time  </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">saveFeatureProperties</span><span class="p">()</span>

            <span class="c1"># then save properly ressource file if exists</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;Ressource&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saveRessourceFile</span><span class="p">()</span>

            <span class="c1"># do postsavefeature traitment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manageGeomOfLinkedFeat</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postSaveFeature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;postSaveFeature done&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;time  </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

            <span class="c1"># update datemodification</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;Objet&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getParentTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">):</span>
                <span class="c1">#get pk_objet</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT pk_objet FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis &quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                <span class="n">pkobjet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">datemodif</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Objet SET datetimemodification = &#39;&quot;</span> <span class="o">+</span> <span class="n">datemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;  WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkobjet</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>



            <span class="c1"># then reload with saved attributes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeatureVersion</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loadFeaturesinTreeWdg</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;new feat loadFeaturesinTreeWdg  </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#get id</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT id_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                    <span class="n">newfeatureid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">indexnewfeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">newfeatureid</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">indexnewfeature</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">indexnewfeature</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">postInitFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">showsavemessage</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">normalMessage</span><span class="p">(</span><span class="s1">&#39;Objet sauvegarde : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">attributes</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;wait for repaint  </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggerRepaint</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end time  </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

            <span class="c1"># *************************</span>
            <span class="c1"># reinit things</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeatureVersion</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># self.currentFeatureChanged.emit()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggerRepaint</span><span class="p">()</span>


        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">]:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="p">)]</span> <span class="o">+</span> <span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">currentFeatureid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="p">[</span><span class="n">currentFeatureid</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">values</span>

            <span class="n">filedbase</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="p">):</span>
                <span class="n">filedbase</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasefiledata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">filedbase</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># then reload with saved attributes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loadFeaturesinTreeWdg</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">postInitFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">showsavemessage</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">normalMessage</span><span class="p">(</span><span class="s1">&#39;Objet sauvegarde : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentFeatureChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.manageFeatureCreationOrUpdate"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.manageFeatureCreationOrUpdate">[docs]</a>    <span class="k">def</span> <span class="nf">manageFeatureCreationOrUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by saveFeature - Manage versioning</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">currentFeature</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT lpk_revision_begin FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">featlastrevision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">featlastrevision</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLatestVersion</span><span class="p">():</span>   <span class="c1">#new version feature</span>
                <span class="c1"># assign revisionend to old version feature</span>
                <span class="k">if</span> <span class="s1">&#39;Objet&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getParentTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">):</span>
                    <span class="c1">#getpkobjet</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_objet FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                    <span class="n">pk_objet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">datemodif</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>

                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Objet SET lpk_revision_end = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; , datetimemodification = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datemodif</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pk_objet</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                    <span class="c1"># create new feat from oldfeat</span>
                    <span class="n">currentFeature</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">fields</span><span class="p">())</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">currentFeature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
                    <span class="c1"># currentFeature[&#39;pk_&#39; + self.dbasetablename.lower()] = 0</span>
                    <span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeatureVersion</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>       <span class="c1">#simple feature update</span>
                <span class="n">currentFeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span>
                <span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>           <span class="c1"># feature creation</span>
            <span class="n">currentFeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span>
            <span class="n">currentFeaturePK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">currentFeature</span><span class="p">,</span> <span class="n">currentFeaturePK</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.manageGeomOfLinkedFeat"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.manageGeomOfLinkedFeat">[docs]</a>    <span class="k">def</span> <span class="nf">manageGeomOfLinkedFeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage linked geom between parent table and chidl table</span>
<span class="sd">        linkage eom is defined by self.linkedgeom variable</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedgeom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tablename</span><span class="p">,</span><span class="n">linkedfield</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedgeom</span><span class="p">:</span>

                <span class="n">sourcevalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span>
                                                         <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="n">linkedfield</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;, id_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s2">&quot;_qgis &quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE &quot;</span> <span class="o">+</span> <span class="n">linkedfield</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sourcevalue</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dateVersionConstraintSQL</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                <span class="c1"># for fetid in result:</span>
                <span class="k">for</span> <span class="n">fetpk</span><span class="p">,</span> <span class="n">fetid</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">sourcegeomtext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span>
                                                             <span class="p">[</span><span class="s1">&#39;ST_AsText(geom)&#39;</span><span class="p">],</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                    <span class="n">targetgeomtext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span>
                                                               <span class="p">[</span><span class="s1">&#39;ST_AsText(geom)&#39;</span><span class="p">],</span>
                                                                <span class="n">fetpk</span><span class="p">)</span>
                    <span class="n">sourceqgsgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromWkt</span><span class="p">(</span><span class="n">sourcegeomtext</span><span class="p">)</span>
                    <span class="n">targetqgsgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromWkt</span><span class="p">(</span><span class="n">targetgeomtext</span><span class="p">)</span>

                    <span class="c1">#test if nexw geom needed</span>
                    <span class="n">targetgeomtext</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sourceval</span> <span class="o">=</span> <span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">targetqgsgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">targetval</span> <span class="o">=</span> <span class="n">targetqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()</span>
                            <span class="n">targetgeomtext</span> <span class="o">=</span> <span class="n">sourcegeomtext</span>
                        <span class="k">elif</span> <span class="n">targetqgsgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">targetval</span> <span class="o">=</span> <span class="n">targetqgsgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                                <span class="n">newgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolyline</span><span class="p">([</span><span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
                                <span class="n">targetgeomtext</span> <span class="o">=</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">exportToWkt</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">newgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolylineXY</span><span class="p">([</span><span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
                                <span class="n">targetgeomtext</span> <span class="o">=</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">asWkt</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">sourceval</span> <span class="o">=</span> <span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">targetqgsgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">targetval</span> <span class="o">=</span> <span class="n">targetqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                                <span class="n">newgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolyline</span><span class="p">([</span><span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
                                <span class="n">targetgeomtext</span> <span class="o">=</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">exportToWkt</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">newgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolylineXY</span><span class="p">([</span><span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="n">sourceqgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
                                <span class="n">targetgeomtext</span> <span class="o">=</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">asWkt</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">targetqgsgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">targetval</span> <span class="o">=</span> <span class="n">targetqgsgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">targetgeomtext</span> <span class="o">=</span> <span class="n">sourcegeomtext</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">areNodesEquals</span><span class="p">(</span><span class="n">sourceval</span><span class="p">,</span> <span class="n">targetval</span><span class="p">)</span> <span class="ow">and</span> <span class="n">targetgeomtext</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createNewLineVersion</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">fetpk</span><span class="p">)</span>
                        <span class="n">desfeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureById</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">fetid</span><span class="p">)</span>
                        <span class="c1">#newgeom</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span>
                                                                <span class="n">tablename</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span>
                                                                <span class="n">listoffields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">],</span>
                                                                <span class="n">listofrawvalues</span><span class="o">=</span><span class="p">[</span><span class="n">targetgeomtext</span><span class="p">])</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">desfeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">manageLinkedDesorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkeddisorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeatureVersion</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># categorie</span>
                <span class="c1"># sql = &quot;SELECT Categorie FROM Equipement WHERE pk_equipement = &quot; + str(self.currentFeaturePK)</span>
                <span class="n">categ</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkeddisorder</span><span class="p">[</span><span class="s1">&#39;specificfield&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkeddisorder</span><span class="p">[</span><span class="s1">&#39;specificfield&#39;</span><span class="p">]</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                    <span class="n">categ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># print(&#39;categ&#39;, categ)</span>
                <span class="c1"># if categ == &#39;OUH&#39;:</span>
                <span class="k">if</span> <span class="n">categ</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkeddisorder</span><span class="p">[</span><span class="s1">&#39;specificfieldvalue&#39;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="n">pkobjet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createNewObjet</span><span class="p">()</span>
                    <span class="n">lastiddesordre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLastId</span><span class="p">(</span><span class="s1">&#39;Desordre&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">geomtext</span><span class="p">,</span> <span class="n">iddessys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span>
                                                                    <span class="p">[</span><span class="s1">&#39;ST_AsText(geom)&#39;</span><span class="p">,</span> <span class="s1">&#39;id_descriptionsystem&#39;</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;POINT&#39;</span><span class="p">:</span>
                        <span class="n">qgsgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromWkt</span><span class="p">(</span><span class="n">geomtext</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                            <span class="n">newgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolyline</span><span class="p">([</span><span class="n">qgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="n">qgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
                            <span class="n">geomtext</span> <span class="o">=</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">exportToWkt</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">newgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolylineXY</span><span class="p">([</span><span class="n">qgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="n">qgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
                            <span class="n">geomtext</span> <span class="o">=</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">asWkt</span><span class="p">()</span>

                    <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;INSERT&#39;</span><span class="p">,</span>
                                                            <span class="n">tablename</span><span class="o">=</span><span class="s1">&#39;Desordre&#39;</span><span class="p">,</span>
                                                            <span class="n">listoffields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id_desordre&#39;</span><span class="p">,</span> <span class="s1">&#39;lpk_objet&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;groupedesordre&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;lid_descriptionsystem&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">],</span>
                                                            <span class="n">listofrawvalues</span><span class="o">=</span><span class="p">[</span><span class="n">lastiddesordre</span><span class="p">,</span> <span class="n">pkobjet</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">linkeddisorder</span><span class="p">[</span><span class="s1">&#39;groupedesordre&#39;</span><span class="p">],</span>
                                                                             <span class="n">iddessys</span><span class="p">,</span> <span class="n">geomtext</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>


            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># move related desordre</span>
                <span class="n">categ</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkeddisorder</span><span class="p">[</span><span class="s1">&#39;specificfield&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">categ</span><span class="p">,</span> <span class="n">iddessys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span>
                                                                 <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">linkeddisorder</span><span class="p">[</span><span class="s1">&#39;specificfield&#39;</span><span class="p">],</span> <span class="s1">&#39;id_descriptionsystem&#39;</span><span class="p">],</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">iddessys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span>
                                                                 <span class="p">[</span> <span class="s1">&#39;id_descriptionsystem&#39;</span><span class="p">],</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">categ</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkeddisorder</span><span class="p">[</span><span class="s1">&#39;specificfieldvalue&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">iddessys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT id_desordre FROM Desordre_qgis WHERE lid_descriptionsystem = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iddessys</span><span class="p">)</span>
                    <span class="n">sqlres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sqlres</span><span class="p">:</span>
                        <span class="n">iddes</span> <span class="o">=</span> <span class="n">sqlres</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">desfeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureById</span><span class="p">(</span><span class="s1">&#39;Desordre&#39;</span><span class="p">,</span> <span class="n">iddes</span><span class="p">)</span>
                        <span class="c1"># revibegin</span>
                        <span class="n">desgeomtext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="s1">&#39;Desordre_qgis&#39;</span><span class="p">,</span>
                                                                 <span class="p">[</span><span class="s1">&#39;ST_AsText(geom)&#39;</span><span class="p">],</span>
                                                                 <span class="n">desfeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
                        <span class="n">equipgeomtext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span>
                                                                   <span class="p">[</span><span class="s1">&#39;ST_AsText(geom)&#39;</span><span class="p">],</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;POINT&#39;</span><span class="p">:</span>
                            <span class="n">qgsgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromWkt</span><span class="p">(</span><span class="n">equipgeomtext</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                                <span class="n">newgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolyline</span><span class="p">([</span><span class="n">qgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="n">qgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
                                <span class="n">equipgeomtext</span> <span class="o">=</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">exportToWkt</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># newgeom = qgis.core.QgsGeometry.fromPolylineXY([qgsgeom.asPointXY(), qgsgeom.asPointXY()])</span>
                                <span class="n">newgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolylineXY</span><span class="p">([</span><span class="n">qgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="n">qgsgeom</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
                                <span class="n">equipgeomtext</span> <span class="o">=</span> <span class="n">newgeom</span><span class="o">.</span><span class="n">asWkt</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">equipgeomtext</span> <span class="o">!=</span> <span class="n">desgeomtext</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createNewLineVersion</span><span class="p">(</span><span class="s1">&#39;Desordre&#39;</span><span class="p">,</span> <span class="n">desfeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
                            <span class="n">desfeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureById</span><span class="p">(</span><span class="s1">&#39;Desordre&#39;</span><span class="p">,</span> <span class="n">iddes</span><span class="p">)</span>

                            <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span>
                                                                    <span class="n">tablename</span><span class="o">=</span><span class="s1">&#39;Desordre&#39;</span><span class="p">,</span>
                                                                    <span class="n">listoffields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">],</span>
                                                                    <span class="n">listofrawvalues</span><span class="o">=</span><span class="p">[</span><span class="n">equipgeomtext</span><span class="p">])</span>
                            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_desordre = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">desfeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>





<div class="viewcode-block" id="AbstractLamiaTool.setGeometryToFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.setGeometryToFeature">[docs]</a>    <span class="k">def</span> <span class="nf">setGeometryToFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methode pour assigner le self.tempgeometry au self.currenfeature</span>
<span class="sd">        cree le self.currenfeature si besoin</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># geometry conversion first</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POINT&#39;</span><span class="p">,</span> <span class="s1">&#39;LINESTRING&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON&#39;</span><span class="p">]</span>
                 <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">isMultipart</span><span class="p">()):</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">convertToSingleType</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MULTIPOLYGON&#39;</span><span class="p">]</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">isMultipart</span><span class="p">()):</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">convertToMultiType</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LINESTRING&#39;</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># case point in linestring layer</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolyline</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolylineXY</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()])</span>

        <span class="c1">#remove duplicate from linestring</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;LINESTRING&#39;</span><span class="p">]</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">geomaspoly</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()</span>
                    <span class="n">geomfinal</span> <span class="o">=</span> <span class="p">[</span><span class="n">geomaspoly</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">areNodesEquals</span><span class="p">(</span><span class="n">geomaspoly</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geomaspoly</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geomaspoly</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">areNodesEquals</span><span class="p">(</span><span class="n">geomaspoly</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">geomaspoly</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">):</span>
                                <span class="n">geomfinal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomaspoly</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolylineXY</span><span class="p">(</span><span class="n">geomfinal</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">())</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="p">)</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    if (&#39;geom&#39; in self.dbasetable.keys()  </span>
<span class="sd">                            and (self.groupBox_geom.parent() is not None or self.groupBox_geom.isVisible()</span>
<span class="sd">                                or self.frame_editing.isVisible())):</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_editing</span><span class="o">.</span><span class="n">isVisible</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_geom</span><span class="o">.</span><span class="n">isVisible</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupBox_geom</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="p">)</span>
                            <span class="ow">and</span> <span class="p">((</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;CHECKGEOM&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECKGEOM</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;CHECKGEOM&#39;</span><span class="p">))):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">errorMessage</span><span class="p">(</span><span class="s1">&#39;Pas de geometrie selectionnee !!&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">savingnewfeature</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="p">)</span>
                    <span class="k">pass</span>
        
        
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.updateParentFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.updateParentFeature">[docs]</a>    <span class="k">def</span> <span class="nf">updateParentFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by saveFeature</span>
<span class="sd">        Update the parent tables and manage versioning</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1">#setlastid</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT id_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeaturePK</span><span class="p">)</span>
        <span class="n">lastid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; UPDATE &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; SET id_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lastid</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getParentTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;  FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeaturePK</span><span class="p">)</span>
            <span class="n">pkoldtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;  FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
            <span class="n">pknewtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkoldtable</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">fieldslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getColumns</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="c1">#update sql</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="o">+</span> <span class="s2">&quot; SET &quot;</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fieldslist</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;pk_&#39;</span> <span class="ow">in</span> <span class="n">field</span> <span class="ow">or</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">field</span> <span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">resulttemp</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="p">],</span> <span class="n">unicode</span><span class="p">):</span>
                    <span class="n">resulttemp</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="k">elif</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">resulttemp</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># print(type(result[i+1]))</span>
                    <span class="n">resulttemp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="p">])</span>

                <span class="n">sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="n">resulttemp</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">#remove last ,</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pknewtable</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s1">&#39;Objet&#39;</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Objet SET lpk_revision_begin = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; lpk_revision_end = NULL WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pknewtable</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.saveQGisFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.saveQGisFeature">[docs]</a>    <span class="k">def</span> <span class="nf">saveQGisFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">feat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by saveFeature</span>

<span class="sd">        Save the edited QgsFeature</span>

<span class="sd">        :param table: the edited table</span>
<span class="sd">        :param feat:  the edited QgsFeature</span>
<span class="sd">        :return:    the saved QgsFeature with geometry</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">dbasetablelayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start : </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                                                   <span class="n">table</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">id</span><span class="p">())</span> <span class="p">,</span> <span class="n">feat</span><span class="o">.</span><span class="n">attributes</span><span class="p">(),</span> <span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>

        <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># new feature</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">updateFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addedFeatureid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">raiseError</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">errorMessage</span><span class="p">)</span>
        <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">featureAdded</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getFeatureAddedId</span><span class="p">)</span>
        <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
        <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">rollBack</span><span class="p">()</span>
        <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">raiseError</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">errorMessage</span><span class="p">)</span>
        <span class="n">dbasetablelayer</span><span class="o">.</span><span class="n">featureAdded</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getFeatureAddedId</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;table, feat.id addedfeatureid : </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">id</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addedFeatureid</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">addedFeatureid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">addedFeatureid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">feat</span><span class="o">.</span><span class="n">id</span><span class="p">())</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.saveFeatureProperties"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.saveFeatureProperties">[docs]</a>    <span class="k">def</span> <span class="nf">saveFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by saveFeature</span>

<span class="sd">        Method for saving feature properties of the ui in the tables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
                    <span class="n">featpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span>
                    <span class="n">fieldnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">:</span>
                        <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValueFromWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">],</span>
                                                                   <span class="n">tablename</span><span class="p">,</span>
                                                                   <span class="n">fieldname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fieldvaluetosave</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldvaluetosave</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="c1">#tablepk</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;  WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                    <span class="n">tablepk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># update sql</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; SET &quot;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fieldnames</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unicode</span><span class="p">)</span> <span class="p">:</span>
                            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                <span class="n">resultstring</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="k">if</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">resultstring</span><span class="p">:</span>
                                    <span class="n">resultstring</span> <span class="o">=</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resultstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">))</span>
                                <span class="n">resulttemp</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">resultstring</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">resulttemp</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
                        <span class="k">elif</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">resulttemp</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># print(type(result[i ]))</span>
                            <span class="n">resulttemp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="p">])</span>

                        <span class="n">sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="n">resulttemp</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>

                    <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># remove last ,</span>

                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablepk</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="c1"># lidchoosers</span>
            <span class="k">for</span> <span class="n">lidchooser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamiawidgets</span><span class="p">:</span>
                <span class="n">lidchooser</span><span class="o">.</span><span class="n">saveProperties</span><span class="p">()</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">templinkuserwgd</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;linkfield&#39;</span><span class="p">:</span> <span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;widgets&#39;</span><span class="p">:</span> <span class="p">{}}}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">templinkuserwgd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span>

            <span class="n">listfieldname</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">templinkuserwgd</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">itemindex</span> <span class="o">=</span> <span class="n">listfieldname</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">field</span><span class="p">)</span>
                    <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValueFromWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableWidget</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">itemindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                               <span class="n">tablename</span><span class="p">,</span>
                                                               <span class="n">field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fieldvaluetosave</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldvaluetosave</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                <span class="c1">#tablepk</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;  WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                <span class="n">tablepk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># update sql</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; SET &quot;</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pk_&#39;</span><span class="p">,</span> <span class="s1">&#39;id_&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lpk_&#39;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">resulttemp</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">resulttemp</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unicode</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">resulttemp</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">resulttemp</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
                    <span class="k">elif</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">resulttemp</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resulttemp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="n">resulttemp</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>

                <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># remove last ,</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablepk</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.postSaveFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.postSaveFeature">[docs]</a>    <span class="k">def</span> <span class="nf">postSaveFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolnewfeature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by saveFeature</span>

<span class="sd">        To be overloaded if special actions have to be done after raw savin of the feature</span>

<span class="sd">        :param boolnewfeature: if it s a new feature</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.getValueFromWidget"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.getValueFromWidget">[docs]</a>    <span class="k">def</span> <span class="nf">getValueFromWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wdg</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to obtain the savable value of a property widget</span>

<span class="sd">        :param wdg: the property widget</span>
<span class="sd">        :param tablename: the table name  linked with th widget</span>
<span class="sd">        :param fieldname: the field name  linked with th widget</span>
<span class="sd">        :return: The value of the widget, in good format for saving</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">wdg</span> <span class="o">=</span> <span class="n">wdg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getConstraintRawValueFromText</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">wdg</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error getValueFromWidget&#39;</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fieldvaluetosave</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">wdg</span> <span class="o">=</span> <span class="n">wdg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QSpinBox</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wdg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">wdg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDoubleSpinBox</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wdg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wdg</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QTextEdit</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QTextBrowser</span><span class="p">):</span>
                <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">):</span>
                <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDateEdit</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wdg</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QLineEdit</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
                <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDateTimeEdit</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wdg</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QLineEdit</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
                <span class="n">fieldvaluetosave</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">dateTime</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span> <span class="s1">&#39;yyyy-MM-dd hh:mm:ss&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fieldvaluetosave</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.deleteFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.deleteFeature">[docs]</a>    <span class="k">def</span> <span class="nf">deleteFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signalreceiver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showmessage</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by cliking on Save Button</span>

<span class="sd">        :param signalreceiver: the signal emited by the button</span>
<span class="sd">        :param showmessage: show a confirmation dialog or not</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">showmessage</span> <span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Supprimer completement l&#39;element (yes) ou l&#39;archiver (no) ? &quot;</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Su&quot;</span><span class="p">,</span>
                                               <span class="n">message</span><span class="p">,</span>
                                               <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Cancel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span>

        <span class="c1"># current version</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT lpk_revision_begin, pk_objet FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
        <span class="n">lpkrevbegin</span><span class="p">,</span> <span class="n">pkobjet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lpkrevbegin</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleteParentFeature</span><span class="p">():</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM  &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">errorMessage</span><span class="p">(</span><span class="s2">&quot;pas encore disponible&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datesuppr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Objet SET lpk_revision_end = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; , datetimedestruction = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datesuppr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; , datetimemodification = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datesuppr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkobjet</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">reply</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_objet FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
            <span class="n">pkobjet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">datesuppr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Objet SET datetimedestruction = &#39;&quot;</span> <span class="o">+</span> <span class="n">datesuppr</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;  , datetimemodification = &#39;&quot;</span> <span class="o">+</span> <span class="n">datesuppr</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkobjet</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadChildFeatureinWidget</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.deleteParentFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.deleteParentFeature">[docs]</a>    <span class="k">def</span> <span class="nf">deleteParentFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by deleteFeature</span>

<span class="sd">        To be overloaded if the parents tables need deleting also</span>

<span class="sd">        :return: True if method is overloaded, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.getFeatureAddedId"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.getFeatureAddedId">[docs]</a>    <span class="k">def</span> <span class="nf">getFeatureAddedId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple method to catch he id of the fresh saved qgsfeature</span>

<span class="sd">        :param id: the id send by qgis signal</span>
<span class="sd">        :return: the QgsFeature id</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addedFeatureid</span> <span class="o">=</span> <span class="nb">id</span></div>

<div class="viewcode-block" id="AbstractLamiaTool.deselectFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.deselectFeature">[docs]</a>    <span class="k">def</span> <span class="nf">deselectFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by deselect Button</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">closeEditFeature</span><span class="p">()</span>
        <span class="c1">#case deepcopy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepCopyDisconnect</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastidselected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentWidget</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastidselected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">idwidgetindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastidselected</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">idwidgetindex</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.addFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.addFeature">[docs]</a>    <span class="k">def</span> <span class="nf">addFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by add Feature Button</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.addGPSPoint"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.addGPSPoint">[docs]</a>    <span class="k">def</span> <span class="nf">addGPSPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by add GPS Point Button</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">currentpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">windowdialog</span><span class="o">.</span><span class="n">errorMessage</span><span class="p">(</span><span class="s1">&#39;GPS non connecte&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createorresetRubberband</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">layerpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">currentpoint</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>       <span class="c1"># POINT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setTempGeometry</span><span class="p">([</span><span class="n">layerpoint</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>      <span class="c1"># LINE</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># print(self.currentFeature.geometry())</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>
                <span class="n">geompoly</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()</span>
                <span class="n">geompoly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layerpoint</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setTempGeometry</span><span class="p">(</span><span class="n">geompoly</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setTempGeometry</span><span class="p">([</span><span class="n">layerpoint</span><span class="p">,</span><span class="n">layerpoint</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">geompoly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asMultiPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">geompoly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">geompoly</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">del</span> <span class="n">geompoly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">geompoly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layerpoint</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setTempGeometry</span><span class="p">(</span><span class="n">geompoly</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span></div>




<div class="viewcode-block" id="AbstractLamiaTool.addPoint"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.addPoint">[docs]</a>    <span class="k">def</span> <span class="nf">addPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called by Add Point Button</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createorresetRubberband</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>      <span class="c1"># LINE</span>
            <span class="c1"># get the geometry before editing</span>
            <span class="n">initialgeom</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">initialgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">initialgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asMultiPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">isMultipart</span> <span class="p">()</span> <span class="p">:</span>
                        <span class="n">initialgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">initialgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asMultiPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initialgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()</span>

            <span class="n">mapgeometry</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">initialgeom</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span> <span class="p">:</span> <span class="c1">#bug for standalone</span>
                    <span class="n">mapgeometry</span> <span class="o">=</span> <span class="n">initialgeom</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mapgeometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">xform</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">captureGeometry</span><span class="p">(</span><span class="n">listpointinitialgeometry</span><span class="o">=</span><span class="n">mapgeometry</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.captureGeometry"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.captureGeometry">[docs]</a>    <span class="k">def</span> <span class="nf">captureGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">connectint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">listpointinitialgeometry</span><span class="o">=</span><span class="p">[],</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called when capturing geometry is needed (add/extent point, line, polygon...)</span>
<span class="sd">        Launch the capture tool</span>

<span class="sd">        :param connectint: Catching widget signal</span>
<span class="sd">        :param listpointinitialgeometry: list of geometry to be extended, if new empty list</span>
<span class="sd">        :param type: geom type (point, line, polygone)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;pushButton_rajoutPoint&#39;</span><span class="p">:</span>
            <span class="n">listpointinitialgeometry</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Point&#39;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">objectName</span><span class="p">():</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="s1">&#39;Line&#39;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">objectName</span><span class="p">():</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="s1">&#39;Polygon&#39;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">objectName</span><span class="p">():</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createorresetRubberband</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsWkbTypes</span><span class="o">.</span><span class="n">PointGeometry</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpoint</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsWkbTypes</span><span class="o">.</span><span class="n">LineGeometry</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtoolline</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsWkbTypes</span><span class="o">.</span><span class="n">PolygonGeometry</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpolygon</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QGis</span><span class="o">.</span><span class="n">Point</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpoint</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QGis</span><span class="o">.</span><span class="n">Line</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtoolline</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QGis</span><span class="o">.</span><span class="n">Polygon</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpolygon</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapTool</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">setMapTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span><span class="o">.</span><span class="n">stopCapture</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setTempGeometry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span><span class="o">.</span><span class="n">mappoints</span> <span class="o">=</span> <span class="n">listpointinitialgeometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span><span class="o">.</span><span class="n">startCapturing</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.createorresetRubberband"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.createorresetRubberband">[docs]</a>    <span class="k">def</span> <span class="nf">createorresetRubberband</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the rubberband</span>

<span class="sd">        :param type: geom type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsRubberBand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span><span class="nb">type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">setWidth</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;magenta&quot;</span><span class="p">))</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.setTempGeometry"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.setTempGeometry">[docs]</a>    <span class="k">def</span> <span class="nf">setTempGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">comefromcanvas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showinrubberband</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when self.currentmaptool has finished capturing</span>

<span class="sd">        Assign the geometry to self.tempgeometry</span>

<span class="sd">        :param points: the list of points coming from the currentmaptool</span>
<span class="sd">        :param comefromcanvas: True if come from canvas (need od reprojection)</span>
<span class="sd">        :param showinrubberband: True if the temp geometry will be visible with the rubberband</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start points : </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span><span class="o">.</span><span class="n">stopCapture</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setTempGeometry</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">pointsmapcanvas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pointslayer</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capturetype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capturetype</span>

        <span class="c1"># case point in line layer</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1">#self.rubberBand.reset(0)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createorresetRubberband</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LINESTRING&#39;</span><span class="p">:</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createorresetRubberband</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createorresetRubberband</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span> <span class="c1">#for stadalone app bug</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                <span class="n">pointsmapcanvas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">xform</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>
            <span class="n">pointslayer</span> <span class="o">=</span> <span class="n">points</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comefromcanvas</span><span class="p">:</span>
                <span class="n">pointsmapcanvas</span> <span class="o">=</span> <span class="n">points</span>
                <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                    <span class="n">pointslayer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">xformreverse</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pointslayer</span> <span class="o">=</span> <span class="n">points</span>
                <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                    <span class="n">pointsmapcanvas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">xform</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">geometryformap</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">pointsmapcanvas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">geometryforlayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">pointslayer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">geometryformap</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">pointsmapcanvas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">geometryforlayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromMultiPolyline</span><span class="p">([</span><span class="n">pointslayer</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">geometryformap</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromMultiPolyline</span><span class="p">([</span><span class="n">pointsmapcanvas</span><span class="p">])</span>
                <span class="n">geometryforlayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromMultiPolyline</span><span class="p">([</span><span class="n">pointslayer</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">geometryformap</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolygon</span><span class="p">([</span><span class="n">pointsmapcanvas</span><span class="p">])</span>
                <span class="n">geometryforlayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolygon</span><span class="p">([</span><span class="n">pointslayer</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">geometryformap</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPointXY</span><span class="p">(</span><span class="n">pointsmapcanvas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">geometryforlayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPointXY</span><span class="p">(</span><span class="n">pointslayer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">geometryformap</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPointXY</span><span class="p">(</span><span class="n">pointsmapcanvas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">geometryforlayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromMultiPolylineXY</span><span class="p">([</span><span class="n">pointslayer</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">geometryformap</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromMultiPolylineXY</span><span class="p">([</span><span class="n">pointsmapcanvas</span><span class="p">])</span>
                <span class="n">geometryforlayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromMultiPolylineXY</span><span class="p">([</span><span class="n">pointslayer</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">geometryformap</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolygonXY</span><span class="p">([</span><span class="n">pointsmapcanvas</span><span class="p">])</span>
                <span class="n">geometryforlayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPolygonXY</span><span class="p">([</span><span class="n">pointslayer</span><span class="p">])</span>

        <span class="c1">#outside qgis bug</span>
        <span class="k">if</span> <span class="n">showinrubberband</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">addGeometry</span><span class="p">(</span><span class="n">geometryforlayer</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">addGeometry</span><span class="p">(</span><span class="n">geometryformap</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rubberBand</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="o">=</span> <span class="n">geometryforlayer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamiageomChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end layer points : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pointslayer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end canvas points : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pointsmapcanvas</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end tempgeom : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toWKT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mtool</span> <span class="o">=</span> <span class="kc">None</span></div>




<div class="viewcode-block" id="AbstractLamiaTool.pickFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.pickFeature">[docs]</a>    <span class="k">def</span> <span class="nf">pickFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by button of pro interface for picking a feature</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">setMapTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.selectPickedFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.selectPickedFeature">[docs]</a>    <span class="k">def</span> <span class="nf">selectPickedFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">button</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method of pro interface</span>

<span class="sd">        :param point:</span>
<span class="sd">        :param button:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickfield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">nearestid</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">layernearist</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">layername</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickTable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pickfield</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">nearid</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getNearestId</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">layernearist</span> <span class="o">=</span> <span class="n">layername</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="n">nearestid</span> <span class="o">=</span> <span class="n">nearid</span>
                <span class="k">elif</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
                    <span class="n">layernearist</span> <span class="o">=</span> <span class="n">layername</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="n">nearestid</span> <span class="o">=</span> <span class="n">nearid</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layernearist</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span>
            <span class="n">idtoget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickTable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pickfield</span><span class="p">][</span><span class="n">layernearist</span><span class="p">]</span>
            <span class="c1"># nearestfeature = layer.getFeatures(qgis.core.QgsFeatureRequest(nearestid)).next()</span>
            <span class="n">nearestfeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureById</span><span class="p">(</span><span class="n">layernearist</span><span class="p">,</span> <span class="n">nearestid</span><span class="p">)</span>
            <span class="n">nearattributevalue</span> <span class="o">=</span> <span class="n">nearestfeature</span><span class="p">[</span><span class="n">idtoget</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">218</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">setSelectedFeatures</span><span class="p">([</span><span class="n">nearestfeature</span><span class="o">.</span><span class="n">id</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">selectByIds</span><span class="p">([</span><span class="n">nearestfeature</span><span class="o">.</span><span class="n">id</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initFeatureProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="p">,</span>
                                       <span class="n">tablename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>
                                       <span class="n">fieldname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pickfield</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="n">nearattributevalue</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickfield</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">unsetMapTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not used yet</span>
            <span class="n">nearestid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNearestId</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">218</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">setSelectedFeatures</span><span class="p">([</span><span class="n">nearestid</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">selectByIds</span><span class="p">([</span><span class="n">nearestid</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickspinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">nearestid</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">unsetMapTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">picklayername</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickspinbox</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.zoomToFeature"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.zoomToFeature">[docs]</a>    <span class="k">def</span> <span class="nf">zoomToFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by zoom to Button</span>

<span class="sd">        :param fid: the id of feature we want to zoom to</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">fid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPkFromId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span><span class="n">fid</span><span class="p">)</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span><span class="n">pk</span> <span class="p">)</span>
        <span class="c1"># point2 = xform.transform(feat.geometry().centroid().asPoint())</span>

        <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="n">point2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">xform</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span><span class="o">.</span><span class="n">asPoint</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print(feat.geometry().asWkt())</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">point2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">xform</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">vertexAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">point2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">xform</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsPointXY</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">vertexAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
                <span class="c1"># print(&#39;**&#39;, point2)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">setCenter</span><span class="p">(</span><span class="n">point2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.saveRessourceFile"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.saveRessourceFile">[docs]</a>    <span class="k">def</span> <span class="nf">saveRessourceFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by saveFeature</span>
<span class="sd">        If ressource file is not in the dbase directory, save it in the dbase directory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get date</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT datetimecreation FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># date = result[0]</span>
            <span class="n">datevalue</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="c1"># print(result[0], datevalue, type(result[0]), isinstance(datevalue, datetime.date))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datevalue</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
                <span class="n">datevalue</span> <span class="o">=</span> <span class="n">datevalue</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datevalue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_ressource, id_ressource, file FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pkressource</span><span class="p">,</span> <span class="n">idressource</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPyNullVariant</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idressource</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">filename</span>
                    <span class="n">destinationdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span><span class="n">date</span><span class="p">)</span>
                    <span class="n">destinationfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destinationdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">copyRessourceFile</span><span class="p">(</span><span class="n">fromfile</span><span class="o">=</span> <span class="n">file</span><span class="p">,</span>
                                                   <span class="n">tofile</span><span class="o">=</span><span class="n">destinationfile</span><span class="p">,</span>
                                                   <span class="n">withthumbnail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">copywholedirforraster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


                    <span class="n">finalname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">destinationfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span> <span class="p">))</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Ressource SET file = &#39;&quot;</span> <span class="o">+</span> <span class="n">finalname</span> <span class="o">+</span> <span class="s2">&quot;&#39; WHERE pk_ressource = &quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">pkressource</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beforesavingFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT file FROM Ressource  WHERE pk_ressource = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkressource</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
                        <span class="n">oldfile</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">oldfile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                    <span class="n">newfile</span> <span class="o">=</span> <span class="n">finalname</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">completePathOfFile</span><span class="p">(</span><span class="n">oldfile</span><span class="p">))</span> <span class="ow">and</span> <span class="n">oldfile</span> <span class="o">!=</span> <span class="n">newfile</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">completePathOfFile</span><span class="p">(</span><span class="n">oldfile</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span></div>




<div class="viewcode-block" id="AbstractLamiaTool.showImageinLabelWidget"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.showImageinLabelWidget">[docs]</a>    <span class="k">def</span> <span class="nf">showImageinLabelWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wdg</span><span class="p">,</span><span class="n">savedfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the image file in the text widget</span>
<span class="sd">        Manage thumbnail image</span>

<span class="sd">        :param wdg: the text widget</span>
<span class="sd">        :param savedfile: the image file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filetoshow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">completePathOfFile</span><span class="p">(</span><span class="n">savedfile</span><span class="p">)</span>
        <span class="n">possiblethumbnail</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filetoshow</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">possiblethumbnail</span> <span class="o">+</span> <span class="s2">&quot;_thumbnail.png&quot;</span><span class="p">):</span>
            <span class="n">filetoshow</span> <span class="o">=</span> <span class="n">possiblethumbnail</span> <span class="o">+</span> <span class="s2">&quot;_thumbnail.png&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filetoshow</span><span class="p">):</span>
            <span class="n">wdg</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">wdg</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">filetoshow</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wdg</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Image non trouvee&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.copyAtributes"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.copyAtributes">[docs]</a>    <span class="k">def</span> <span class="nf">copyAtributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy he atributes of the ui in self.templinkuserwdg</span>

<span class="sd">        :return: self.templinkuserwdg</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span><span class="p">[</span><span class="n">wdg</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QSpinBox</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDoubleSpinBox</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span><span class="p">[</span><span class="n">wdg</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QTextEdit</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QTextBrowser</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span><span class="p">[</span><span class="n">wdg</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span><span class="p">[</span><span class="n">wdg</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">)</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span><span class="p">[</span><span class="n">wdg</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDateEdit</span><span class="p">)</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span><span class="p">[</span><span class="n">wdg</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDateTimeEdit</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span><span class="p">[</span><span class="n">wdg</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">dateTime</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.pasteAtributes"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.pasteAtributes">[docs]</a>    <span class="k">def</span> <span class="nf">pasteAtributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signalclick</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dicttopaste</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Paste atributes saved in self.templinkuserwdg</span>

<span class="sd">        :param signalclick: catch emitter signal</span>
<span class="sd">        :param dicttopaste: the dictionnary to paste</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dicttopaste</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dicttopaste</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templinkuserwdg</span>
            
        
        <span class="k">if</span> <span class="n">dicttopaste</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkuserwdg</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widgets&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">):</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">dicttopaste</span><span class="p">[</span><span class="n">wdg</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QSpinBox</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDoubleSpinBox</span><span class="p">):</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">dicttopaste</span><span class="p">[</span><span class="n">wdg</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QTextEdit</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QTextBrowser</span><span class="p">):</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">dicttopaste</span><span class="p">[</span><span class="n">wdg</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">):</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">dicttopaste</span><span class="p">[</span><span class="n">wdg</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">dicttopaste</span><span class="p">[</span><span class="n">wdg</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDateEdit</span><span class="p">)</span> <span class="p">:</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">setDate</span><span class="p">(</span><span class="n">dicttopaste</span><span class="p">[</span><span class="n">wdg</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span> <span class="n">QDateTimeEdit</span><span class="p">):</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">setDateTime</span><span class="p">(</span><span class="n">dicttopaste</span><span class="p">[</span><span class="n">wdg</span><span class="p">])</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.goToFeaturePressed"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.goToFeaturePressed">[docs]</a>    <span class="k">def</span> <span class="nf">goToFeaturePressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called on gotofeature Button pressed</span>
<span class="sd">        Show featue in rubberband</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zoomToFeature</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="n">selectedfeatureids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">selectedFeaturesIds</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selectedfeatureids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">selectedFeatureIds</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">in</span> <span class="n">selectedfeatureids</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">()</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeature</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">geom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">geom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span>
                    <span class="c1">#case when point stored in polyline</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                        <span class="n">geom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">geom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPointXY</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsRubberBand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span><span class="o">.</span><span class="n">setWidth</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;magenta&quot;</span><span class="p">))</span>
                <span class="n">success</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">xform</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span><span class="o">.</span><span class="n">addGeometry</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbstractLamiaTool.goToFeatureReleased"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.goToFeatureReleased">[docs]</a>    <span class="k">def</span> <span class="nf">goToFeatureReleased</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called on gotofeature Button released</span>
<span class="sd">        Reset ruberband</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rubberBandBlink</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.displayGPS"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.displayGPS">[docs]</a>    <span class="k">def</span> <span class="nf">displayGPS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called on GPs connection</span>
<span class="sd">        Print GPS things in widgets defined by self.gpswidget</span>

<span class="sd">        :param active: True ig a NMEA sentence is received in less than 5 s, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">ggasentence</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayGGA</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">gstsentence</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayGST</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_rajoutPointGPS</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_rajoutPointGPS</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">ggasentence</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayGGA</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">gstsentence</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayGST</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.displayGGA"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.displayGGA">[docs]</a>    <span class="k">def</span> <span class="nf">displayGGA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictgga</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by displayGPS</span>

<span class="sd">        :param dictgga: the dict where widgets to display gga are defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;gga&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dictgga</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;gga&#39;</span><span class="p">]]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">dictgga</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;gga&#39;</span><span class="p">]],</span> <span class="mi">2</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.displayGST"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.displayGST">[docs]</a>    <span class="k">def</span> <span class="nf">displayGST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictgst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by displayGPS</span>

<span class="sd">        :param dictgst: the dict where widgets to display gst are defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;gst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dictgst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;gst&#39;</span><span class="p">]]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">dictgst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;gst&#39;</span><span class="p">]],</span><span class="mi">2</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpswidget</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="AbstractLamiaTool.getPkFromId"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.getPkFromId">[docs]</a>    <span class="k">def</span> <span class="nf">getPkFromId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layername</span><span class="p">,</span> <span class="n">inputid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to get pk of feature by id</span>

<span class="sd">        :param layername:</span>
<span class="sd">        :param inputid:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis &quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;WHERE id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">inputid</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dateVersionConstraintSQL</span><span class="p">()</span>

        <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pk</span></div>


    <span class="k">def</span> <span class="nf">getDBaseChildWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keywidget</span><span class="p">):</span>
        <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">[</span><span class="n">keywidget</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">wdg</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wdg</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">[</span><span class="n">keywidget</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wdg</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wdg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wdg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="AbstractLamiaTool.themechanged"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.themechanged">[docs]</a>    <span class="k">def</span> <span class="nf">themechanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iconwidth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change icon width - activated by windowswidget</span>

<span class="sd">        :param iconwidth: the icon width we want</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iconwidth</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">newsize</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="n">iconwidth</span><span class="p">,</span> <span class="n">iconwidth</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iconwidth</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">):</span>
            <span class="n">newsize</span> <span class="o">=</span> <span class="n">iconwidth</span>
        <span class="n">newsizeicon</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
        <span class="n">newsizeicon</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">newsize</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">newsize</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>

        <span class="n">butttons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findChildren</span><span class="p">(</span><span class="n">QPushButton</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">butttons</span><span class="p">:</span>
            <span class="c1"># print(&#39;button&#39;, button.icon())</span>
            <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">icon</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">newsizeicon</span><span class="p">)</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setBaseSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
        <span class="n">butttons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findChildren</span><span class="p">(</span><span class="n">QToolButton</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">butttons</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">icon</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">newsizeicon</span><span class="p">)</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setBaseSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">:</span>
            <span class="n">wdg</span><span class="o">.</span><span class="n">themechanged</span><span class="p">(</span><span class="n">iconwidth</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractLamiaTool.toWKT"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.toWKT">[docs]</a>    <span class="k">def</span> <span class="nf">toWKT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convenient method working for qgis 2 and 3</span>

<span class="sd">        :param geom: the QgsGeometry</span>
<span class="sd">        :return: the wkt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">returnstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="n">returnstr</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">exportToWkt</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">returnstr</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">asWkt</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">returnstr</span></div>

<div class="viewcode-block" id="AbstractLamiaTool.deepCopy"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.deepCopy">[docs]</a>    <span class="k">def</span> <span class="nf">deepCopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by deep copy Button</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySave</span><span class="p">()</span>

        <span class="n">tempsender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">tempsender</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_deepcopy</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deepCopyLoad</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">tempsender</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_deepcopyselect</span> <span class="p">:</span>
            <span class="n">currentpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capturetype</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">captureGeometry</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lamiageomChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepcopymultipleselection</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.deepcopymultipleselection"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.deepcopymultipleselection">[docs]</a>    <span class="k">def</span> <span class="nf">deepcopymultipleselection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by deepCopy</span>

<span class="sd">        copy to multiple objects</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lamiageomChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepcopymultipleselection</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capturetype</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="n">geomtext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">exportToWkt</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geomtext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span><span class="o">.</span><span class="n">asWkt</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">currentid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span><span class="p">)</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT id_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE ST_WITHIN(ST_MakeValid(geom), ST_GeomFromText(&#39;&quot;</span> <span class="o">+</span> <span class="n">geomtext</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;))&quot;</span>
        <span class="n">ressql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ressql</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ressql</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">feat_id</span> <span class="ow">in</span> <span class="n">res</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">feat_id</span> <span class="o">!=</span> <span class="n">currentid</span> <span class="p">:</span>
                    <span class="n">idselected</span> <span class="o">=</span> <span class="n">feat_id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deepCopyLoad</span><span class="p">(</span><span class="n">parentIdtocopyinto</span><span class="o">=</span><span class="n">idselected</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createorresetRubberband</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">currentid</span><span class="p">,</span> <span class="n">itemisid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggerRepaint</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractLamiaTool.deepCopySave"><a class="viewcode-back" href="../../../API.html#Lamia.toolabstract.Lamia_abstract_tool.AbstractLamiaTool.deepCopySave">[docs]</a>    <span class="k">def</span> <span class="nf">deepCopySave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signalclik</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">deepcopydict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">parentwidg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save properties of the copied feature</span>


<span class="sd">        :param signalclik: catch emitter signal</span>
<span class="sd">        :param table:</span>
<span class="sd">        :param deepcopydict:</span>
<span class="sd">        :param parentwidg:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**** deepCopy ****&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span><span class="n">deepcopydict</span><span class="p">,</span><span class="n">parentwidg</span>  <span class="p">)</span>

        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;childs&#39;</span><span class="p">:</span> <span class="p">{}}]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentFeaturePK</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyAtributes</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySave</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">,</span> <span class="n">deepcopydict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;childs&#39;</span><span class="p">],</span><span class="n">parentwidg</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>


        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">elemlist</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySave</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">elemlist</span><span class="p">,</span> <span class="n">deepcopydict</span><span class="o">=</span><span class="n">deepcopydict</span><span class="p">,</span> <span class="n">parentwidg</span><span class="o">=</span><span class="n">parentwidg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">currentable</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">tempwdg</span> <span class="ow">in</span> <span class="n">parentwidg</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tempwdg</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">==</span> <span class="n">currentable</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tempwdg</span><span class="o">.</span><span class="n">treefeatlist</span><span class="p">]</span>
                    <span class="n">deepcopydict</span><span class="p">[</span><span class="n">currentable</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[]</span>
                    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                        <span class="n">tempwdg</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">itemisid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">deepcopydict</span><span class="p">[</span><span class="n">currentable</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;childs&#39;</span><span class="p">:</span> <span class="p">{}})</span>
                        <span class="n">deepcopydict</span><span class="p">[</span><span class="n">currentable</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempwdg</span><span class="o">.</span><span class="n">copyAtributes</span><span class="p">()</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySave</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">deepcopydict</span><span class="o">=</span><span class="n">deepcopydict</span><span class="p">[</span><span class="n">currentable</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;childs&#39;</span><span class="p">],</span><span class="n">parentwidg</span><span class="o">=</span><span class="n">tempwdg</span><span class="p">)</span>




        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">deepCopyLoad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deepcopydict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parentwdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">parentIdtocopyinto</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">debugsavedelete</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">deepcopydict</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deepCopyLoad&#39;</span><span class="p">,</span> <span class="n">deepcopydict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">parentwdg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deepCopyLoad&#39;</span><span class="p">,</span> <span class="n">deepcopydict</span><span class="p">,</span> <span class="n">parentwdg</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">deepcopydict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">parentIdtocopyinto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">deepcopydict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deepcopydict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">parentIdtocopyinto</span><span class="p">,</span> <span class="n">itemisid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">attributes</span> <span class="o">=</span> <span class="n">deepcopydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pasteAtributes</span><span class="p">(</span><span class="n">dicttopaste</span><span class="o">=</span><span class="n">attributes</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepcopydict</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;childs&#39;</span> <span class="ow">in</span> <span class="n">deepcopydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dicttosend</span> <span class="o">=</span> <span class="n">deepcopydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;childs&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dicttosend</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parentIdtocopyinto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No geom&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">captureGeometry</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span><span class="o">.</span><span class="n">stopCapture</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySaveFeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dicttosend</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">debugsavedelete</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;capture&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="s1">&#39;dictnone&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;geom&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySaveFeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dicttosend</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">deepcopydict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">tempwdg</span> <span class="ow">in</span> <span class="n">parentwdg</span><span class="o">.</span><span class="n">dbasechildwdg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tempwdg</span><span class="o">.</span><span class="n">dbasetablename</span> <span class="o">==</span> <span class="n">tablename</span><span class="p">:</span>
                        <span class="n">originaltreefeatlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tempwdg</span><span class="o">.</span><span class="n">treefeatlist</span><span class="p">)</span>
                        <span class="n">lastcount</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deepcopydict</span><span class="p">[</span><span class="n">tablename</span><span class="p">]):</span>
                            <span class="n">lastcount</span> <span class="o">=</span> <span class="n">i</span>
                            <span class="k">if</span> <span class="s1">&#39;childs&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">dicttosend</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;childs&#39;</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dicttosend</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="n">attributes</span> <span class="o">=</span> <span class="n">deepcopydict</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span>

                            <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">originaltreefeatlist</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;geom already&#39;</span><span class="p">)</span>
                                <span class="n">tempwdg</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">(</span> <span class="n">item</span><span class="o">=</span><span class="n">originaltreefeatlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">itemisid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">tempwdg</span><span class="o">.</span><span class="n">pasteAtributes</span><span class="p">(</span><span class="n">dicttopaste</span><span class="o">=</span><span class="n">attributes</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">debugsavedelete</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ecrase&#39;</span><span class="p">,</span> <span class="n">tempwdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">originaltreefeatlist</span><span class="p">)</span> <span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySaveFeat</span><span class="p">(</span><span class="n">tempwdg</span><span class="p">,</span> <span class="n">dicttosend</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tempwdg</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">()</span>
                                <span class="n">tempwdg</span><span class="o">.</span><span class="n">pasteAtributes</span><span class="p">(</span><span class="n">dicttopaste</span><span class="o">=</span><span class="n">attributes</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">debugsavedelete</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cree&#39;</span><span class="p">,</span> <span class="n">tempwdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">originaltreefeatlist</span><span class="p">))</span>

                                <span class="k">if</span> <span class="n">tempwdg</span><span class="o">.</span><span class="n">tempgeometry</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="n">tablename</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No geom&#39;</span><span class="p">)</span>
                                    <span class="n">tempwdg</span><span class="o">.</span><span class="n">captureGeometry</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="n">tempwdg</span><span class="o">.</span><span class="n">currentmaptool</span><span class="o">.</span><span class="n">stopCapture</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySaveFeat</span><span class="p">(</span><span class="n">tempwdg</span><span class="p">,</span> <span class="n">dicttosend</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;geom already&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">deepCopySaveFeat</span><span class="p">(</span><span class="n">tempwdg</span><span class="p">,</span> <span class="n">dicttosend</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">lastcount</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">originaltreefeatlist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">parentIdtocopyinto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lastcount</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">originaltreefeatlist</span><span class="p">))):</span>
                                <span class="k">if</span> <span class="n">debugsavedelete</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">tempwdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
                                                                   <span class="nb">len</span><span class="p">(</span><span class="n">originaltreefeatlist</span><span class="p">),</span>
                                                                   <span class="n">originaltreefeatlist</span><span class="p">,</span>
                                                                   <span class="n">originaltreefeatlist</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">tempwdg</span><span class="o">.</span><span class="n">featureSelected</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">originaltreefeatlist</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">itemisid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                                <span class="n">tempwdg</span><span class="o">.</span><span class="n">deleteFeature</span><span class="p">(</span><span class="n">showmessage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>





    <span class="k">def</span> <span class="nf">deepCopySaveFeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">currentwdg</span><span class="p">,</span> <span class="n">deepcopydict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">currentwdg</span><span class="o">.</span><span class="n">stopCapture</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># print(&#39;save&#39;, currentwdg.dbasetablename, currentwdg.tempgeometry)</span>

        <span class="k">if</span> <span class="n">currentwdg</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">currentwdg</span><span class="o">.</span><span class="n">saveFeature</span><span class="p">(</span><span class="n">showsavemessage</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">currentwdg</span><span class="o">.</span><span class="n">saveFeature</span><span class="p">(</span><span class="n">showsavemessage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deepcopydict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deepcopydict</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deepCopyLoad</span><span class="p">(</span><span class="n">deepcopydict</span><span class="o">=</span><span class="n">deepcopydict</span><span class="p">,</span> <span class="n">parentwdg</span><span class="o">=</span><span class="n">currentwdg</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">deepCopyDisconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentmaptool</span><span class="o">.</span><span class="n">stopCapture</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">printWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">tr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;AbstractLamiaTool&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Artelia

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>