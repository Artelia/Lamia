

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lamia.dialog.InspectionDigue_windowwidget &mdash; Documentation LAMIA 1.0</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> LAMIA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../D_marche_g_n_rale__license.html">Démarche générale, license</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tutoriel.html">Tutoriel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developpement.html">Developpement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">LAMIA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Code du module</a> &raquo;</li>
        
      <li>Lamia.dialog.InspectionDigue_windowwidget</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Code source de Lamia.dialog.InspectionDigue_windowwidget</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file is part of LAMIA.</span>

<span class="sd">    LAMIA is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    LAMIA is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with Foobar.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  * Copyright (c) 2017-2020 ARTELIA Commit &lt;lamia@arteliagroup.com&gt;</span>
<span class="sd">  * </span>
<span class="sd">  * SPDX-License-Identifier: GPL-3.0-or-later</span>
<span class="sd">  * License-Filename: LICENSING.md</span>
<span class="sd"> &quot;&quot;&quot;</span>




<span class="c1"># qgis pyqt import</span>
<span class="kn">from</span> <span class="nn">qgis.PyQt</span> <span class="k">import</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">uic</span><span class="p">,</span> <span class="n">QtCore</span>
<span class="kn">from</span> <span class="nn">unicodedata</span> <span class="k">import</span> <span class="n">normalize</span>
<span class="kn">from</span> <span class="nn">qgis.PyQt.QtCore</span> <span class="k">import</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">QCoreApplication</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">qgis.PyQt.QtGui</span> <span class="k">import</span> <span class="p">(</span><span class="n">QDockWidget</span><span class="p">,</span> <span class="n">QMainWindow</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QInputDialog</span><span class="p">,</span>
                                 <span class="n">QComboBox</span><span class="p">,</span><span class="n">QTableWidgetItem</span><span class="p">,</span><span class="n">QProgressBar</span><span class="p">,</span><span class="n">QApplication</span><span class="p">,</span><span class="n">QToolBar</span><span class="p">,</span>
                                 <span class="n">QPushButton</span><span class="p">,</span><span class="n">QToolButton</span><span class="p">,</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QAction</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">qgis.PyQt.QtWidgets</span> <span class="k">import</span> <span class="p">(</span><span class="n">QDockWidget</span><span class="p">,</span> <span class="n">QMainWindow</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QInputDialog</span><span class="p">,</span>
                                     <span class="n">QComboBox</span><span class="p">,</span><span class="n">QTableWidgetItem</span><span class="p">,</span> <span class="n">QProgressBar</span><span class="p">,</span><span class="n">QApplication</span><span class="p">,</span><span class="n">QToolBar</span><span class="p">,</span>
                                     <span class="n">QPushButton</span><span class="p">,</span><span class="n">QToolButton</span><span class="p">,</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QAction</span><span class="p">)</span>

<span class="c1"># other libs import</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">qgis</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> :: </span><span class="si">%(levelname)s</span><span class="s1"> :: </span><span class="si">%(module)s</span><span class="s1"> :: </span><span class="si">%(funcName)s</span><span class="s1"> :: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<span class="n">stream_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stream_handler</span><span class="p">)</span>

<span class="n">debugtime</span> <span class="o">=</span> <span class="kc">False</span>


<span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">importlib</span><span class="o">,</span> <span class="nn">inspect</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyspatialite</span> <span class="k">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">db</span>
    <span class="kn">from</span> <span class="nn">pyspatialite.dbapi2</span> <span class="k">import</span> <span class="o">*</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sqlite3</span>
    <span class="kn">from</span> <span class="nn">sqlite3</span> <span class="k">import</span> <span class="o">*</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;spatialite not enabled&#39;</span><span class="p">)</span>


<span class="c1"># plugin import</span>
<span class="kn">from</span> <span class="nn">..main.DBaseParser</span> <span class="k">import</span> <span class="n">DBaseParser</span>
<span class="kn">from</span> <span class="nn">.InspectionDigue_Connexion_PG</span> <span class="k">import</span> <span class="n">ConnexionPGDialog</span>
<span class="kn">from</span> <span class="nn">.InspectionDigue_ConflitHorsLigne</span> <span class="k">import</span> <span class="n">ConflitHorsLigne</span>
<span class="c1"># from .InspectionDigue_impression_rapport import ImpressionRapportDialog</span>
<span class="c1"># from .InspectionDigue_exportShapefile import ExportShapefileDialog</span>
<span class="c1">#from .InspectionDigue_Import import ImportObjetDialog</span>
<span class="kn">from</span> <span class="nn">.Lamia_numpad</span> <span class="k">import</span> <span class="n">NumPadDialog</span>
<span class="kn">from</span> <span class="nn">.Lamia_iconsize</span> <span class="k">import</span> <span class="n">IconSizeDialog</span>

<span class="kn">from</span> <span class="nn">.InspectionDigue_newDB</span> <span class="k">import</span> <span class="n">newDBDialog</span>
<span class="kn">from</span> <span class="nn">.InspectionDigue_getDate</span> <span class="k">import</span> <span class="n">getDateDialog</span>
<span class="kn">from</span> <span class="nn">.lamia_tablefield_dialog</span> <span class="k">import</span> <span class="n">LamiaTableFieldDialog</span>

<span class="c1"># from ..toolgeneral.InspectionDigue_rapport import printPDFWorker</span>
<span class="c1"># from ..toolgeneral.InspectionDigue_exportshp import exportShapefileWorker</span>
<span class="c1"># from ..toolgeneral.InspectionDigue_import import ImportObjectWorker</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">from ..toolgeneral.SIRS_to_LAMIA.FDtL import *</span>
<span class="sd">from ..toolgeneral.LAMIA_to_SIRS.LtFD import *</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">..gps.GPSutil</span> <span class="k">import</span> <span class="n">GpsUtil</span>
<span class="kn">from</span> <span class="nn">..maptool.mapTools</span> <span class="k">import</span> <span class="n">mapToolCapture</span><span class="p">,</span> <span class="n">mapToolEdit</span>


<div class="viewcode-block" id="InspectiondigueWindowWidget"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget">[docs]</a><span class="k">class</span> <span class="nc">InspectiondigueWindowWidget</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the main window widget</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">closingPlugin</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">dockwgt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        :param canvas : current qgsmapcanvas</span>
<span class="sd">        :param parent : pyqt widget parent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InspectiondigueWindowWidget</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>



        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;InspectionDigue_windowwidget_base.ui&#39;</span><span class="p">)</span>
            <span class="n">uic</span><span class="o">.</span><span class="n">loadUi</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># ***************************************************************</span>
        <span class="c1"># ******************   Variables def ****************************</span>
        <span class="c1"># ***************************************************************</span>
        <span class="c1"># current the qgsmapcanvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas</span>
        <span class="c1"># list containing the tools widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list containing the menu tools classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menutools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># the pick maptool</span>
        <span class="c1"># self.pointEmitter = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolEmitPoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
        <span class="c1"># The DBase parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">importexportdbase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The GPS util</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span> <span class="o">=</span> <span class="n">GpsUtil</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">hauteurperche</span> <span class="o">=</span> <span class="mf">2.0</span>    <span class="c1">#defaultvalue</span>
        <span class="c1"># The main qfiledialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="p">()</span>
        <span class="c1"># the working date dialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span> <span class="o">=</span> <span class="n">getDateDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># the new db dialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newDBDialog</span> <span class="o">=</span> <span class="n">newDBDialog</span><span class="p">()</span>
        <span class="c1">#numpad dialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numpaddialog</span> <span class="o">=</span> <span class="n">NumPadDialog</span><span class="p">()</span>
        <span class="c1"># the postgis connection dialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connDialog</span> <span class="o">=</span> <span class="n">ConnexionPGDialog</span><span class="p">()</span>
        <span class="c1">#table/field dialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablefielddialog</span> <span class="o">=</span> <span class="n">LamiaTableFieldDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="p">)</span>
        <span class="c1">#iconsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iconsizedialog</span> <span class="o">=</span> <span class="n">IconSizeDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># for printing reports</span>
        <span class="c1">#self.printrapportdialog = ImpressionRapportDialog()</span>
        <span class="c1"># self.exportshapefiledialog = ExportShapefileDialog()</span>
        <span class="c1"># self.importobjetdialog =ImportObjetDialog()</span>
        <span class="c1">#qgis legend node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#ui classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uifields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uidesktop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uipostpro</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuclasses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desktopuiloaded</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crsselector</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsGenericProjectionSelector</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crsselector</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsProjectionSelectionDialog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dockwgt</span> <span class="o">=</span> <span class="n">dockwgt</span>

        <span class="c1"># the qgis editing maptool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cadwdg</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsAdvancedDigitizingDockWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpoint</span> <span class="o">=</span> <span class="n">mapToolCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadwdg</span><span class="p">,</span>
                                             <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolAdvancedDigitizing</span><span class="o">.</span><span class="n">CapturePoint</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtoolline</span> <span class="o">=</span> <span class="n">mapToolCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadwdg</span><span class="p">,</span>
                                            <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolAdvancedDigitizing</span><span class="o">.</span><span class="n">CaptureLine</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpolygon</span> <span class="o">=</span> <span class="n">mapToolCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadwdg</span><span class="p">,</span>
                                               <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolAdvancedDigitizing</span><span class="o">.</span><span class="n">CapturePolygon</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpoint</span> <span class="o">=</span> <span class="n">mapToolCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadwdg</span><span class="p">,</span>
                                             <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolCapture</span><span class="o">.</span><span class="n">CapturePoint</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtoolline</span> <span class="o">=</span> <span class="n">mapToolCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadwdg</span><span class="p">,</span>
                                            <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolCapture</span><span class="o">.</span><span class="n">CaptureLine</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtoolpolygon</span> <span class="o">=</span> <span class="n">mapToolCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cadwdg</span><span class="p">,</span>
                                               <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolCapture</span><span class="o">.</span><span class="n">CapturePolygon</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mtooledit</span> <span class="o">=</span> <span class="n">mapToolEdit</span><span class="p">(</span><span class="n">canvas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editfeatureworking</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">currentprestationlabel</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Prestation inactif&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentprestationlabel</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabel</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s1">&#39;GPS non connecté&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GPSlabel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s1">&#39;Précision&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step1&#39;</span><span class="p">)</span>

        <span class="c1"># ***************************************************************</span>
        <span class="c1"># ******************   Actions  ****************************</span>
        <span class="c1"># ***************************************************************</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">expandAll</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">currentItemChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closeEditFeature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionModeTerrain</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># ***************************************************************</span>
        <span class="c1"># ******************   Signals ****************************</span>
        <span class="c1"># ***************************************************************</span>




        <span class="c1"># QT signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionNouvelle_base</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newDbase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionSpatialite</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadSLDbase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionPostgis</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadPGDbase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionAide</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openHelp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionTables_et_champs</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openTableFieldDialog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBases_recentes</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openFileFromMenu</span><span class="p">)</span>
        <span class="c1"># self.actionExporter_base.triggered.connect(self.exportBase)</span>
        <span class="c1"># self.actionImprimer_rapport.triggered.connect(self.printRapport)</span>
        <span class="c1"># self.actionExport_shapefile.triggered.connect(self.exportShapefile)</span>
        <span class="c1">#self.actionImport.triggered.connect(self.importObjet)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionVersion</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setVersion</span><span class="p">)</span>
        <span class="c1">#self.actionExporter_vers_SIRS_Digues.triggered.connect(export_sirs)</span>
        <span class="c1">#self.actionImporter_depuis_SIRS_Digues.triggered.connect(import_sirs)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actionImporter_et_ajouter_la_base</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importDBase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionImporter_et_mettre_jour_la_base</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importDBase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionExporter_la_base</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exportDBase</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if self.dbase.dbasetype == &#39;postgis&#39;:</span>
<span class="sd">            self.actionMode_hors_ligne_Reconnexion.setEnabled(True)</span>
<span class="sd">        else:</span>
<span class="sd">            #self.actionMode_hors_ligne_Reconnexion.setEnabled(True)</span>
<span class="sd">            self.actionMode_hors_ligne_Reconnexion.setEnabled(True)</span>
<span class="sd">        self.actionMode_hors_ligne_Reconnexion.triggered.connect(self.modeHorsLigne)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#self.pushButton_zoomFeature.clicked.connect(self.zoomToFeature)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pushButton_selectfeat</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectFeature</span><span class="p">)</span>
        <span class="c1">#self.toolButton_edit.clicked.connect(self.editFeature)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_Repertoire_photo</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setImageDir</span><span class="p">)</span>
        <span class="c1">#self.actionDate_de_travail.triggered.connect(self.setWorkingDate)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolButton_date</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setWorkingDate</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actionModeExpert</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setVisualMode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actionTTC</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setVisualMode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actionModeTerrain</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setVisualMode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actionPosttraitement</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setVisualMode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actionReinitialier_prestation_courante</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reinitCurrentPrestation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actionHauteur_de_perche_GPS</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setHauteurPerche</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_taille_icone</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setLamiaIconSize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_GPSConnection</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connectToGPS</span><span class="p">)</span>
        <span class="c1"># other</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">GPSConnected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GPSconnected</span><span class="p">)</span>
        <span class="c1"># init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readRecentDBase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRecentDBaseMenu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter_2</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">80</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">createDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>

        <span class="c1">#clear all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setVisualMode</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desktopuiloaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uifields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uidesktop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uipostpro</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuclasses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menutools</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">layerTreeRoot</span><span class="p">()</span>
                <span class="c1">#root.addGroup(&#39;Lamia&#39;)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s2">&quot;spatialite&quot;</span><span class="p">:</span>
                    <span class="n">groupname</span> <span class="o">=</span> <span class="s1">&#39;Lamia_&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s2">&quot;postgis&quot;</span><span class="p">:</span>
                    <span class="n">groupname</span> <span class="o">=</span> <span class="s1">&#39;Lamia_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span>

                <span class="n">lamialegendgroup</span> <span class="o">=</span>  <span class="n">root</span><span class="o">.</span><span class="n">findGroup</span><span class="p">(</span><span class="n">groupname</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lamialegendgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lamialegendgroup</span><span class="o">.</span><span class="n">removeAllChildren</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cleanLayerTree</span><span class="p">()</span>


        <span class="c1"># DBase signals</span>
        <span class="c1"># self.dbase.recentDBaseChanged.connect(self.updateRecentDBaseMenu)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dBaseLoaded</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DBaseLoaded</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">errorMessage</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errorMessage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">normalMessage</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_readRecentDBase</span><span class="p">()</span>

        <span class="c1">#qgis signals</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">destinationCrsChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">updateQgsCoordinateTransformFromLayerToCanvas</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">crsChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">updateQgsCoordinateTransformFromLayerToCanvas</span><span class="p">)</span>


        <span class="c1"># camera path</span>
        <span class="k">if</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSettings</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;InspectionDigue/picturepath&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">imagedirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QSettings</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;InspectionDigue/picturepath&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">imagedirectory</span> <span class="o">=</span> <span class="kc">None</span>




    <span class="k">def</span> <span class="nf">themechanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iconwidth</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iconwidth</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">newsize</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="n">iconwidth</span><span class="p">,</span> <span class="n">iconwidth</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iconwidth</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">):</span>
            <span class="n">newsize</span> <span class="o">=</span> <span class="n">iconwidth</span>
        <span class="n">newsizeicon</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
        <span class="n">newsizeicon</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">newsize</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">newsize</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>

        <span class="n">butttons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findChildren</span><span class="p">(</span><span class="n">QPushButton</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">butttons</span><span class="p">:</span>
            <span class="c1"># print(&#39;button&#39;, button.icon())</span>
            <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">icon</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">newsizeicon</span><span class="p">)</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setBaseSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
        <span class="n">butttons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findChildren</span><span class="p">(</span><span class="n">QToolButton</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">butttons</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">icon</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setIconSize</span><span class="p">(</span><span class="n">newsizeicon</span><span class="p">)</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setBaseSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
                <span class="n">button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">dbasetablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">wgds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasetablename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span>
            <span class="c1"># print(&#39;changed&#39;, dbasetablename,wgd )</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wgds</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">listwdg</span> <span class="o">=</span> <span class="p">[</span><span class="n">wgds</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">listwdg</span> <span class="o">=</span> <span class="n">wgds</span>

            <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="n">listwdg</span><span class="p">:</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">themechanged</span><span class="p">(</span><span class="n">iconwidth</span><span class="p">)</span>




<div class="viewcode-block" id="InspectiondigueWindowWidget.setWorkingDate"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget.setWorkingDate">[docs]</a>    <span class="k">def</span> <span class="nf">setWorkingDate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">workingdate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">setDate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">setDate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">workingdate</span><span class="p">)</span>

            <span class="n">todaydate</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">currentDate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">label_end</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span> <span class="n">todaydate</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT MIN(datecreation) FROM Objet&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">startdate</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">startdate</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">date2</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="n">startdate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">date2</span> <span class="o">=</span> <span class="n">todaydate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">label_start</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">date2</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">))</span>
            <span class="n">dif</span> <span class="o">=</span> <span class="n">date2</span><span class="o">.</span><span class="n">daysTo</span><span class="p">(</span><span class="n">todaydate</span><span class="p">)</span>
            <span class="c1">#dif = todaydate - date2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">horizontalSlider_date</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dif</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">horizontalSlider_date</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dateSliderAction</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">setDate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dateDialog</span><span class="o">.</span><span class="n">dialogIsFinished</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">workingdate</span> <span class="o">=</span> <span class="n">date</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">updateWorkingDate</span><span class="p">()</span></div>







<div class="viewcode-block" id="InspectiondigueWindowWidget.closeEvent"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget.closeEvent">[docs]</a>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PyQt closeEvent - called when the windowdialog is closed</span>
<span class="sd">        Unloads the tools widgets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">tool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closingPlugin</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">renderStarting</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaserenderStarts</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">connectToGPS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">connectToGPS</span><span class="p">()</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;gps connection failed&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">GPSConnected</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">GPSConnected</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GPSconnected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">success</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabel</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : rgb(85, 255, 0);  }&quot;</span><span class="p">)</span>  <span class="c1">#vert</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabel</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;GPS connecté&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : red;  }&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Précision : erreur&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">gstsentence</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayGPSPrecision</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabel</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : rgba(0, 0, 0, 0);  }&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabel</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;GPS non connecté&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : rgba(0, 0, 0, 0);  }&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Précision : Off&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">gstsentence</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayGPSPrecision</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">displayGPSPrecision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpsdict</span><span class="p">):</span>
        <span class="n">xprecision</span> <span class="o">=</span> <span class="n">gpsdict</span><span class="p">[</span><span class="s1">&#39;xprecision&#39;</span><span class="p">]</span>
        <span class="n">yprecision</span> <span class="o">=</span> <span class="n">gpsdict</span><span class="p">[</span><span class="s1">&#39;yprecision&#39;</span><span class="p">]</span>
        <span class="n">zprecision</span> <span class="o">=</span> <span class="n">gpsdict</span><span class="p">[</span><span class="s1">&#39;zprecision&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">totalprecision</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xprecision</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yprecision</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">zprecision</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">totalprecision</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : rgb(85, 255, 0);  }&quot;</span><span class="p">)</span> <span class="c1">#vert</span>
            <span class="k">elif</span> <span class="n">totalprecision</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : yellow;  }&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">totalprecision</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : rgb(255, 170, 0);  }&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : red;  }&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Précision : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">totalprecision</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; m&#39;</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { background-color : red;  }&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GPSlabelprecision</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Précision : erreur&#39;</span><span class="p">)</span>



<div class="viewcode-block" id="InspectiondigueWindowWidget.unloadTools"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget.unloadTools">[docs]</a>    <span class="k">def</span> <span class="nf">unloadTools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;!</span>
<span class="sd">        Clears self.tools and clear the ui (tools widget and windowswidget)</span>
<span class="sd">        Called before loadTools</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># self.MaintreeWidget.clear()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stackedWidgetTool</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
                    <span class="n">widg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidgetTool</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidgetTool</span><span class="o">.</span><span class="n">removeWidget</span><span class="p">(</span><span class="n">widg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># self.errorMessage(&#39;Eror unloading tools : &#39;, e)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Eror unloading tools : &#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">pass</span></div>

    <span class="c1"># **********************************************************************************************</span>
    <span class="c1"># ********************************    MENU    ********************************************</span>
    <span class="c1"># **********************************************************************************************</span>

<div class="viewcode-block" id="InspectiondigueWindowWidget.setVisualMode"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget.setVisualMode">[docs]</a>    <span class="k">def</span> <span class="nf">setVisualMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tempres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pass</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">(),</span> <span class="n">QAction</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">actionname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span>
        <span class="n">actiontext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

        <span class="n">qactionchild</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuMode</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">qact</span> <span class="ow">in</span> <span class="n">qactionchild</span><span class="p">:</span>
            <span class="n">qact</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reset</span> <span class="ow">and</span> <span class="n">qact</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="n">actiontext</span><span class="p">:</span>
                <span class="n">qact</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actionModeTerrain</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;Terrain&quot;</span> <span class="ow">in</span> <span class="n">actiontext</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="s2">&quot;Bureau&quot;</span> <span class="ow">in</span> <span class="n">actiontext</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">desktopuiloaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loadUiDesktop</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s2">&quot;Expert&quot;</span> <span class="ow">in</span> <span class="n">actiontext</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="s2">&quot;Post traitement&quot;</span> <span class="ow">in</span> <span class="n">actiontext</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">desktopuiloaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loadUiDesktop</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">applyVisualMode</span><span class="p">(</span><span class="n">actiontext</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">applyVisualMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actiontext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">tool</span><span class="o">.</span><span class="n">changePropertiesWidget</span><span class="p">(</span><span class="n">actiontext</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;widget&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]:</span>
                            <span class="n">wdg</span><span class="o">.</span><span class="n">changePropertiesWidget</span><span class="p">(</span><span class="n">actiontext</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">changePropertiesWidget</span><span class="p">(</span><span class="n">actiontext</span><span class="p">)</span>






    <span class="k">def</span> <span class="nf">reinitCurrentPrestation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">currentprestationid</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentprestationlabel</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Prestation inactif&#39;</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">setHauteurPerche</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getDouble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="s2">&quot;Hauteur de perche&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;Rentrer la hauteur de perche GPS&quot;</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">hauteurperche</span><span class="p">,</span>
                                         <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="c1"># self.dbase.hauteurperche = num</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">hauteurperche</span> <span class="o">=</span> <span class="n">num</span>


    <span class="k">def</span> <span class="nf">setVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getInteger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="s2">&quot;Version&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;Version à afficher&quot;</span><span class="p">,</span>
                                         <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">,</span>
                                          <span class="nb">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">currentrevision</span> <span class="o">=</span> <span class="n">num</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">updateWorkingDate</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">currentItemChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">currentItem</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">currentItem</span><span class="p">())</span>



    <span class="k">def</span> <span class="nf">setLamiaIconSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iconsizedialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>



<div class="viewcode-block" id="InspectiondigueWindowWidget.newDbase"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget.newDbase">[docs]</a>    <span class="k">def</span> <span class="nf">newDbase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(self.sender().objectName())</span>
        <span class="c1"># print(self.sender().text())</span>
        <span class="c1"># new db dialog</span>

        <span class="c1">#self.newDBDialog.dbase = self.dbase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newDBDialog</span><span class="o">.</span><span class="n">comboBox_type</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newDBDialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        <span class="n">dbtype</span><span class="p">,</span> <span class="n">worktype</span><span class="p">,</span> <span class="n">vartype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newDBDialog</span><span class="o">.</span><span class="n">dialogIsFinished</span><span class="p">()</span>

        <span class="c1"># print(&#39;**&#39;,dbtype,worktype, vartype  )</span>
        <span class="k">if</span> <span class="n">dbtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># crs selector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crsselector</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crsselector</span><span class="o">.</span><span class="n">selectedAuthId</span><span class="p">()</span>
            <span class="n">crsnumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">crs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crsselector</span><span class="o">.</span><span class="n">crs</span><span class="p">()</span><span class="o">.</span><span class="n">authid</span><span class="p">()</span>
            <span class="n">crsnumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">crs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># ressources directory</span>
        <span class="k">if</span> <span class="n">dbtype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">resdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Selectionner le repertoire des ressources&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resdir</span><span class="p">:</span>
                <span class="n">resdir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resdir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># dialogs finished - reinit base</span>
        <span class="c1">#self.dbase.reInitDBase()</span>
        <span class="c1">#reset dbase</span>
        <span class="c1">#self.createDBase()</span>


        <span class="c1"># create database</span>
        <span class="k">if</span> <span class="n">dbtype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">spatialitefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Lamia nouveau&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*.sqlite&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">spatialitefile</span><span class="p">,</span> <span class="n">fileext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Lamia nouveau&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*.sqlite&#39;</span><span class="p">)</span>
            <span class="c1">#print(&#39;spatialitefile&#39;, spatialitefile)</span>
            <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatialitefile</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">spatialitefile</span> <span class="o">=</span> <span class="n">spatialitefile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBase</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">spatialitefile</span><span class="p">:</span>
                <span class="c1"># reset dbase</span>
                <span class="c1"># self.createDBase()</span>
                <span class="c1"># originalfile = os.path.join(os.path.dirname(__file__), &#39;..&#39;, &#39;DBASE&#39;, &#39;DBase_ind0.sqlite&#39;)</span>
                <span class="c1"># shutil.copyfile(originalfile, spatialitefile)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="p">(</span><span class="s1">&#39; Creation de la base de donnees...&#39;</span><span class="p">)</span>
                <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                <span class="c1">#resdir = self.createRessourcesDir(dbtype,resdir, spatialitefile, vardir=vardir )</span>


                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createDbase</span><span class="p">(</span><span class="n">slfile</span><span class="o">=</span><span class="n">spatialitefile</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crsnumber</span><span class="p">,</span> <span class="n">worktype</span><span class="o">=</span><span class="n">worktype</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;spatialite&#39;</span><span class="p">,</span>
                                       <span class="n">dbaseressourcesdirectory</span> <span class="o">=</span> <span class="n">resdir</span><span class="p">,</span> <span class="n">variante</span><span class="o">=</span><span class="n">vartype</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">spatialitefile</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span><span class="p">,</span>
                                              <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pghost</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgport</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgdb</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span>
                                              <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pguser</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgpassword</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">dbtype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connDialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
            <span class="n">adresse</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connDialog</span><span class="o">.</span><span class="n">dialogIsFinished</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">adresse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createDBase</span><span class="p">()</span>
                <span class="n">databaseexists</span><span class="p">,</span> <span class="n">schemaexists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">checkIfPGShcemaExists</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">adresse</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="n">nom</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                                                                                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
                <span class="k">if</span>  <span class="n">schemaexists</span> <span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;schema existe deja - choisir un autre schema&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="p">(</span><span class="s1">&#39;Creation de la base de donnees...&#39;</span><span class="p">)</span>
                    <span class="c1"># reset dbase</span>
                    <span class="c1">#self.createDBase()</span>
                    <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

                    <span class="c1">#resdir = self.createRessourcesDir(dbtype, resdir,vardir=vardir)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createDbase</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">crsnumber</span><span class="p">,</span> <span class="n">worktype</span><span class="o">=</span><span class="n">worktype</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;postgis&#39;</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="n">nom</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                                           <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">adresse</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">dbaseressourcesdirectory</span><span class="o">=</span><span class="n">resdir</span><span class="p">,</span>
                                           <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span><span class="n">variante</span><span class="o">=</span><span class="n">vartype</span><span class="p">)</span>



                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">spatialitefile</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span><span class="p">,</span>
                                                  <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pghost</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgport</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgdb</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span>
                                                  <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pguser</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgpassword</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">createRessourcesDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbasetype</span><span class="p">,</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span> <span class="n">slfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">vardir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">dbaseressourcesdirectory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">slfile</span><span class="p">),</span> <span class="sa">u</span><span class="s1">&#39;DBspatialite&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="n">dbaseressourcesdirectory</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">)</span>
            <span class="n">configdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">configdir</span><span class="p">)</span>
            <span class="c1"># tool dir</span>
            <span class="n">dbasedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span> <span class="s1">&#39;dbase&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dbasedir</span><span class="p">)</span>

            <span class="n">rapportdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span> <span class="s1">&#39;rappporttools&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">rapportdir</span><span class="p">)</span>
            <span class="n">styledir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span> <span class="s1">&#39;styles&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">styledir</span><span class="p">)</span>
            <span class="n">importdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span> <span class="s1">&#39;importtools&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">importdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vardir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dirfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">vardir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vardir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">dirfile</span> <span class="ow">in</span> <span class="n">dirfiles</span><span class="p">:</span>
                <span class="n">fromfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vardir</span><span class="p">,</span> <span class="n">dirfile</span><span class="p">)</span>
                <span class="n">tofile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="s1">&#39;dbase&#39;</span><span class="p">,</span> <span class="n">dirfile</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fromfile</span><span class="p">,</span> <span class="n">tofile</span><span class="p">)</span>



        <span class="k">return</span> <span class="n">dbaseressourcesdirectorytemp</span>



<div class="viewcode-block" id="InspectiondigueWindowWidget.openFileFromMenu"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget.openFileFromMenu">[docs]</a>    <span class="k">def</span> <span class="nf">openFileFromMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pass</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#reset dbase</span>
        <span class="c1">#reset dbase</span>


        <span class="n">filetoopen</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filetoopen</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBase</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">filetoopen</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBase</span><span class="p">()</span>
            <span class="n">db</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">filetoopen</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="n">nom</span><span class="p">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">adresse</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;postgis&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">adresse</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">dbname</span><span class="o">=</span><span class="n">nom</span><span class="p">,</span>
                                            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span></div>

    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">loadSLDbase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">file</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getOpenFileNameAndFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Choose the file&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                                     <span class="s1">&#39;Spatialite (*.sqlite)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">file</span> <span class="p">,</span> <span class="n">extension</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Choose the file&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                                     <span class="s1">&#39;Spatialite (*.sqlite)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
            <span class="c1"># reset dbase</span>
            <span class="c1">#self.reinitDBase()</span>
            <span class="c1"># reset dbase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBase</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loadPGDbase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connDialog</span> <span class="o">=</span> <span class="n">ConnexionPGDialog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connDialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        <span class="n">adresse</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connDialog</span><span class="o">.</span><span class="n">dialogIsFinished</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">adresse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># reset dbase</span>
            <span class="c1"># reset dbase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBase</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;postgis&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">adresse</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="n">nom</span><span class="p">,</span>
                                            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">updateRecentDBaseMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBases_recentes</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openFileFromMenu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBases_recentes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">telem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">menuBases_recentes</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">telem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBases_recentes</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openFileFromMenu</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_readRecentDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lit le fichier des bases de données recentes et rempli le  menu//Fichier//base de données recentes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pathrecentproject</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;recentprojects.txt&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathrecentproject</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span> <span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># self.recentDBaseChanged.emit()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRecentDBaseMenu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_AddDbaseInRecentsDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatialitefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                                <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methode appelée lors du chargement d&#39;une BD lamia</span>
<span class="sd">        Ajoute le chemin dans le fichier chargé dans Menu//Fichier//base de données recentes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spatialitefile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spatialitefile</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spatialitefile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saveRecentDBase</span><span class="p">()</span>
            <span class="c1"># self.recentDBaseChanged.emit()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateRecentDBaseMenu</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span><span class="n">schema</span>  <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="n">password</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saveRecentDBase</span><span class="p">()</span>
            <span class="c1"># self.recentDBaseChanged.emit()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateRecentDBaseMenu</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_saveRecentDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sauve le path de la BD lamia en cours d&#39;utilisation dans le ficier employé dans</span>
<span class="sd">        menu//Fichier//base de données recentes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pathrecentproject</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;recentprojects.txt&#39;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathrecentproject</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># self.recentDBaseChanged.emit()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateRecentDBaseMenu</span><span class="p">()</span>







<div class="viewcode-block" id="InspectiondigueWindowWidget.DBaseLoaded"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget.DBaseLoaded">[docs]</a>    <span class="k">def</span> <span class="nf">DBaseLoaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load layers and put them in a legend group in qgis</span>
<span class="sd">        Load all modules (prepro, postpro and menu)</span>
<span class="sd">        Show field ui</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">uninstallErrorHook</span><span class="p">()</span>  <span class="c1"># for standart output</span>
            <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">uninstallErrorHook</span><span class="p">()</span>  <span class="c1"># for standart output</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__excepthook__</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="s1">&#39;okok&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_AddDbaseInRecentsDBase</span><span class="p">(</span><span class="n">spatialitefile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">spatialitefile</span><span class="p">,</span>
                                     <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pghost</span><span class="p">,</span>
                                     <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgport</span><span class="p">,</span>
                                     <span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgdb</span><span class="p">,</span>
                                     <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span>
                                     <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pguser</span><span class="p">,</span>
                                     <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgpassword</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="o">.</span><span class="n">setCRS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgiscrs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">updateWorkingDate</span><span class="p">()</span>
        <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; progress bar done </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="c1"># ************************** Define qgis legend gourp and dock widget title ***********************************</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">layerTreeRoot</span><span class="p">()</span>
        <span class="c1">#root.addGroup(&#39;Lamia&#39;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s2">&quot;spatialite&quot;</span><span class="p">:</span>
            <span class="n">groupname</span> <span class="o">=</span> <span class="s1">&#39;Lamia_&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">spatialitefile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s2">&quot;postgis&quot;</span><span class="p">:</span>
            <span class="n">groupname</span> <span class="o">=</span> <span class="s1">&#39;Lamia_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">pgschema</span>

        <span class="c1">#lamialegendgroup =  root.findGroup(&#39;Lamia&#39;)</span>
        <span class="n">lamialegendgroup</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findGroup</span><span class="p">(</span><span class="n">groupname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lamialegendgroup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lamialegendgroup</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">insertGroup</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">groupname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span> <span class="o">=</span> <span class="n">lamialegendgroup</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dockwgt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dockwgt</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">groupname</span><span class="p">)</span>

        <span class="c1"># ************************** LOAD LAYERS AND STYLES ***********************************</span>

        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]:</span>

                <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                        <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">],</span>
                                                                             <span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>


                <span class="n">lamialegendgroup</span><span class="o">.</span><span class="n">addLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                    <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span>
                                                                         <span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span>
                                                                <span class="kc">False</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">loadStyle</span><span class="p">()</span>

        <span class="c1"># ************************** LOAD prepro MODULES ********************************************</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;toolprepro&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">modules</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/*.py&quot;</span><span class="p">)</span>
            <span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">modules</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
            <span class="n">interfacefielduisup</span><span class="o">=</span><span class="p">[]</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">__all__</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;x </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">#   if not self.dbase.standalone:</span>
                    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;import Lamia.toolprepro.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="n">moduletemp</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;Lamia.toolprepro.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="p">)</span>
                    <span class="c1"># moduletemp = importlib.import_module(&#39;.&#39; + str(x), &#39;Lamia.toolprepro.&#39; + self.dbase.type.lower())</span>
                    <span class="c1"># moduletemp = importlib.import_module(&#39;.&#39; + str(x), &#39;..toolprepro.&#39; + self.dbase.type.lower())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;import Lamia.toolprepro.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="n">moduletemp</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;Lamia.toolprepro.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">moduletemp</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">moduletemp</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="p">:</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">tempspecialfieldui</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">specialfieldui</span>
                            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tempspecialfieldui</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interfacefielduisup</span><span class="p">:</span>
                                    <span class="n">interfacefielduisup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">LOADFIRST</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">uifields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">uidesktop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="k">pass</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step1&#39;</span><span class="p">)</span>

        <span class="c1"># add field ui in interface menu</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">interfacefielduisup</span> <span class="p">:</span>
            <span class="n">tempaction</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Terrain_&quot;</span> <span class="o">+</span> <span class="n">elem</span> <span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">tempaction</span><span class="o">.</span><span class="n">setCheckable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">menuMode</span><span class="o">.</span><span class="n">insertAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actionTTC</span><span class="p">,</span> <span class="n">tempaction</span><span class="p">)</span>
            <span class="n">tempaction</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setVisualMode</span><span class="p">)</span>


        <span class="c1"># ************************** LOAD postpro MODULES ********************************************</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;toolpostpro&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="n">modules</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/*.py&quot;</span><span class="p">)</span>
            <span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">modules</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">__all__</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">#if not self.dbase.standalone:</span>
                    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;import Lamia.toolpostpro.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                    <span class="n">moduletemp</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;Lamia.toolpostpro.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;import Lamia.toolpostpro.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span> <span class="p">)</span>
                    <span class="n">moduletemp</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;Lamia.toolpostpro.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">moduletemp</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">moduletemp</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="s1">&#39;TOOLNAME&#39;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">uipostpro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                            <span class="c1"># print(type(obj), obj.__class__)</span>
                        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">DBASES</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">uipostpro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;applyVisualMode </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>



        <span class="c1"># ************************** Show fields ui ********************************************</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadUiField</span><span class="p">()</span></div>



    <span class="k">def</span> <span class="nf">loadStyle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_style</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboStyleChanged</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_style</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">stylepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="s1">&#39;DBASE&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">styledirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">stylepath</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">styledirs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">styledirs</span> <span class="o">=</span> <span class="n">styledirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_style</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">styledirs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_style</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comboStyleChanged</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_style</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>



<div class="viewcode-block" id="InspectiondigueWindowWidget.comboStyleChanged"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.InspectiondigueWindowWidget.comboStyleChanged">[docs]</a>    <span class="k">def</span> <span class="nf">comboStyleChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">comboindex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Listener on style combobox changed</span>
<span class="sd">        :param comboindex:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">styledir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comboBox_style</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="n">stylerep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;DBASE&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">styledir</span> <span class="p">)</span>

        <span class="n">allfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">stylerep</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">qmlfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">uknfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">uknfile</span> <span class="ow">in</span> <span class="n">allfiles</span> <span class="k">if</span> <span class="n">uknfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;qml&#39;</span><span class="p">]</span>


        <span class="k">for</span> <span class="n">dbasetablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lgdiface</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">legendInterface</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lgdiface</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">dbasetablename</span> <span class="ow">in</span> <span class="n">qmlfiles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lgdiface</span><span class="p">:</span>
                        <span class="n">lgdiface</span><span class="o">.</span><span class="n">setLayerVisible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasetablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">stylepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stylerep</span><span class="p">,</span><span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;.qml&#39;</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasetablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loadNamedStyle</span><span class="p">(</span><span class="n">stylepath</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lgdiface</span><span class="p">:</span>
                        <span class="n">lgdiface</span><span class="o">.</span><span class="n">setLayerVisible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasetablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;layerqgis&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasetablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                    <span class="n">ltl</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">layerTreeRoot</span><span class="p">()</span><span class="o">.</span><span class="n">findLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasetablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">dbasetablename</span> <span class="ow">in</span> <span class="n">qmlfiles</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ltl</span><span class="p">:</span>
                            <span class="n">ltl</span><span class="o">.</span><span class="n">setItemVisibilityChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">stylepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stylerep</span><span class="p">,</span> <span class="n">dbasetablename</span> <span class="o">+</span> <span class="s1">&#39;.qml&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasetablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loadNamedStyle</span><span class="p">(</span><span class="n">stylepath</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ltl</span><span class="p">:</span>
                            <span class="n">ltl</span><span class="o">.</span><span class="n">setItemVisibilityChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refreshAllLayers</span><span class="p">()</span></div>



    <span class="k">def</span> <span class="nf">loadUiField</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; start </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="c1"># init progress bar</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progressMessageBar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">createMessage</span><span class="p">(</span><span class="s2">&quot;Loading widget...&quot;</span><span class="p">)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">()</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span><span class="p">)</span>
            <span class="n">progressMessageBar</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>
            <span class="n">lenuifields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uifields</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">lenuifields</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#load ui fields</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">uifield</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uifields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; start </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">uifield</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
            <span class="n">dbasename</span> <span class="o">=</span> <span class="n">uifield</span><span class="o">.</span><span class="n">dbasetablename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">uifield</span><span class="p">(</span><span class="n">dbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="p">,</span>
                                                                     <span class="n">dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span>
                                                                     <span class="n">linkedtreewidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span><span class="p">,</span>
                                                                     <span class="n">gpsutil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; end </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">uifield</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setLoadingProgressBar</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">clearWidgets</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">loadUiDesktop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># init progress bar</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progressMessageBar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">createMessage</span><span class="p">(</span><span class="s2">&quot;Loading widget...&quot;</span><span class="p">)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">()</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span><span class="p">)</span>
            <span class="n">progressMessageBar</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>
            <span class="n">lenuifields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uidesktop</span><span class="p">)</span>
            <span class="n">lenuipostpro</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uipostpro</span><span class="p">)</span>
            <span class="n">lenmenutool</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menuclasses</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">lenuifields</span> <span class="o">+</span> <span class="n">lenuipostpro</span> <span class="o">+</span> <span class="n">lenmenutool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># load menu ui</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">menuclasse</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuclasses</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">menutools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">menuclasse</span><span class="p">(</span><span class="n">dbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="p">,</span> <span class="n">windowdialog</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setLoadingProgressBar</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; loading </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">menuclasse</span><span class="p">))</span>

        <span class="c1"># load postpro ui</span>
        <span class="k">for</span> <span class="n">uidpostpr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uipostpro</span><span class="p">:</span>
            <span class="c1"># print(&#39;uidpostpr&#39;, uidpostpr)</span>
            <span class="n">strtoexec</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;self.&#39;</span> <span class="o">+</span> <span class="n">uidpostpr</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = uidpostpr(dbase = self.dbase, dialog = self,linkedtreewidget = self.ElemtreeWidget, gpsutil = self.gpsutil)&quot;</span><span class="p">)</span>
            <span class="c1"># print(strtoexec)</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">strtoexec</span><span class="p">)</span>
            <span class="c1"># print(&#39;test&#39;, eval(&#39;self.&#39; + uidpostpr.__name__.lower()))</span>
            <span class="n">strtoexec</span> <span class="o">=</span> <span class="s1">&#39;self.tools.append(&#39;</span> <span class="o">+</span> <span class="s1">&#39;self.&#39;</span> <span class="o">+</span> <span class="n">uidpostpr</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="c1"># print(strtoexec)</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">strtoexec</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; loading </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uidpostpr</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="c1"># print(&#39;ok&#39;)</span>


            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">uidpostpr</span><span class="p">(</span><span class="n">dbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="p">,</span>
                                             <span class="n">dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span>
                                             <span class="n">linkedtreewidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span><span class="p">,</span>
                                             <span class="n">gpsutil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="p">)</span>
                               <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setLoadingProgressBar</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># load uidesktop ui</span>
        <span class="k">for</span> <span class="n">uidesktop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uidesktop</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dbasename</span> <span class="o">=</span> <span class="n">uidesktop</span><span class="o">.</span><span class="n">dbasetablename</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uidesktop</span><span class="p">(</span><span class="n">dbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="p">,</span>
                                                                         <span class="n">dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span>
                                                                         <span class="n">linkedtreewidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span><span class="p">,</span>
                                                                         <span class="n">gpsutil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setLoadingProgressBar</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">clearWidgets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desktopuiloaded</span> <span class="o">=</span> <span class="kc">True</span>



    <span class="c1">#**********************************************************************************************</span>
    <span class="c1">#********************************    Tree widget    ********************************************</span>
    <span class="c1">#**********************************************************************************************</span>

    <span class="k">def</span> <span class="nf">zoomToFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidgetTool</span><span class="o">.</span><span class="n">currentWidget</span><span class="p">()</span>
        <span class="n">wdg</span><span class="o">.</span><span class="n">zoomToFeature</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copyFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidgetTool</span><span class="o">.</span><span class="n">currentWidget</span><span class="p">()</span>
        <span class="n">wdg</span><span class="o">.</span><span class="n">copyFeature</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">addFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidgetTool</span><span class="o">.</span><span class="n">currentWidget</span><span class="p">()</span>
        <span class="n">wdg</span><span class="o">.</span><span class="n">addFeature</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">deleteToFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidgetTool</span><span class="o">.</span><span class="n">currentWidget</span><span class="p">()</span>
        <span class="n">wdg</span><span class="o">.</span><span class="n">deleteFeature</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">selectFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMapToolEmitPoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span> <span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapTool</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapToolSet</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolsetChanged</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">setMapTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapToolSet</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolsetChanged</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span> <span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">setMapTool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span> <span class="p">)</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapTool</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapTool</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapToolSet</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolsetChanged</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">setMapTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapToolSet</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolsetChanged</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapToolSet</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolsetChanged</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">setMapTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">editFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">editfeatureworking</span> <span class="o">==</span> <span class="kc">True</span> <span class="p">:</span>
            <span class="k">return</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">editfeatureworking</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if True:</span>
<span class="sd">            if int(str(self.dbase.qgisversion_int)[0:3]) &lt; 220:</span>
<span class="sd">                qgis.core.QgsMapLayerRegistry.instance().addMapLayer(self.dbase.dbasetables[tablename][&#39;layerqgis&#39;],</span>
<span class="sd">                                                                     False)</span>
<span class="sd">            else:</span>
<span class="sd">                qgis.core.QgsProject.instance().addMapLayer(self.dbase.dbasetables[tablename][&#39;layerqgis&#39;],</span>
<span class="sd">                                                            False)</span>
<span class="sd">        lamialegendgroup.addLayer(self.dbase.dbasetables[tablename][&#39;layerqgis&#39;])</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">(),</span>
                                                             <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_edit&#39;</span><span class="p">,</span>
                                                             <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">providerType</span><span class="p">())</span>

            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">editfeaturetreelayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span><span class="o">.</span><span class="n">insertLayer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">setActiveLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">actionNodeTool</span><span class="p">()</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">editfeaturetreelayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span><span class="o">.</span><span class="n">insertLayer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">setActiveLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">actionVertexTool</span><span class="p">()</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">editfeatureworking</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">closeEditFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maintreewdgindex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savechanges</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">editfeatureworking</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">editfeatureworking</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">savechanges</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">savechanges</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="o">.</span><span class="n">rollBack</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span><span class="o">.</span><span class="n">removeLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editfeaturelayer</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">selectPickedFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="c1"># print(&#39;select&#39;,point.x(), point.y())</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>

        <span class="n">addselection</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">modifiers</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">keyboardModifiers</span><span class="p">()</span>
        <span class="c1">#print(&#39;modif&#39;)</span>
        <span class="c1">#if modifiers == QtCore.Qt.ShiftModifier:</span>
        <span class="k">if</span> <span class="n">modifiers</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ControlModifier</span><span class="p">:</span>
            <span class="c1"># print(&#39;Ctrl+Click&#39;)</span>
            <span class="n">addselection</span> <span class="o">=</span> <span class="kc">True</span>



        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">unsetMapTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># print(&#39;windowd selectPickedFeature&#39;,self.stackedWidget_main.currentIndex() )</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>  <span class="p">:</span>

            <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MaintabWidget</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;dabsetable </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">))</span>

            <span class="n">point2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">toLayerCoordinates</span><span class="p">(</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">],</span> <span class="n">point</span><span class="p">)</span>

            <span class="n">nearestpk</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getNearestPk</span><span class="p">(</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetable</span><span class="p">,</span>
                                                      <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>
                                                      <span class="n">point2</span><span class="p">,</span>
                                                      <span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;nearest pk </span><span class="si">%s</span><span class="s1"> , dist </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nearestpk</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">nearestpk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1">#no element in table</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">nearestpk</span><span class="p">)</span>
                <span class="n">featid</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">]</span>
                <span class="c1"># print(&#39;sel&#39;,featid)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">featid</span> <span class="o">=</span> <span class="n">nearestpk</span>

            <span class="k">if</span> <span class="n">wdg</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">findItems</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">featid</span><span class="p">),</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MatchExactly</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MatchRecursive</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">:</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setCurrentItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="c1">#wdg.linkedtreewidget.setItemSelected(item, True)</span>
                        <span class="c1"># print(&#39;ok&#39;)</span>
                        <span class="k">break</span>

                <span class="c1"># print(&#39;item&#39;, item.text(0))</span>
                <span class="c1">#self.linkedtreewidget.setSelectionMode(QAbstractItemView.ExtendedSelection)</span>


            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">itemindex</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">featid</span><span class="p">))</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">comboBox_featurelist</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">itemindex</span><span class="p">)</span>



        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackedWidget_main</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">wdg</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span>

            <span class="n">point2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">toLayerCoordinates</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>

            <span class="n">nearestpk</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getNearestPk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">],</span>
                                                      <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span>
                                                      <span class="n">point2</span><span class="p">,</span>
                                                      <span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;nearest pk </span><span class="si">%s</span><span class="s1"> , dist </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nearestpk</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">nearestpk</span><span class="p">)</span>
                <span class="n">featid</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">]</span>
                <span class="c1"># print(&#39;sel&#39;,featid)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">featid</span> <span class="o">=</span> <span class="n">nearestpk</span>

            <span class="k">if</span> <span class="n">wdg</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">wdg</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">findItems</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">featid</span><span class="p">),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MatchExactly</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MatchRecursive</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">wdg</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">:</span>
                        <span class="n">wdg</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">setCurrentItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="c1"># wdg.linkedtreewidget.setItemSelected(item, True)</span>
                        <span class="c1">#print(&#39;ok&#39;)</span>
                        <span class="k">break</span>

                <span class="c1">#print(&#39;item&#39;, item.text(0))</span>




        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">unsetMapTool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span> <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapTool</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span> <span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectPickedFeature</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>




    <span class="k">def</span> <span class="nf">toolsetChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newtool</span><span class="p">,</span> <span class="n">oldtool</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># print(&#39;toolsetchanged&#39;, newtool,oldtool )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeEditFeature</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">newtool</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span> <span class="p">:</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span> <span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># self.pointEmitter = None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapToolSet</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolsetChanged</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointEmitter</span><span class="o">.</span><span class="n">canvasClicked</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapToolSet</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolsetChanged</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setImageDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Select Directory&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">imagedirectory</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">ShowDirsOnly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">imagedirectory</span> <span class="o">=</span> <span class="n">file</span>
            <span class="n">QtCore</span><span class="o">.</span><span class="n">QSettings</span><span class="p">()</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;InspectionDigue/picturepath&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">showNumPad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finalwdg</span><span class="p">):</span>
        <span class="c1"># print(&#39;ok&#39;, finalwdg)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">numpaddialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpaddialog</span><span class="o">.</span><span class="n">dialogIsFinished</span><span class="p">()</span>
        <span class="c1"># print(number)</span>
        <span class="k">if</span> <span class="n">number</span><span class="p">:</span>
            <span class="n">finalwdg</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">exportBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1">#exportfile, extension = self.qfiledlg.getOpenFileNameAndFilter(None, &#39;Export vers&#39;, &#39;&#39;,&#39;Spatialite (*.sqlite)&#39;, &#39;&#39;)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">exportfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Lamia exporter vers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*.sqlite&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">exportfile</span><span class="p">,</span> <span class="n">fileext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Lamia exporter vers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*.sqlite&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exportfile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exportdbase</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exportdbase</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">exportfile</span><span class="p">)</span>

            <span class="c1"># backup destination exportfile</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">exportfile</span><span class="p">)</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M&quot;</span><span class="p">)</span>
            <span class="n">finalname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">exportfile</span><span class="p">),</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="s1">&#39;.sqlite&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">exportfile</span><span class="p">,</span> <span class="n">finalname</span><span class="p">)</span>

            <span class="c1"># run export</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">exportBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exportdbase</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if not self.dbase.standalone:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Lamia &quot;</span><span class="p">,</span> <span class="s1">&#39;Export fini&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;export fini&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">openHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="s1">&#39;doc_html&#39;</span><span class="p">,</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">errorMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># print(&#39;eror&#39;, self.sender(),self.sender().name())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#if not self.dbase.standalone:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Lamia &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                                                          <span class="n">level</span><span class="o">=</span><span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Lamia &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                                                          <span class="n">level</span><span class="o">=</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Critical</span> <span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ErrorMessage&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">warningMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if not self.dbase.standalone:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Lamia &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                                                          <span class="n">level</span><span class="o">=</span><span class="n">qgis</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Lamia &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                                                          <span class="n">level</span><span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Warning</span> <span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ErrorMessage&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#if not self.dbase.standalone:</span>
            <span class="c1"># self.dbase.qgsiface.messageBar().pushMessage(&quot;InspectionDigue&quot;, text, level=qgis.gui.QgsMessageBar.INFO, duration=3)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Lamia &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Lamia &quot;</span> <span class="p">,</span><span class="n">text</span><span class="p">,</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;normalMessage&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>



    <span class="k">def</span> <span class="nf">cleanLayerTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span><span class="o">.</span><span class="n">removeAllChildren</span><span class="p">()</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">layerTreeRoot</span><span class="p">()</span>
            <span class="n">root</span><span class="o">.</span><span class="n">removeChildNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span><span class="p">)</span>





    <span class="k">def</span> <span class="nf">exportPDFFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="p">(</span><span class="s1">&#39;Export termine&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">printError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">errorstr</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">errorstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">printMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    def importObjet(self):</span>

<span class="sd">        items = (&quot;Points topo&quot;, &quot;Infralineaire&quot;)</span>
<span class="sd">        item, ok = QInputDialog.getItem(self, &quot;select input dialog&quot;,</span>
<span class="sd">                                        &quot;list of languages&quot;, items, 0, False)</span>
<span class="sd">        if ok and item:</span>
<span class="sd">            if self.dbase.qgsiface is not None:</span>
<span class="sd">                #if not self.dbase.standalone:</span>
<span class="sd">                currentlayer = self.dbase.qgsiface.activeLayer()</span>
<span class="sd">                currentlayerfields = currentlayer.fields()</span>
<span class="sd">                currentlayerfieldsname = [&#39;&#39;] + [field.name() for field in currentlayerfields]</span>
<span class="sd">                # combofield = QComboBox([&#39;&#39;] + currentlayerfieldsname)</span>
<span class="sd">            else:       #debug outside qgis</span>
<span class="sd">                currentlayerfieldsname = [&#39;&#39;,&#39;ALTINGF&#39;,&#39;typ&#39;]</span>



<span class="sd">            if item == &quot;Points topo&quot;:</span>
<span class="sd">                print(&#39;ok&#39;)</span>
<span class="sd">                templinkuserwgd = self.dbase.dbasetables[&#39;Topographie&#39;][&#39;widget&#39;].propertieswdgPOINTTOPO.linkuserwdg</span>
<span class="sd">            if item == &quot;Infralineaire&quot;:</span>
<span class="sd">                templinkuserwgd = self.dbase.dbasetables[&#39;Infralineaire&#39;][&#39;widget&#39;].linkuserwdg</span>
<span class="sd">            if item == &quot;Desordre&quot;:</span>
<span class="sd">                templinkuserwgd = self.dbase.dbasetables[&#39;Desordre&#39;][&#39;widget&#39;].linkuserwdg</span>
<span class="sd">            if item == &quot;Observation&quot;:</span>
<span class="sd">                templinkuserwgd = self.dbase.dbasetables[&#39;Observation&#39;][&#39;widget&#39;].linkuserwdg</span>
<span class="sd">            if item == &quot;Noeud&quot;:</span>
<span class="sd">                templinkuserwgd = self.dbase.dbasetables[&#39;Noeud&#39;][&#39;widget&#39;].linkuserwdg</span>
<span class="sd">            if item == &quot;Equipement&quot;:</span>
<span class="sd">                templinkuserwgd = self.dbase.dbasetables[&#39;Equipement&#39;][&#39;widget&#39;].linkuserwdg</span>
<span class="sd">            if item == &quot;Travaux&quot;:</span>
<span class="sd">                templinkuserwgd = self.dbase.dbasetables[&#39;Travaux&#39;][&#39;widget&#39;].linkuserwdg</span>
<span class="sd">            if item == &quot;Environnement&quot;:</span>
<span class="sd">                templinkuserwgd = self.dbase.dbasetables[&#39;Environnement&#39;][&#39;widget&#39;].linkuserwdg</span>


<span class="sd">            self.importobjetdialog.tableWidget.setRowCount(0)</span>
<span class="sd">            self.importobjetdialog.tableWidget.setColumnCount(2)</span>
<span class="sd">            for tablename in templinkuserwgd:</span>
<span class="sd">                if tablename in self.dbase.dbasetables.keys():</span>
<span class="sd">                    dbasetable = self.dbase.dbasetables[tablename]</span>
<span class="sd">                    for field in dbasetable[&#39;fields&#39;].keys():</span>
<span class="sd">                        #print(field)</span>
<span class="sd">                        rowPosition = self.importobjetdialog.tableWidget.rowCount()</span>
<span class="sd">                        self.importobjetdialog.tableWidget.insertRow(rowPosition)</span>
<span class="sd">                        itemfield = QTableWidgetItem(tablename + &#39;.&#39; + field)</span>
<span class="sd">                        itemfield.setFlags(QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsEnabled)</span>
<span class="sd">                        self.importobjetdialog.tableWidget.setItem(rowPosition, 0, itemfield)</span>
<span class="sd">                        # item.setFlags()</span>
<span class="sd">                        if field[0:2] != &#39;id&#39;:</span>
<span class="sd">                            combofield = QComboBox()</span>
<span class="sd">                            combofield.addItems(currentlayerfieldsname)</span>
<span class="sd">                            self.importobjetdialog.tableWidget.setCellWidget(rowPosition, 1, combofield)</span>
<span class="sd">                        else:</span>
<span class="sd">                            itemfield = QTableWidgetItem(&#39;&#39;)</span>
<span class="sd">                            self.importobjetdialog.tableWidget.setItem(rowPosition, 1, itemfield)</span>


<span class="sd">            self.importobjetdialog.exec_()</span>
<span class="sd">            tableview = self.importobjetdialog.dialogIsFinished()</span>
<span class="sd">            if tableview is not None:</span>
<span class="sd">                result = []</span>
<span class="sd">                for row in range(self.importobjetdialog.tableWidget.rowCount()):</span>
<span class="sd">                    if self.importobjetdialog.tableWidget.cellWidget(row, 1) is not None:</span>
<span class="sd">                        result.append([self.importobjetdialog.tableWidget.item(row,0).text(),</span>
<span class="sd">                                       self.importobjetdialog.tableWidget.cellWidget(row, 1).currentText()])</span>
<span class="sd">                    else:</span>
<span class="sd">                        result.append([self.importobjetdialog.tableWidget.item(row,0).text(),self.importobjetdialog.tableWidget.item(row,1).text()])</span>
<span class="sd">                print(result)</span>

<span class="sd">                if True:</span>
<span class="sd">                    self.worker = ImportObjectWorker(self.dbase, item, result)</span>
<span class="sd">                    self.worker.finished.connect(self.exportPDFFinished)</span>
<span class="sd">                    self.worker.error.connect(self.printError)</span>
<span class="sd">                    self.worker.message.connect(self.printMessage)</span>
<span class="sd">                    self.worker.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">modeHorsLigne</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>



        <span class="c1">#First we have to disconnect : create a local db and transfer the data .............................................................</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">horsligne</span><span class="p">:</span>


            <span class="c1">#1)Create a spatialite db ..................................................</span>
            <span class="c1"># create database</span>
            <span class="k">try</span> <span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;../local/DB_local.sqlite&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1">#Create the folder to stock the new pictures</span>
            <span class="n">local_folder</span><span class="o">=</span><span class="s1">&#39;../local/local_data&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_folder</span><span class="p">)</span>

            <span class="c1">#Deal with the connections : keep in memory the former connection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span><span class="o">==</span><span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">connSLITE</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">SLITEcursor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineType</span> <span class="o">=</span> <span class="s1">&#39;spatialite&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">connPGis</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">PGiscursor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineType</span> <span class="o">=</span> <span class="s1">&#39;postgis&#39;</span>


            <span class="n">local_db</span><span class="o">=</span><span class="s1">&#39;../local/DB_local.sqlite&#39;</span>

            <span class="n">originalfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;DBASE&#39;</span><span class="p">,</span> <span class="s1">&#39;DBase_ind0.sqlite&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">originalfile</span><span class="p">,</span> <span class="n">local_db</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createDbase</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">local_db</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;digue&#39;</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;spatialite&#39;</span><span class="p">,</span>
                                       <span class="n">dbaseressourcesdirectory</span><span class="o">=</span><span class="n">local_folder</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="o">=</span><span class="n">local_folder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">=</span> <span class="s1">&#39;spatialite&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">date_deconnexion</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>



            <span class="c1">#2)Add items from the file to the spatialite database .................................................................</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dbname</span><span class="o">==</span><span class="s1">&#39;Basedonnees&#39;</span><span class="p">:</span>

                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Import de la table : &quot;</span><span class="o">+</span><span class="n">dbname</span><span class="p">)</span>
                        <span class="n">fields_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


                        <span class="n">fields_to_import</span><span class="o">=</span><span class="n">fields_table</span>
                        <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]:</span>
                            <span class="n">fields_to_import</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;ST_AsText(geom)&#39;</span><span class="p">]</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT &#39;</span><span class="o">+</span>  <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields_to_import</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; FROM &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineType</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span> <span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                                <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                                <span class="n">returnquery</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                            <span class="k">except</span> <span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error query&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                                <span class="k">continue</span>
                        <span class="k">else</span> <span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">sql</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                                    <span class="n">returnquery</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error query&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                                    <span class="k">continue</span>

                        <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]:</span>
                            <span class="n">fields_to_import</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;geom&#39;</span>

                        <span class="c1">#Deal with all the encoding problems</span>
                        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">returnquery</span><span class="p">:</span>
                            <span class="n">str_test</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span>
                            <span class="n">compteur</span><span class="o">=-</span><span class="mi">1</span>
                            <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">fields_to_import</span><span class="p">:</span>
                                <span class="n">geometry</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">toto</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                                <span class="n">null</span><span class="o">=</span><span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="n">toto</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">toto</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">toto</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">toto2</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                                <span class="k">elif</span> <span class="n">toto2</span><span class="o">==</span><span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">toto2</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="s1">&#39;NULL&#39;</span>
                                    <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
                                    <span class="n">str_test</span><span class="o">=</span><span class="n">str_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">null</span><span class="p">:</span>
                                    <span class="n">str_test</span><span class="o">+=</span><span class="n">toto2</span><span class="o">+</span><span class="s2">&quot;, &#39;&quot;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">str_test</span><span class="o">+=</span><span class="n">toto2</span><span class="o">+</span><span class="s2">&quot;&#39;, &#39;&quot;</span>
                            <span class="n">str_test</span><span class="o">=</span><span class="n">str_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

                            <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">fields_to_import</span><span class="p">:</span>
                                <span class="n">str_test</span><span class="o">+=</span><span class="s2">&quot;, &quot;</span>
                                <span class="k">try</span> <span class="p">:</span>
                                    <span class="n">str_test</span><span class="o">+=</span><span class="s1">&#39;ST_GeomFromText(</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">geometry</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">str_test</span><span class="o">+=</span><span class="s2">&quot;NULL&quot;</span>


                            <span class="c1">#Insert</span>
                            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; (&#39;</span><span class="o">+</span>  <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields_to_import</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) VALUES (&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">str_test</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">horsligne</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">horsligne</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_deconnexion</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mode hors ligne active : &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">horsligne</span><span class="p">)</span>
            <span class="k">return</span>


        <span class="c1">#Second part : reconcilliating the two databases ...............................................................................</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">horsligne</span><span class="p">:</span>
            <span class="c1">#1) Reonnect to database</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineType</span><span class="o">==</span><span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">connSLITE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">connSLITE</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">SLITEcursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">SLITEcursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">connPGis</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">connPGis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">PGiscursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">PGiscursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineType</span> <span class="o">=</span> <span class="s1">&#39;spatialite&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;postgis&#39;</span>




            <span class="c1">#2)Confront the two databases</span>
            <span class="c1">#Table to get the correspondances between local ids and ids in the original database</span>
            <span class="n">switch_id</span><span class="o">=</span><span class="p">{}</span>

            <span class="c1">#Table to store the date of the creation and the last modification of each object on the server where id_objet is the key</span>
            <span class="n">list_dates_reperes</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>

                    <span class="n">switch_id</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                    <span class="c1">#First we work on the tables connected to an object : the one with an id_objet ..............................................................................</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span> <span class="ow">and</span> <span class="s1">&#39;id_objet&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>


                        <span class="c1">#Gather the data on the local and online database</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Export de la table : &quot;</span><span class="o">+</span><span class="n">dbname</span><span class="p">)</span>
                        <span class="n">fields_to_import</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]:</span>
                            <span class="n">fields_to_import</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;ST_AsText(geom)&#39;</span><span class="p">]</span>


                        <span class="c1">#Get the data of the table in both database</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT &#39;</span><span class="o">+</span>  <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields_to_import</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; FROM &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; WHERE datecreation &gt; </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">date_deconnexion</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1"> OR datemodification &gt; </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">date_deconnexion</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span>


                        <span class="nb">print</span><span class="p">(</span><span class="n">fields_to_import</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                        <span class="c1">#Run query</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                            <span class="n">local_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                        <span class="k">except</span> <span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error query&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">None</span>

                        <span class="c1">#We run the same query on the orginial database</span>
                        <span class="n">original_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>


                        <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]:</span>
                            <span class="c1">#Rename the last field from &#39;ST_AsText(geom) to geom</span>
                            <span class="n">fields_to_import</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;geom&#39;</span>



                        <span class="c1">#Store the list of the dates of creation on the local db and date of modification on the server.</span>
                        <span class="c1">#We compare date createion on the local databse (when the base was created or after) with date modification on the central database (last update of the true db)</span>
                        <span class="k">if</span> <span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;Objet&#39;</span><span class="p">:</span>

                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">local_data</span><span class="p">:</span>
                                <span class="n">id_local</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id_objet&#39;</span><span class="p">)]</span>
                                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datecreation&#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datecreation&#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
                                    <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datecreation&#39;</span><span class="p">)],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)]</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datecreation&#39;</span><span class="p">)],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span>

                            <span class="k">for</span> <span class="n">original</span> <span class="ow">in</span> <span class="n">original_data</span><span class="p">:</span>
                                <span class="n">id_original</span><span class="o">=</span><span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id_objet&#39;</span><span class="p">)]</span>
                                <span class="k">try</span> <span class="p">:</span>
                                    <span class="k">if</span> <span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datemodification&#39;</span><span class="p">)]</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datemodification&#39;</span><span class="p">)]</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
                                        <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_original</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">try</span> <span class="p">:</span>
                                            <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_original</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datemodification&#39;</span><span class="p">)],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)]</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_original</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datemodification&#39;</span><span class="p">)],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span>
                                <span class="k">except</span> <span class="p">:</span> <span class="c1">#The item doesn&#39;t exist in the local version</span>
                                    <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_original</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datemodification&#39;</span><span class="p">)]</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datemodification&#39;</span><span class="p">)]</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
                                        <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_original</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">try</span> <span class="p">:</span>
                                            <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_original</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datemodification&#39;</span><span class="p">)],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)]</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_original</span><span class="p">]</span><span class="o">+=</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">original</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;datemodification&#39;</span><span class="p">)],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span>





                        <span class="c1">#Make sure we update the foreign key used by using the switch table</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">local_data</span> <span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;item : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                            <span class="n">pos</span><span class="o">=</span><span class="mi">0</span>
                            <span class="c1">#Get the proper id to use when updating the database</span>
                            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                                <span class="n">pos</span><span class="o">+=</span><span class="mi">1</span>

                                <span class="k">if</span> <span class="s1">&#39;lk_&#39;</span> <span class="ow">in</span> <span class="n">field</span> <span class="ow">or</span> <span class="s1">&#39;id_&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
                                    <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">switch_id</span> <span class="p">:</span>
                                    <span class="k">for</span> <span class="n">tuple_coresp</span> <span class="ow">in</span> <span class="n">switch_id</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="p">:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">tuple_coresp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]):</span>
                                                    <span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">tuple_coresp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                    <span class="k">break</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;NULL&#39;</span>



                        <span class="c1">#Get the output to send back to the database by recreating the request</span>
                            <span class="n">str_test</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span>
                            <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">fields_to_import</span><span class="p">:</span>
                                <span class="n">geometry</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                            <span class="k">for</span> <span class="n">toto</span> <span class="ow">in</span> <span class="n">item</span> <span class="p">:</span>
                                <span class="n">null</span><span class="o">=</span><span class="kc">False</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="n">toto</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">toto</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">toto</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">toto2</span><span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">toto2</span><span class="o">==</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span> <span class="ow">or</span> <span class="n">toto2</span><span class="o">==</span><span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                                <span class="k">elif</span> <span class="n">toto2</span><span class="o">==</span><span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">toto2</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
                                    <span class="n">toto2</span><span class="o">=</span><span class="s1">&#39;NULL&#39;</span>
                                    <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
                                    <span class="n">str_test</span><span class="o">=</span><span class="n">str_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">null</span><span class="p">:</span>
                                    <span class="n">str_test</span><span class="o">+=</span><span class="n">toto2</span><span class="o">+</span><span class="s2">&quot;, &#39;&quot;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">str_test</span><span class="o">+=</span><span class="n">toto2</span><span class="o">+</span><span class="s2">&quot;&#39;, &#39;&quot;</span>
                            <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">str_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

                            <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">fields_to_import</span><span class="p">:</span>
                                <span class="n">output</span><span class="o">+=</span><span class="s2">&quot;, &quot;</span>
                                <span class="k">try</span> <span class="p">:</span>
                                    <span class="n">output</span><span class="o">+=</span><span class="s1">&#39;ST_GeomFromText(</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">geometry</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">output</span><span class="o">+=</span><span class="s2">&quot;NULL&quot;</span>

                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output : &#39;</span><span class="o">+</span> <span class="n">output</span><span class="p">)</span>





                            <span class="n">id_local</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id_objet&#39;</span><span class="p">)]</span>



                            <span class="c1">#Is it a new item ? test : date de creation &gt; date de début offline</span>
                            <span class="n">nouveau</span><span class="o">=</span><span class="kc">False</span>
                            <span class="n">no_id</span><span class="o">=</span><span class="kc">False</span>
                            <span class="k">try</span> <span class="p">:</span>


                                <span class="c1">#We deal with the exceptions</span>
                                <span class="k">if</span> <span class="n">id_local</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span> <span class="ow">or</span> <span class="n">id_local</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">nouveau</span><span class="o">=</span><span class="kc">False</span>
                                    <span class="n">no_id</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;id_local null&#39;</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
                                    <span class="n">nouveau</span><span class="o">=</span><span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>


                                    <span class="c1">#The true test</span>
                                    <span class="n">nouveau</span> <span class="o">=</span> <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">date_deconnexion</span>


                            <span class="c1">#Other exceptions</span>
                            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">list_dates_reperes</span><span class="p">)</span>
                                <span class="k">return</span>
                                <span class="n">nouveau</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">no_id</span><span class="o">=</span><span class="kc">True</span>


                            <span class="c1">#If it is a new item, we add it to the database online</span>
                            <span class="k">if</span> <span class="n">nouveau</span><span class="p">:</span>

                                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; (&#39;</span><span class="o">+</span>  <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields_to_import</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) VALUES (&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) RETURNING id_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
                                <span class="n">id_res</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nouveau, sql : &#39;</span><span class="o">+</span><span class="n">sql</span><span class="p">)</span>




                                <span class="c1">#Add the new id fit in a tuple : We make sure we get the id online of the newly created item</span>
                                <span class="n">switch_id</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">+=</span><span class="p">[(</span><span class="n">item</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())],</span><span class="n">id_res</span><span class="p">)]</span>




                            <span class="c1">#Else : the data has been modified on the local version of the database</span>
                            <span class="k">else</span> <span class="p">:</span>
                                <span class="c1">#More exceptions ...</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">original_data</span><span class="o">==</span><span class="p">[]:</span>
                                    <span class="k">if</span> <span class="n">no_id</span> <span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pad d</span><span class="se">\&#39;</span><span class="s1">id local&#39;</span><span class="p">)</span>
                                        <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>


                                        <span class="k">if</span> <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
                                            <span class="n">non_modifie</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">else</span><span class="p">:</span>


                                            <span class="c1">#Was the item modified while offline ? The test is here</span>
                                            <span class="n">non_modifie</span> <span class="o">=</span> <span class="n">list_dates_reperes</span><span class="p">[</span><span class="n">id_local</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">date_deconnexion</span>



                                        <span class="c1">#If last modification on the server is before the deconnection -&gt; inject</span>
                                        <span class="k">if</span> <span class="n">non_modifie</span><span class="p">:</span>

                                            <span class="c1">#Construct the UPDATE request</span>
                                            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;UPDATE &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39; SET &#39;</span>
                                            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):]</span>
                                            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_to_import</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">field</span><span class="o">==</span><span class="p">(</span><span class="s1">&#39;id_&#39;</span><span class="o">+</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                                                    <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                                    <span class="k">pass</span>
                                                <span class="k">elif</span> <span class="n">field</span><span class="o">==</span><span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                                                    <span class="n">sql</span><span class="o">+=</span><span class="s2">&quot;geom =&quot;</span><span class="o">+</span><span class="n">output</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                                                    <span class="k">try</span> <span class="p">:</span>
                                                        <span class="n">sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; =&#39;</span><span class="o">+</span> <span class="n">output</span><span class="p">[:</span><span class="n">output</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span><span class="o">+</span><span class="s1">&#39;, &#39;</span>
                                                        <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                                    <span class="k">except</span><span class="p">:</span>
                                                        <span class="n">sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; =&#39;</span><span class="o">+</span> <span class="n">output</span>

                                            <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; WHERE id_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_local</span><span class="p">)</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;update car non modifié, output et sql :&#39;</span><span class="o">+</span><span class="n">output</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>



                                        <span class="c1">#If last modification on the server is after the deconnection -&gt; give the choice to the user</span>
                                        <span class="k">else</span> <span class="p">:</span>
                                            <span class="c1">#User has to choose the data to keep</span>
                                            <span class="c1">#Get the item version from the server to compare. Id should be the same as it was created before the deconection</span>
                                            <span class="n">original</span> <span class="o">=</span> <span class="kc">None</span>
                                            <span class="k">for</span> <span class="n">item_online</span> <span class="ow">in</span> <span class="n">original_data</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">item_online</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id_objet&#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="n">id_local</span><span class="p">:</span>
                                                    <span class="n">original</span><span class="o">=</span><span class="n">item_online</span>
                                                    <span class="nb">print</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                                                    <span class="k">break</span>



                                            <span class="c1">#3)Correct the conflict</span>
                                            <span class="c1">#Ask the user what to do</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;conflit&#39;</span><span class="p">)</span>
                                            <span class="n">ecrase</span> <span class="o">=</span> <span class="n">ConflitHorsLigne</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>




                                            <span class="c1">#If the user wants to erase the data online</span>
                                            <span class="k">if</span> <span class="n">ecrase</span> <span class="p">:</span>
                                                <span class="c1">#Construct the UPDATE request</span>
                                                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;UPDATE &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39; SET &#39;</span>
                                                <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):]</span>
                                                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_to_import</span><span class="p">:</span>
                                                    <span class="k">if</span> <span class="n">field</span><span class="o">==</span><span class="p">(</span><span class="s1">&#39;id_&#39;</span><span class="o">+</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                                                        <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                                        <span class="k">pass</span>
                                                    <span class="k">elif</span> <span class="n">field</span><span class="o">==</span><span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                                                        <span class="n">sql</span><span class="o">+=</span><span class="s2">&quot;geom =&quot;</span><span class="o">+</span><span class="n">output</span>
                                                    <span class="k">else</span><span class="p">:</span>
                                                        <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output, sql :&#39;</span><span class="o">+</span> <span class="n">output</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
                                                        <span class="k">try</span> <span class="p">:</span>
                                                            <span class="n">sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; =&#39;</span><span class="o">+</span> <span class="n">output</span><span class="p">[:</span><span class="n">output</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span><span class="o">+</span><span class="s1">&#39;, &#39;</span>
                                                            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                                        <span class="k">except</span><span class="p">:</span>
                                                            <span class="n">sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; =&#39;</span><span class="o">+</span> <span class="n">output</span>

                                                <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; WHERE id_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_local</span><span class="p">)</span>
                                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;conflit, final :&#39;</span><span class="o">+</span><span class="n">output</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>





                    <span class="c1">#Deal with the tc tables</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span> <span class="ow">and</span> <span class="s1">&#39;id_tcobjet&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Export de la table : &quot;</span><span class="o">+</span><span class="n">dbname</span><span class="p">)</span>
                        <span class="n">fields_to_import</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                        <span class="c1">#Une tc ne sera pas modifiee, au mieux on ajoute des choses dedans</span>
                        <span class="c1">#We select the data</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT &#39;</span><span class="o">+</span>  <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields_to_import</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; FROM &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                            <span class="n">local_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                        <span class="k">except</span> <span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error query&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">None</span>

                        <span class="n">original_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>




                        <span class="c1">#compare the datasets</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">local_data</span> <span class="p">:</span>
                            <span class="n">id_item</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id_&#39;</span><span class="o">+</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;item : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>


                            <span class="c1">#Get the proper id to use when updating the database</span>
                            <span class="n">pos</span><span class="o">=</span><span class="mi">0</span>
                            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                                <span class="n">pos</span><span class="o">+=</span><span class="mi">1</span>

                                <span class="k">if</span> <span class="s1">&#39;id_tc&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
                                    <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">switch_id</span> <span class="p">:</span>
                                    <span class="k">for</span> <span class="n">tuple_coresp</span> <span class="ow">in</span> <span class="n">switch_id</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="p">:</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NULL&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">tuple_coresp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]):</span>
                                                    <span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">tuple_coresp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                    <span class="k">break</span>
                                            <span class="k">except</span><span class="p">:</span>
                                                <span class="k">pass</span>



                            <span class="n">new</span><span class="o">=</span><span class="kc">True</span>
                            <span class="k">for</span> <span class="n">local</span> <span class="ow">in</span> <span class="n">original_data</span><span class="p">:</span>
                                <span class="n">id_local</span><span class="o">=</span><span class="n">local</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id_&#39;</span><span class="o">+</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>
                                <span class="k">if</span> <span class="n">id_local</span><span class="o">==</span><span class="n">id_item</span><span class="p">:</span>
                                    <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">new</span> <span class="p">:</span>
                                <span class="n">output</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span>
                                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span> <span class="p">:</span>
                                    <span class="n">output</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                    <span class="n">str_test</span><span class="o">+=</span><span class="n">toto2</span><span class="o">+</span><span class="s2">&quot;&#39;, &#39;&quot;</span>

                                <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">str_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output : &#39;</span><span class="o">+</span> <span class="n">output</span><span class="p">)</span>

                                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; (&#39;</span><span class="o">+</span>  <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields_to_import</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) VALUES (&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) RETURNING id_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                <span class="n">id_res</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tc_new, sql : &#39;</span><span class="o">+</span><span class="n">sql</span><span class="p">)</span>

                                <span class="n">switch_id</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">+=</span><span class="p">[(</span><span class="n">item</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())],</span><span class="n">id_res</span><span class="p">)]</span>



            <span class="c1">#4) Copy the static files ....................................................................</span>
            <span class="n">local_folder</span><span class="o">=</span><span class="s1">&#39;../local/local_data&#39;</span>
            <span class="k">try</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_folder</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">imagedirectory</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no folder to export the ressources, check imagedirectory&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">horsligne</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">horsligne</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineConn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineCursor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">offLineType</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">importDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">typemetier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;spatialite&#39;</span><span class="p">,</span>
                    <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># postgis</span>
                    <span class="n">dbaseressourcesdirectory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">typeimport</span><span class="o">=</span><span class="s1">&#39;nouvelle&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">actionname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span>
            <span class="c1">#print(actionname,slfile )</span>

            <span class="k">if</span> <span class="n">actionname</span> <span class="o">==</span> <span class="s1">&#39;actionImporter_et_ajouter_la_base&#39;</span><span class="p">:</span>
                <span class="n">typeimport</span> <span class="o">=</span> <span class="s2">&quot;nouvelle&quot;</span>
            <span class="k">elif</span> <span class="n">actionname</span> <span class="o">==</span> <span class="s1">&#39;actionImporter_et_mettre_jour_la_base&#39;</span><span class="p">:</span>
                <span class="n">typeimport</span> <span class="o">=</span> <span class="s2">&quot;import_terrain&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">slfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slfile</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">dbname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">newDBDialog</span><span class="o">.</span><span class="n">comboBox_type</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newDBDialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
            <span class="n">dbasetype</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">variante</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newDBDialog</span><span class="o">.</span><span class="n">dialogIsFinished</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newDBDialog</span><span class="o">.</span><span class="n">comboBox_type</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dbasetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="n">resdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Selectionner le reperoire des ressources&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resdir</span><span class="p">:</span>
                    <span class="n">dbaseressourcesdirectory</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resdir</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resdir</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># create database</span>
            <span class="k">if</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">spatialitefile</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getOpenFileNameAndFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Export vers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;Spatialite (*.sqlite)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">spatialitefile</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Export vers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                                                   <span class="s1">&#39;Spatialite (*.sqlite)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spatialitefile</span><span class="p">:</span>
                    <span class="n">slfile</span> <span class="o">=</span> <span class="n">spatialitefile</span>


            <span class="k">elif</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connDialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
                <span class="n">adresse</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connDialog</span><span class="o">.</span><span class="n">dialogIsFinished</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">adresse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">databaseexists</span><span class="p">,</span> <span class="n">schemaexists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">checkIfPGShcemaExists</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">adresse</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="n">nom</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                                                                                    <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span>  <span class="n">schemaexists</span> <span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;schema existe deja - choisir un autre schema&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="p">(</span><span class="s1">&#39;Creation de la base de donnees...&#39;</span><span class="p">)</span>
                            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">createDbase</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">crsnumber</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;postgis&#39;</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="n">nom</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                                                   <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">adresse</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">dbaseressourcesdirectory</span><span class="o">=</span><span class="n">resdir</span><span class="p">,</span>
                                                   <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">importexportdbase</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">importexportdbase</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">slfile</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="n">dbasetype</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">importDbase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importexportdbase</span><span class="p">,</span><span class="n">typeimport</span> <span class="p">)</span>




    <span class="k">def</span> <span class="nf">exportDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">actionname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span>
            <span class="c1"># print(actionname )</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">spatialitefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Lamia nouveau&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*.sqlite&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">spatialitefile</span><span class="p">,</span> <span class="n">fileext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qfiledlg</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Lamia nouveau&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*.sqlite&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">spatialitefile</span><span class="p">:</span>
            <span class="n">slfile</span> <span class="o">=</span> <span class="n">spatialitefile</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">exportDbase</span><span class="p">(</span><span class="n">slfile</span><span class="p">)</span>





    <span class="k">def</span> <span class="nf">setLoadingProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progressbar</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">progressbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progressbar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Chargement </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">val</span> <span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>



    <span class="k">def</span> <span class="nf">reinitDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#clean eventualy previous dbase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuOutils</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">layerTreeRoot</span><span class="p">()</span>
                <span class="c1">#root.addGroup(&#39;Lamia&#39;)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s2">&quot;spatialite&quot;</span><span class="p">:</span>
                    <span class="n">groupname</span> <span class="o">=</span> <span class="s1">&#39;Lamia_&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s2">&quot;postgis&quot;</span><span class="p">:</span>
                    <span class="n">groupname</span> <span class="o">=</span> <span class="s1">&#39;Lamia_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span>

                <span class="n">lamialegendgroup</span> <span class="o">=</span>  <span class="n">root</span><span class="o">.</span><span class="n">findGroup</span><span class="p">(</span><span class="n">groupname</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lamialegendgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lamialegendgroup</span><span class="o">.</span><span class="n">removeAllChildren</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span><span class="o">.</span><span class="n">removeAllChildren</span><span class="p">()</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">layerTreeRoot</span><span class="p">()</span>
                <span class="n">root</span><span class="o">.</span><span class="n">removeChildNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgislegendnode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">reInitDBase</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setVisualMode</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desktopuiloaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uifields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uidesktop</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uipostpro</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">menuclasses</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">menutools</span> <span class="o">=</span> <span class="p">[]</span>



        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">reInitDBase</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MaintreeWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="c1"># self.dbase = DBaseParser(self.canvas)</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">openTableFieldDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablefielddialog</span><span class="o">.</span><span class="n">dbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablefielddialog</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tablefielddialog</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">NonModal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tablefielddialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tablefielddialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>








    <span class="k">def</span> <span class="nf">tr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;InspectiondigueWindowWidget&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="LoadUiField"><a class="viewcode-back" href="../../../API.html#Lamia.dialog.InspectionDigue_windowwidget.LoadUiField">[docs]</a><span class="k">class</span> <span class="nc">LoadUiField</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="p">):</span>

    <span class="n">finished</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dialog</span> <span class="p">):</span>
        <span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span> <span class="o">=</span> <span class="n">dialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">dbase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uifields</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">uifields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">ElemtreeWidget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span> <span class="o">=</span><span class="n">dialog</span><span class="o">.</span><span class="n">gpsutil</span>

    <span class="k">def</span> <span class="nf">loadUiField</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; start </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if not self.dbase.standalone:</span>
            <span class="n">progressMessageBar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">createMessage</span><span class="p">(</span><span class="s2">&quot;Loading widget...&quot;</span><span class="p">)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">()</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span><span class="p">)</span>
            <span class="n">progressMessageBar</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>
            <span class="n">lenuifields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uifields</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">lenuifields</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">uifield</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uifields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; start </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">uifield</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
            <span class="c1"># try:</span>
            <span class="n">dbasename</span> <span class="o">=</span> <span class="n">uifield</span><span class="o">.</span><span class="n">dbasetablename</span>
            <span class="c1"># print(dbasename)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbasename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uifield</span><span class="p">(</span><span class="n">dbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="p">,</span>
                                                                  <span class="n">dialog</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                                  <span class="n">linkedtreewidget</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ElemtreeWidget</span><span class="p">,</span>
                                                                  <span class="n">gpsutil</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gpsutil</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debugtime</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; end </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">uifield</span><span class="o">.</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>  <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setLoadingProgressBar</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="c1"># except Exception as e:</span>
            <span class="c1">#     print(&#39;error load&#39;, e)</span>

        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">clearWidgets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>



</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Artelia

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>