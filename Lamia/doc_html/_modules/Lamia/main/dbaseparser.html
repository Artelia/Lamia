

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lamia.main.DBaseParser &mdash; Documentation LAMIA 1.0</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> LAMIA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../D_marche_g_n_rale__license.html">Démarche générale, license</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tutoriel.html">Tutoriel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developpement.html">Developpement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">LAMIA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Code du module</a> &raquo;</li>
        
      <li>Lamia.main.DBaseParser</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Code source de Lamia.main.DBaseParser</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file is part of LAMIA.</span>

<span class="sd">    LAMIA is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    LAMIA is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with Foobar.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  * Copyright (c) 2017-2020 ARTELIA Commit &lt;lamia@arteliagroup.com&gt;</span>
<span class="sd">  * </span>
<span class="sd">  * SPDX-License-Identifier: GPL-3.0-or-later</span>
<span class="sd">  * License-Filename: LICENSING.md</span>
<span class="sd"> &quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">qgis</span>
<span class="kn">import</span> <span class="nn">qgis.utils</span>
<span class="kn">from</span> <span class="nn">qgis.PyQt</span> <span class="k">import</span> <span class="n">QtCore</span>

<span class="k">if</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">uninstallErrorHook</span><span class="p">()</span>     <span class="c1">#for standart output</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyspatialite</span> <span class="k">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">db</span>
    <span class="kn">from</span> <span class="nn">pyspatialite.dbapi2</span> <span class="k">import</span> <span class="o">*</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sqlite3</span>
    <span class="kn">from</span> <span class="nn">sqlite3</span> <span class="k">import</span> <span class="o">*</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">qgis.PyQt.QtGui</span> <span class="k">import</span> <span class="p">(</span><span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QProgressBar</span><span class="p">,</span> <span class="n">QApplication</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">qgis.PyQt.QtWidgets</span> <span class="k">import</span> <span class="p">(</span><span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QProgressBar</span><span class="p">,</span> <span class="n">QApplication</span> <span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">PIL</span>
    <span class="kn">import</span> <span class="nn">PIL.Image</span>
    <span class="n">PILexists</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">PILexists</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">psycopg2</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">datetime</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..libs</span> <span class="k">import</span> <span class="n">xlrd</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">xlrd</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">..libs</span> <span class="k">import</span> <span class="n">xlrd</span>




<div class="viewcode-block" id="DBaseParser"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser">[docs]</a><span class="k">class</span> <span class="nc">DBaseParser</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the database parser</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># recentDBaseChanged = QtCore.pyqtSignal()</span>
    <span class="n">dBaseLoaded</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">errorMessage</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">normalMessage</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">errorquerymessage</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">pgtypetosltype</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;VARCHAR&#39;</span> <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;INT&#39;</span> <span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;SERIAL PRIMARY KEY&#39;</span> <span class="p">:</span> <span class="s1">&#39;INTEGER PRIMARY KEY AUTOINCREMENT&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;TIMESTAMP&#39;</span> <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;TEXT&#39;</span> <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;TIMESTAMP WITH TIME ZONE&#39;</span> <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;REAL&#39;</span><span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;NUMERIC&#39;</span><span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;BOOLEAN&#39;</span> <span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">}</span>



    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">canvas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init func</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># ?? temp variable for export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureaddedid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># the dictionnary of dbase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagedirectory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#:visual mode used in ui</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualmode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># dabse type Digue Assainissement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># spatialite or postgis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pghost</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pguser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#  working dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variante</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variantespossibles</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1">#  not used yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchbuffer</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="c1"># used to define the working date in db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workingdate</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">currentDate</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span>

        <span class="c1"># crs of dbase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qgiscrs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># gps things</span>
        <span class="c1"># self.hauteurperche = 2.0</span>
        <span class="c1"># the current prestation id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentprestationid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># connextion var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># spatialite connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SLITEcursor</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># spatialite cursor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span> <span class="o">=</span> <span class="kc">None</span>        <span class="c1"># postgis connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># postgis cursor</span>
        <span class="c1"># spatialite spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># postgis spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horsligne</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_deconnexion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offLineConn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offLineCursor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pghost</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pguser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgport</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># the qgis canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas</span>
        <span class="c1"># self.canvas.renderStarting.connect(self.renderStarts)</span>
        <span class="c1"># the QgsCoordinateTransform var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xform</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xformreverse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># debug</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> -- </span><span class="si">%(name)s</span><span class="s2"> -- </span><span class="si">%(levelname)s</span><span class="s2"> -- </span><span class="si">%(funcName)s</span><span class="s2"> -- </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>             <span class="c1"># DEBUG INFO WARNING</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream_handler</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;popo&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># dbase version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># dbase version</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forcenocommit</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xlsreader</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#self._readRecentDBase()</span>

        <span class="c1"># getqgisversion : ex : 21820</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># qgis 3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span>


<div class="viewcode-block" id="DBaseParser.checkIfPGShcemaExists"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.checkIfPGShcemaExists">[docs]</a>    <span class="k">def</span> <span class="nf">checkIfPGShcemaExists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>



        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param dbname:</span>
<span class="sd">        :param schema:</span>
<span class="sd">        :param user:</span>
<span class="sd">        :param host:</span>
<span class="sd">        :param password:</span>
<span class="sd">        :return: tuple (database exists, schema exists)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># connexion</span>
        <span class="n">connectstr</span> <span class="o">=</span> <span class="s2">&quot;dbname=&#39;postgres&#39; user=&#39;&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;&#39; host=&#39;&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&quot;&#39; password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="n">connpgis</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connectstr</span><span class="p">)</span>
        <span class="n">pgiscursor</span> <span class="o">=</span> <span class="n">connpgis</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># database</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT  datname FROM pg_database WHERE datistemplate = false;&quot;</span>
        <span class="n">pgiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">pgiscursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dbname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">pgiscursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connpgis</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># connexion to database</span>
        <span class="n">connectstr</span> <span class="o">=</span> <span class="s2">&quot;dbname=&#39;&quot;</span> <span class="o">+</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s2">&quot;&#39; user=&#39;&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;&#39; host=&#39;&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&quot;&#39; password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="n">connpgis</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connectstr</span><span class="p">)</span>
        <span class="n">pgiscursor</span> <span class="o">=</span> <span class="n">connpgis</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># schema</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select * from pg_namespace&quot;</span>
        <span class="n">pgiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">pgiscursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="c1"># query = self.query(sql)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
        <span class="n">pgiscursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connpgis</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DBaseParser.createDbase"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.createDbase">[docs]</a>    <span class="k">def</span> <span class="nf">createDbase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">worktype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;spatialite&#39;</span><span class="p">,</span>
                    <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># postgis</span>
                    <span class="n">dbaseressourcesdirectory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">variante</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pass</span>
<span class="sd">        :param slfile:</span>
<span class="sd">        :param crs:</span>
<span class="sd">        :param worktype:</span>
<span class="sd">        :param dbasetype:</span>
<span class="sd">        :param dbname:</span>
<span class="sd">        :param schema:</span>
<span class="sd">        :param user:</span>
<span class="sd">        :param host:</span>
<span class="sd">        :param port:</span>
<span class="sd">        :param password:</span>
<span class="sd">        :param dbaseressourcesdirectory:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;started&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variante</span> <span class="o">=</span> <span class="n">variante</span>
        <span class="c1"># create dbasedict</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlsreader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary</span><span class="p">(</span><span class="n">worktype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="n">worktype</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># manage ressource directory</span>
            <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">dbaseressourcesdirectory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">slfile</span><span class="p">),</span> <span class="sa">u</span><span class="s1">&#39;DBspatialite&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="n">dbaseressourcesdirectory</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">)</span>
                <span class="n">configdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">configdir</span><span class="p">)</span>
                <span class="c1">#tool dir</span>
                <span class="n">dbasedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span><span class="s1">&#39;dbase&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dbasedir</span><span class="p">)</span>
                <span class="n">rapportdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span><span class="s1">&#39;rappporttools&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">rapportdir</span><span class="p">)</span>
                <span class="n">styledir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span><span class="s1">&#39;styles&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">styledir</span><span class="p">)</span>
                <span class="n">importdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span><span class="s1">&#39;importtools&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">importdir</span><span class="p">)</span>

        <span class="c1"># dbaseressourcesdirectorytemp = dbaseressourcesdirectory</span>
        <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createRessourcesDir</span><span class="p">(</span><span class="n">dbasetype</span><span class="p">,</span> <span class="n">dbaseressourcesdirectory</span><span class="p">,</span> <span class="n">slfile</span><span class="o">=</span><span class="n">slfile</span><span class="p">)</span>


        <span class="c1"># sql file contains output of dbase creation script</span>
        <span class="n">sqlfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">,</span> <span class="s1">&#39;sqlcreation.txt&#39;</span><span class="p">)</span>
        <span class="n">openedsqlfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sqlfile</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="c1"># dbasetype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">=</span> <span class="n">dbasetype</span>

        <span class="c1"># ***************************************************************************************</span>
        <span class="c1"># Manage connection - creation and config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>

            <span class="n">originalfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;DBASE&#39;</span><span class="p">,</span> <span class="s1">&#39;sqlite_base&#39;</span><span class="p">,</span> <span class="s1">&#39;DBase_ind0.sqlite&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">originalfile</span><span class="p">,</span> <span class="n">slfile</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span> <span class="o">=</span> <span class="n">slfile</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">slfile</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>   <span class="c1"># python 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">spatialite_connect</span><span class="p">(</span><span class="n">slfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SLITEcursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span>
            <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">=</span> <span class="s1">&#39;postgis&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pghost</span> <span class="o">=</span> <span class="n">host</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="o">=</span> <span class="n">dbname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pguser</span> <span class="o">=</span> <span class="n">user</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span> <span class="o">=</span> <span class="n">password</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgport</span> <span class="o">=</span> <span class="n">port</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">=</span> <span class="n">schema</span>
            <span class="c1"># connexion</span>
            <span class="c1"># connect to postgres for checking database existence</span>
            <span class="n">connectstr</span> <span class="o">=</span> <span class="s2">&quot;dbname=&#39;postgres&#39; user=&#39;&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;&#39; host=&#39;&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&quot;&#39; password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">connpgis</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connectstr</span><span class="p">)</span>
            <span class="n">pgiscursor</span> <span class="o">=</span> <span class="n">connpgis</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">connpgis</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># database</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT  datname FROM pg_database WHERE datistemplate = false;&quot;</span>
            <span class="n">pgiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">pgiscursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="c1"># self.errorMessage.emit(&#39;Base de donnees deja existante&#39;)</span>
                <span class="n">pgiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;CREATE DATABASE DIGUE&#39;</span><span class="p">)</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;Select * FROM pg_extension&quot;</span>
            <span class="n">pgiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">pgiscursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;postgis&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;CREATE EXTENSION postgis&#39;</span>
                <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">pgiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">connpgis</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pgiscursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">connpgis</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># connexion to database</span>
            <span class="n">connectstr</span> <span class="o">=</span> <span class="s2">&quot;dbname=&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="o">+</span> <span class="s2">&quot;&#39; user=&#39;&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;&#39; host=&#39;&quot;</span> <span class="o">+</span> <span class="n">host</span>
            <span class="n">connectstr</span> <span class="o">+=</span> <span class="s2">&quot;&#39; password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connectstr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c1"># schema</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM pg_namespace&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;DROP SCHEMA &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">+</span> <span class="s1">&#39; CASCADE&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;CREATE SCHEMA &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span>
            <span class="c1"># res = self.PGiscursor.execute(sql)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SET search_path TO &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">+</span> <span class="s1">&#39;,public&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># res = self.PGiscursor.execute(sql)</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;GRANT ALL ON SCHEMA &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="o">+</span><span class="s1">&#39; TO vadjango&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># ***************************************************************************************</span>
        <span class="c1"># Tables creation</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generateSpatialiteCreationSQL</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">],</span> <span class="n">crs</span><span class="p">)</span>
                        <span class="c1"># print(sql[&#39;main&#39;])</span>
                        <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generatePostGisCreationSQL</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">],</span> <span class="n">crs</span><span class="p">)</span>
                        <span class="c1"># print(sql[&#39;main&#39;])</span>
                        <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sql : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;other&#39;</span> <span class="ow">in</span> <span class="n">sql</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">sqlother</span> <span class="ow">in</span> <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]:</span>
                            <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sqlother</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="c1"># print(sqlother)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqlother</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dbaseressourcesdirectory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">dbaseressourcesdirectorytemp2</span> <span class="o">=</span> <span class="s1">&#39;.//DBspatialite&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbaseressourcesdirectorytemp2</span> <span class="o">=</span> <span class="n">dbaseressourcesdirectorytemp</span>



        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">versionsql</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Basedonnees (metier,repertoireressources,crs, version) &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;VALUES(&#39;&quot;</span> <span class="o">+</span> <span class="n">worktype</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="n">dbaseressourcesdirectorytemp2</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">versionsql</span> <span class="o">+</span> <span class="s2">&quot;);&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">versionsql</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">workversionsql</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variante</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">variantesql</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">variantesql</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">variante</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Basedonnees (metier,repertoireressources,crs, version, workversion, variante) &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;VALUES(&#39;&quot;</span> <span class="o">+</span> <span class="n">worktype</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="n">dbaseressourcesdirectorytemp2</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">versionsql</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">workversionsql</span> <span class="o">+</span>  <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">variantesql</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
            <span class="c1"># datecreation = QtCore.QDate.fromString(str(datetime.date.today()), &#39;yyyy-MM-dd&#39;).toString(&#39;yyyy-MM-dd&#39;)</span>
            <span class="n">datecreation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Revision (datetimerevision, commentaire) &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;VALUES(&#39;&quot;</span> <span class="o">+</span> <span class="n">datecreation</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;Premiere version &#39;);&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># ***************************************************************************************</span>
        <span class="c1"># view creation</span>
        <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;view creation : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dbname</span><span class="p">)</span>
            <span class="n">viewnames</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;djangoviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">viewnames</span><span class="p">[</span><span class="s1">&#39;djangoviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_django&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span> <span class="ow">and</span> <span class="s1">&#39;qgisSLviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">viewnames</span><span class="p">[</span><span class="s1">&#39;qgisSLviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span> <span class="ow">and</span> <span class="s1">&#39;qgisPGviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">viewnames</span><span class="p">[</span><span class="s1">&#39;qgisPGviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;qgisviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">viewnames</span><span class="p">[</span><span class="s1">&#39;qgisviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;exportviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">viewnames</span><span class="p">[</span><span class="s1">&#39;exportviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_export&#39;</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idexpo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;exportviewsql&#39;</span><span class="p">]):</span>
                        <span class="n">viewnames</span><span class="p">[</span><span class="s1">&#39;exportviewsql&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_export&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">viewname</span> <span class="ow">in</span> <span class="n">viewnames</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="c1"># sql = &#39;CREATE VIEW &#39; + str(dbname) + &#39;_view AS &#39;</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;CREATE VIEW &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">viewnames</span><span class="p">[</span><span class="n">viewname</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; AS &#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="n">viewname</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="n">viewname</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39;SELECT * FROM &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
                <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="c1"># add view in geom register</span>
                <span class="c1">#if &#39;geom&#39; in self.dbasetables[dbname].keys():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="n">viewnames</span><span class="p">[</span><span class="n">viewname</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                        <span class="n">dbnamelower</span> <span class="o">=</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">idcolumnname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFirstIdColumn</span><span class="p">(</span><span class="n">viewnames</span><span class="p">[</span><span class="n">viewname</span><span class="p">])</span>
                        <span class="n">viewlower</span> <span class="o">=</span> <span class="n">viewnames</span><span class="p">[</span><span class="n">viewname</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO views_geometry_columns (view_name, view_geometry, view_rowid, &quot;</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;f_table_name, f_geometry_column,read_only)&quot;</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; VALUES (&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">viewlower</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;geom&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="n">idcolumnname</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbnamelower</span><span class="p">)</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;&#39;,&#39;geom&#39;,0)&quot;</span>
                        <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                        <span class="n">dbnamelower</span> <span class="o">=</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">idcolumnname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFirstIdColumn</span><span class="p">(</span><span class="n">viewnames</span><span class="p">[</span><span class="n">viewname</span><span class="p">])</span>
                        <span class="n">viewlower</span> <span class="o">=</span> <span class="n">viewnames</span><span class="p">[</span><span class="n">viewname</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO geometry_columns(f_table_catalog, f_table_schema, f_table_name, &#39;</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39;f_geometry_column, coord_dimension, srid, &quot;type&quot;) VALUES (&#39;</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">worktype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">viewlower</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;geom&#39;,2,&quot;</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39; );&quot;</span>
                        <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="c1">#spatialindex</span>
            <span class="k">if</span> <span class="s1">&#39;spatialindex&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT CreateSpatialIndex(&#39;&quot;</span> <span class="o">+</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;geom&#39;)&quot;</span>
                    <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sql</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>



        <span class="n">openedsqlfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>



        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">loadQgisVectorLayers</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span><span class="p">,</span>
                                      <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pghost</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pgport</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span>
                                      <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pguser</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">connectToDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># postgis</span>
                    <span class="p">):</span>
        <span class="c1"># Manage connection - creation and config</span>
        <span class="k">if</span> <span class="n">slfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">=</span> <span class="s1">&#39;postgis&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">=</span> <span class="s1">&#39;spatialite&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span> <span class="o">=</span> <span class="n">slfile</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">slfile</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># python 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">dbapi2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">slfile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span><span class="o">.</span><span class="n">enable_load_extension</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT load_extension(&#39;mod_spatialite&#39;)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SLITEcursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">=</span> <span class="s1">&#39;postgis&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pghost</span> <span class="o">=</span> <span class="n">host</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="o">=</span> <span class="n">dbname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pguser</span> <span class="o">=</span> <span class="n">user</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span> <span class="o">=</span> <span class="n">password</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgport</span> <span class="o">=</span> <span class="n">port</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">=</span> <span class="n">schema</span>
            <span class="c1"># connexion</span>
            <span class="c1"># connect to postgres for checking database existence</span>
            <span class="n">connectstr</span> <span class="o">=</span> <span class="s2">&quot;dbname=&#39;postgres&#39; user=&#39;&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;&#39; host=&#39;&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&quot;&#39; password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">connpgis</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connectstr</span><span class="p">)</span>
            <span class="n">pgiscursor</span> <span class="o">=</span> <span class="n">connpgis</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">connpgis</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># connexion to database</span>
            <span class="n">connectstr</span> <span class="o">=</span> <span class="s2">&quot;dbname=&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="o">+</span> <span class="s2">&quot;&#39; user=&#39;&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;&#39; host=&#39;&quot;</span> <span class="o">+</span> <span class="n">host</span>
            <span class="n">connectstr</span> <span class="o">+=</span> <span class="s2">&quot;&#39; password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connectstr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>



    <span class="k">def</span> <span class="nf">createRessourcesDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbasetype</span><span class="p">,</span> <span class="n">dbaseressourcesdirectory</span><span class="p">,</span> <span class="n">slfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">dbaseressourcesdirectory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">slfile</span><span class="p">),</span> <span class="sa">u</span><span class="s1">&#39;DBspatialite&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbaseressourcesdirectorytemp</span> <span class="o">=</span> <span class="n">dbaseressourcesdirectory</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">)</span>
        <span class="n">configdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbaseressourcesdirectorytemp</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">configdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">configdir</span><span class="p">)</span>
        <span class="c1"># tool dir</span>
        <span class="n">dbasedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span> <span class="s1">&#39;dbase&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dbasedir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dbasedir</span><span class="p">)</span>

        <span class="n">rapportdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span> <span class="s1">&#39;rappporttools&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">rapportdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">rapportdir</span><span class="p">)</span>

        <span class="n">styledir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span> <span class="s1">&#39;styles&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">styledir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">styledir</span><span class="p">)</span>

        <span class="n">importdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configdir</span><span class="p">,</span> <span class="s1">&#39;importtools&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">importdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">importdir</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">dbaseressourcesdirectorytemp</span>



<div class="viewcode-block" id="DBaseParser.createDBDictionary2"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.createDBDictionary2">[docs]</a>    <span class="k">def</span> <span class="nf">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">configdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">chekupdate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;!</span>
<span class="sd">        Read the files in ./DBASE/create</span>
<span class="sd">        A file describes the fields  like that:</span>
<span class="sd">        #comment</span>
<span class="sd">        ###Field_name;PG_type;SL_type;Foreignkey_type</span>
<span class="sd">        ## parent field - used for ui - enable to sort the child fields depending the parent field    (optional)</span>
<span class="sd">        constraint value description;constraint value value;[depending parent field value]</span>

<span class="sd">        And fill the var self.dbasetables which is a dictionnary like that :</span>
<span class="sd">        {...{tablename : {&#39;order&#39; : order,</span>
<span class="sd">                          &#39;geom&#39; : geometry type ,</span>
<span class="sd">                          &#39;widget&#39; : the table widget,</span>
<span class="sd">                          &#39;djangoviewsql&#39; : sql statement for initial django view creation</span>
<span class="sd">                          &#39;qgisviewsql&#39; : sql statement for initial qgis view creation</span>
<span class="sd">                          &#39;qgisSLviewsql&#39; : sql statement for initial qgis view creation - spatialite compatible</span>
<span class="sd">                          &#39;qgisPGviewsql&#39; : sql statement for initial qgis view creation - postgis compatible</span>
<span class="sd">                          &#39;exportviewsql&#39; : sql statement for initial special view creation</span>
<span class="sd">                          &#39;layer&#39; : real layer</span>
<span class="sd">                          &#39;layerqgis&#39; : view layer with parent fields</span>
<span class="sd">                          &#39;layerdjango&#39; : view layer with parent fields</span>
<span class="sd">                          &#39;showinqgis&#39; : display layer in canvas</span>
<span class="sd">                          &#39;scale&#39; : visibility scale</span>
<span class="sd">                          &#39;spatialindex&#39; : create a spatialite spatial index</span>
<span class="sd">                          &#39;fields&#39; : OrderedDict{...{fieldname : {&#39;PGtype&#39; : PostGis type (integer not null...)</span>
<span class="sd">                                                                  &#39;SLtype&#39; : spatialite type (integer not null...)</span>
<span class="sd">                                                                  &#39;FK&#39; (optional) : foreign key definition</span>
<span class="sd">                                                                  &#39;ParFldCst (optional) : name of the parent field for contraint</span>
<span class="sd">                                                                  &#39;Cst&#39; (optional) : list of constraint : [description,value,[parent field consraint value]}</span>
<span class="sd">                                                 ...}</span>

<span class="sd">                          }</span>
<span class="sd">         ...}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;started&#39;</span><span class="p">)</span>



        <span class="c1"># first readfiles in ./DBASE\create directory and create self.dbasetables</span>
        <span class="n">createfilesdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">configdir</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">baseversiontoread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">workversionmax</span><span class="p">,</span> <span class="n">createfilesdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">baseversionmax</span><span class="p">,</span> <span class="n">createfilesdirbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">chekupdate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">baseversionmax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="o">&lt;</span> <span class="n">workversionmax</span><span class="p">))</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">updateDBaseVersion2</span><span class="p">()</span>



                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">baseversionmax</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="o">=</span> <span class="n">workversionmax</span>

                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;baseversion : </span><span class="si">%s</span><span class="s1">, workversion : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="p">))</span>

                <span class="k">if</span> <span class="n">createfilesdirbase</span> <span class="ow">and</span> <span class="n">createfilesdirbase</span> <span class="o">!=</span> <span class="n">createfilesdir</span> <span class="p">:</span>    <span class="c1">#cas de la lecture du bd enfant</span>
                    <span class="n">parsertemp</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">parsertemp</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="n">parsertemp</span><span class="o">.</span><span class="n">dbasetables</span>
                    <span class="k">del</span> <span class="n">parsertemp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">baseversions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">workversions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                <span class="n">baseversionnumbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">baseversions</span><span class="p">]</span>
                <span class="n">workversionnumbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">workversions</span><span class="p">]</span>


                <span class="n">createfilesdirbase</span> <span class="o">=</span> <span class="n">baseversions</span><span class="p">[</span><span class="n">baseversionnumbers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">baseversiontoread</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">createfilesdir</span> <span class="o">=</span> <span class="n">workversions</span><span class="p">[</span><span class="n">workversionnumbers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">workversiontoread</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">createfilesdirbase</span> <span class="o">!=</span> <span class="n">createfilesdir</span><span class="p">:</span>
                    <span class="c1">#createfilesdir = workversions[workversionnumbers.index(workversiontoread)][1]</span>
                    <span class="n">parsertemp</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">parsertemp</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="n">baseversiontoread</span><span class="p">,</span><span class="n">workversiontoread</span><span class="o">=</span><span class="n">baseversiontoread</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="n">parsertemp</span><span class="o">.</span><span class="n">dbasetables</span>
                    <span class="k">del</span> <span class="n">parsertemp</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">createfilesdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="s1">&#39;dbase&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">):</span>
                <span class="k">return</span>



        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;createfilesdir : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">readDbDictionnary</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">)</span></div>



<div class="viewcode-block" id="DBaseParser.readDbDictionnary"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.readDbDictionnary">[docs]</a>    <span class="k">def</span> <span class="nf">readDbDictionnary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vartoread</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param dictfile:</span>
<span class="sd">        :param vartoread:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">dictfile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dictfile</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">xlsbook</span> <span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">dictfile</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sheet</span> <span class="ow">in</span> <span class="n">xlsbook</span><span class="o">.</span><span class="n">sheets</span><span class="p">():</span>
            <span class="n">tablename</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cstcolumntoread</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># print(tablename)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># non table file</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">tablename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tablename</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tablename</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>


            <span class="c1">#print(tablename)</span>
            <span class="c1"># print(self.dbasetables)</span>

            <span class="k">if</span> <span class="n">tablename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;row_variantes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="n">firstqgsviewoccurrence</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>


                <span class="n">firstcol</span> <span class="o">=</span>  <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstcol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">firstcol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>  <span class="c1"># comment - pass</span>
                    <span class="k">if</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#DJAN&#39;</span><span class="p">:</span>
                        <span class="c1">#self.dbasetables[tablename][&#39;djangoviewsql&#39;] = line[5:].strip()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;djangoviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#QGISSL&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;qgisSLviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisSLviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisSLviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#QGISPG&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;qgisPGviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisPGviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisPGviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#QGIS&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">firstqgsviewoccurrence</span><span class="p">:</span>
                            <span class="n">firstqgsviewoccurrence</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                        <span class="k">if</span> <span class="s1">&#39;qgisviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="c1"># self.dbasetables[tablename][&#39;qgisviewsql&#39;] = line[5:].strip()</span>
                    <span class="k">elif</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#EXPO&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;exportviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#SCAL&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#SHOW&#39;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#SPATIALINDEX&#39;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;spatialindex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">firstcol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#VARIANTES&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">colnbr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sheet</span><span class="o">.</span><span class="n">ncols</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">colnbr</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;row_variantes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
                                <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variantespossibles</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">variantespossibles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">colnbr</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>




                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">firstcol</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">fieldname</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">cstcolumntoread</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">fieldname</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">continue</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># the pg type</span>

                        <span class="c1">#self.dbasetables[tablename][&#39;fields&#39;][fieldname][&#39;SLtype&#39;] = linesplit[2].strip()  # the spatialite type</span>
                        <span class="c1"># the foreign key</span>
                        <span class="k">if</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;FK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;ParFldCst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        try:</span>
<span class="sd">                            sheet.cell_value(row, 5).strip()</span>
<span class="sd">                        except :</span>
<span class="sd">                            valetmp = sheet.cell_value(row, 5)</span>
<span class="sd">                            print(valetmp, valetmp.__class__,tablename, fieldname )</span>
<span class="sd">                        &quot;&quot;&quot;</span>

                        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>


                            <span class="k">if</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]]</span>

                            <span class="n">showvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertxlsdataToString</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
                            <span class="n">datavalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertxlsdataToString</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">showvalue</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datavalue</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                            <span class="k">if</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                        <span class="n">cstcolumntoread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readConstraints</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span><span class="n">fieldname</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">cstcolumntoread</span><span class="p">)</span>





                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if fieldname in self.dbasetables[tablename][&#39;fields&#39;].keys():</span>
                        <span class="k">if</span> <span class="n">fieldname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fieldname</span> <span class="o">!=</span> <span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">readConstraints</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span><span class="n">fieldname</span><span class="p">,</span><span class="n">sheet</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span><span class="n">cstcolumntoread</span><span class="p">)</span>

                        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                                <span class="c1"># value = sheet.cell_value(row, 6)</span>
                                <span class="n">showvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertxlsdataToString</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
                                <span class="n">datavalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertxlsdataToString</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">showvalue</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datavalue</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                                <span class="k">if</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>






        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span> <span class="s1">&#39;*.txt&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;filename </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">basename</span> <span class="p">)</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># non table file</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># underscore in the name</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># underscore in the name</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># underscore in the name</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">tablename</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tablename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># self.dbasetables[tablename][&#39;exportviewsql&#39;] = []</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="c1">#file = open(filename, &#39;rb&#39;)</span>
                <span class="n">compt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;###&#39;</span><span class="p">:</span>          <span class="c1"># new field</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">linesplit</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                        <span class="n">fieldname</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fieldname </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fieldname</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">continue</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># the pg type</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;SLtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># the spatialite type</span>
                        <span class="c1"># the foreign key</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;FK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;##&#39;</span><span class="p">:</span>         <span class="c1"># parent field constraint name</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;ParFldCst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>            <span class="c1"># comment - pass</span>
                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#DJAN&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;djangoviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#QGISSL&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;qgisSLviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisSLviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisSLviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#QGISPG&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;qgisPGviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisPGviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisPGviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#QGIS&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;qgisviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="c1"># self.dbasetables[tablename][&#39;qgisviewsql&#39;] = line[5:].strip()</span>
                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#EXPO&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;exportviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#SCAL&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#SHOW&#39;</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#SPATIALINDEX&#39;</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;spatialindex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>


                    <span class="k">else</span><span class="p">:</span>                           <span class="c1"># field constraint</span>
                        <span class="k">if</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]]</span>

                        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">linesplit</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">linesplit</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="c1"># print(line.__class__)</span>
                                <span class="n">linesplit</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                                <span class="c1">#print(type(linesplit[0]))</span>
                                <span class="c1">#linesplit = line.decode(&#39;utf-8&#39;).split(&#39;;&#39;)</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cst line split </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">fieldname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">linesplit</span><span class="p">))</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">compt</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;Revision&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;dbasetables </span><span class="si">%s</span><span class="s1"> : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span></div>


    <span class="k">def</span> <span class="nf">readConstraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span><span class="n">fieldname</span>  <span class="p">,</span><span class="n">sheet</span><span class="p">,</span> <span class="n">xlrow</span><span class="p">,</span><span class="n">cstcolumntoread</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># dbasefield self.dbasetables[tablename][&#39;fields&#39;][fieldname]</span>
        <span class="c1"># print(&#39;readConstraints&#39;,tablename,fieldname  ,sheet, xlrow)</span>
        <span class="n">colindexvariante</span> <span class="o">=</span> <span class="n">cstcolumntoread</span>
        <span class="n">dbasefield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">colindexvariante</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colindexvariante</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variante</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">colindexvariante</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;row_variantes&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">rowvariantes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;row_variantes&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variante</span> <span class="o">==</span><span class="s1">&#39;Lamia&#39;</span><span class="p">:</span>
                        <span class="n">colindexvariante</span> <span class="o">=</span> <span class="mi">5</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">ncols</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowvariantes</span><span class="p">,</span><span class="n">col</span> <span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">variante</span>
                                        <span class="ow">and</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">xlrow</span><span class="p">,</span><span class="n">col</span> <span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="p">):</span>
                                    <span class="n">colindexvariante</span> <span class="o">=</span> <span class="n">col</span>
                                    <span class="c1"># print(&#39;colindexvariante&#39;, tablename, fieldname, colindexvariante)</span>
                                    <span class="k">break</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="n">tablename</span><span class="p">,</span><span class="n">fieldname</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">variante</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">colindexvariante</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">colindexvariante</span> <span class="o">=</span> <span class="mi">5</span>



        <span class="k">if</span> <span class="n">unicode</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">xlrow</span><span class="p">,</span> <span class="n">colindexvariante</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="n">dbasefield</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dbasefield</span><span class="p">[</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbasefield</span><span class="p">[</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]]</span>


            <span class="n">showvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertxlsdataToString</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">xlrow</span><span class="p">,</span> <span class="n">colindexvariante</span><span class="p">))</span>
            <span class="n">datavalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertxlsdataToString</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">xlrow</span><span class="p">,</span> <span class="n">colindexvariante</span> <span class="o">+</span><span class="mi">1</span> <span class="p">))</span>
            <span class="n">dbasefield</span><span class="p">[</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">showvalue</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">dbasefield</span><span class="p">[</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datavalue</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">xlrow</span><span class="p">,</span> <span class="n">colindexvariante</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">dbasefield</span><span class="p">[</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">xlrow</span><span class="p">,</span> <span class="n">colindexvariante</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbasefield</span><span class="p">[</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">colindexvariante</span>


    <span class="k">def</span> <span class="nf">convertxlsdataToString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1">#print(&#39;data0&#39;, data, data.__class__)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1">#print(&#39;data1&#39;, data, data.__class__)</span>
        <span class="k">return</span> <span class="n">data</span>





<div class="viewcode-block" id="DBaseParser.createDBDictionary"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.createDBDictionary">[docs]</a>    <span class="k">def</span> <span class="nf">createDBDictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">configdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;!</span>
<span class="sd">        Read the files in ./DBASE/create</span>
<span class="sd">        A file describes the fields  like that:</span>
<span class="sd">        #comment</span>
<span class="sd">        ###Field_name;PG_type;SL_type;Foreignkey_type</span>
<span class="sd">        ## parent field - used for ui - enable to sort the child fields depending the parent field    (optional)</span>
<span class="sd">        constraint value description;constraint value value;[depending parent field value]</span>

<span class="sd">        And fill the var self.dbasetables which is a dictionnary like that :</span>
<span class="sd">        {...{tablename : {&#39;order&#39; : order,</span>
<span class="sd">                          &#39;geom&#39; : geometry type ,</span>
<span class="sd">                          &#39;widget&#39; : the table widget,</span>
<span class="sd">                          &#39;djangoviewsql&#39; : sql statement for initial django view creation</span>
<span class="sd">                          &#39;qgisviewsql&#39; : sql statement for initial qgis view creation</span>
<span class="sd">                          &#39;qgisSLviewsql&#39; : sql statement for initial qgis view creation - spatialite compatible</span>
<span class="sd">                          &#39;qgisPGviewsql&#39; : sql statement for initial qgis view creation - postgis compatible</span>
<span class="sd">                          &#39;exportviewsql&#39; : sql statement for initial special view creation</span>
<span class="sd">                          &#39;layer&#39; : real layer</span>
<span class="sd">                          &#39;layerqgis&#39; : view layer with parent fields</span>
<span class="sd">                          &#39;layerdjango&#39; : view layer with parent fields</span>
<span class="sd">                          &#39;showinqgis&#39; : display layer in canvas</span>
<span class="sd">                          &#39;scale&#39; : visibility scale</span>
<span class="sd">                          &#39;spatialindex&#39; : create a spatialite spatial index</span>
<span class="sd">                          &#39;fields&#39; : OrderedDict{...{fieldname : {&#39;PGtype&#39; : PostGis type (integer not null...)</span>
<span class="sd">                                                                  &#39;SLtype&#39; : spatialite type (integer not null...)</span>
<span class="sd">                                                                  &#39;FK&#39; (optional) : foreign key definition</span>
<span class="sd">                                                                  &#39;ParFldCst (optional) : name of the parent field for contraint</span>
<span class="sd">                                                                  &#39;Cst&#39; (optional) : list of constraint : [description,value,[parent field consraint value]}</span>
<span class="sd">                                                 ...}</span>

<span class="sd">                          }</span>
<span class="sd">         ...}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;started&#39;</span><span class="p">)</span>



        <span class="c1"># first readfiles in ./DBASE\create directory and create self.dbasetables</span>
        <span class="n">createfilesdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">configdir</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">baseversiontoread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">createfilesdir</span><span class="p">,</span> <span class="n">workversionmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxVersionRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                <span class="n">createfilesdirbase</span><span class="p">,</span> <span class="n">baseversionmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxVersionRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>



                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">baseversionmax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="o">&lt;</span> <span class="n">workversionmax</span><span class="p">))</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">updateDBaseVersion</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">baseversionmax</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="o">=</span> <span class="n">workversionmax</span>

                <span class="k">if</span> <span class="n">createfilesdirbase</span> <span class="ow">and</span> <span class="n">createfilesdirbase</span> <span class="o">!=</span> <span class="n">createfilesdir</span> <span class="p">:</span>    <span class="c1">#cas de la lecture du bd enfant</span>
                    <span class="n">parsertemp</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">parsertemp</span><span class="o">.</span><span class="n">createDBDictionary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="n">parsertemp</span><span class="o">.</span><span class="n">dbasetables</span>
                    <span class="k">del</span> <span class="n">parsertemp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">createfilesdir</span><span class="p">,</span> <span class="n">workversionmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxVersionRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                <span class="n">createfilesdirbase</span><span class="p">,</span> <span class="n">baseversionmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxVersionRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>


                <span class="n">createfilesdirbase</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">),</span>  <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">baseversiontoread</span><span class="p">)</span>
                <span class="n">createfilesdir</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">workversiontoread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">createfilesdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">createfilesdirbase</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">workversiontoread</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">createfilesdirbase</span> <span class="ow">and</span> <span class="n">createfilesdirbase</span> <span class="o">!=</span> <span class="n">createfilesdir</span> <span class="p">:</span>    <span class="c1">#cas de la lecture du bd enfant</span>
                    <span class="n">parsertemp</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">parsertemp</span><span class="o">.</span><span class="n">createDBDictionary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="n">baseversiontoread</span><span class="p">,</span><span class="n">workversiontoread</span><span class="o">=</span><span class="n">baseversiontoread</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="n">parsertemp</span><span class="o">.</span><span class="n">dbasetables</span>
                    <span class="k">del</span> <span class="n">parsertemp</span>




        <span class="k">else</span><span class="p">:</span>
            <span class="n">createfilesdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="s1">&#39;dbase&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">):</span>
                <span class="k">return</span>


        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span> <span class="s1">&#39;*.txt&#39;</span><span class="p">)):</span>

            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;filename </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">basename</span> <span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># non table file</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># underscore in the name</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># underscore in the name</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># underscore in the name</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;_&#39;</span>
                <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">tablename</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tablename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># self.dbasetables[tablename][&#39;exportviewsql&#39;] = []</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="c1">#file = open(filename, &#39;rb&#39;)</span>
            <span class="n">compt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;###&#39;</span><span class="p">:</span>          <span class="c1"># new field</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">linesplit</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                    <span class="n">fieldname</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fieldname </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fieldname</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># the pg type</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;SLtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># the spatialite type</span>
                    <span class="c1"># the foreign key</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;FK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linesplit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;##&#39;</span><span class="p">:</span>         <span class="c1"># parent field constraint name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;ParFldCst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>            <span class="c1"># comment - pass</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#DJAN&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;djangoviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#QGISSL&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;qgisSLviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisSLviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisSLviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#QGISPG&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;qgisPGviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisPGviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisPGviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#QGIS&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;qgisviewsql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisviewsql&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;qgisviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="c1"># self.dbasetables[tablename][&#39;qgisviewsql&#39;] = line[5:].strip()</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#EXPO&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;exportviewsql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#SCAL&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#SHOW&#39;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#SPATIALINDEX&#39;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;spatialindex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>


                <span class="k">else</span><span class="p">:</span>                           <span class="c1"># field constraint</span>
                    <span class="k">if</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]]</span>

                    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">linesplit</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">linesplit</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="c1"># print(line.__class__)</span>
                            <span class="n">linesplit</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                            <span class="c1">#print(type(linesplit[0]))</span>
                            <span class="c1">#linesplit = line.decode(&#39;utf-8&#39;).split(&#39;;&#39;)</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cst line split </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">fieldname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">linesplit</span><span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fieldname</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">compt</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;Revision&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span> <span class="o">=</span> <span class="kc">True</span></div>






    <span class="k">def</span> <span class="nf">_generateSpatialiteCreationSQL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dbasetable</span><span class="p">,</span> <span class="n">crs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;!</span>
<span class="sd">        generate sql for creating Spatialite table</span>

<span class="sd">        @param name : name of the table to be created</span>
<span class="sd">        @param dbasetable : value linked with created table in self.dbasetables</span>
<span class="sd">        @param crs : crs used (int)</span>

<span class="sd">        @return sql{&#39;main&#39; : the create table sentence, &#39;other&#39; : [list of sql sentences to e done after table creation] }</span>

<span class="sd">        main exemple :</span>
<span class="sd">        CREATE TABLE DESCRIPTIONSYSTEME (</span>
<span class="sd">            id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT ,&quot;</span>
<span class="sd">            name TEXT NOT NULL,</span>
<span class="sd">            ObjID INTEGER,</span>
<span class="sd">            FOREIGN KEY(ObjID) REFERENCES OBJECT(id)</span>
<span class="sd">         )</span>
<span class="sd">         other exemple:</span>
<span class="sd">         SELECT AddGeometryColumn(&#39;DESCRIPTIONSYSTEME&#39;,&#39;geom&#39;,2154, &#39;LINESTRING&#39;, &#39;XY&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">listFK</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE &#39;</span>
        <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlsreader</span><span class="p">:</span>
                <span class="n">sltype</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgtypetosltype</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">sltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgtypetosltype</span><span class="p">[</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="s1">&#39;VARCHAR&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]:</span>
                    <span class="n">sltype</span> <span class="o">=</span> <span class="s1">&#39;TEXT&#39;</span>
                <span class="c1"># print(name,key, dbasetable[&#39;fields&#39;][key][&#39;PGtype&#39;], sltype )</span>
                <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sltype</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;SLtype&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;FK&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">listFK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FOREIGN KEY(&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;) REFERENCES &#39;</span> <span class="o">+</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;FK&#39;</span><span class="p">])</span>

        <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">listFK</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;);&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;SELECT AddGeometryColumn(&#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;geom&#39;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span>
                                                          <span class="o">+</span> <span class="s2">&quot;, &#39;&quot;</span> <span class="o">+</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;XY&#39;);&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span>

    <span class="k">def</span> <span class="nf">_generatePostGisCreationSQL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dbasetable</span><span class="p">,</span> <span class="n">crs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;!</span>
<span class="sd">        generate sql for creating Spatialite table</span>

<span class="sd">        @param name : name of the table to be created</span>
<span class="sd">        @param dbasetable : value linked with created table in self.dbasetables</span>
<span class="sd">        @param crs : crs used (int)</span>

<span class="sd">        @return sql{&#39;main&#39; : the create table sentence, &#39;other&#39; : [list of sql sentences to e done after table creation] }</span>

<span class="sd">        main exemple :</span>
<span class="sd">        CREATE TABLE DESCRIPTIONSYSTEME (</span>
<span class="sd">            id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT ,&quot;</span>
<span class="sd">            name TEXT NOT NULL,</span>
<span class="sd">            ObjID INTEGER,</span>
<span class="sd">            FOREIGN KEY(ObjID) REFERENCES OBJECT(id)</span>
<span class="sd">         )</span>
<span class="sd">         other exemple:</span>
<span class="sd">         SELECT AddGeometryColumn(&#39;DESCRIPTIONSYSTEME&#39;,&#39;geom&#39;,2154, &#39;LINESTRING&#39;, &#39;XY&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">listFK</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE &#39;</span>
        <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>
            <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;FK&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; REFERENCES &#39;</span> <span class="o">+</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;FK&#39;</span><span class="p">]</span>
            <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span>

        <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;);&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sql</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">name</span>
                                <span class="o">+</span> <span class="s2">&quot; ADD  COLUMN   geom geometry(&#39;&quot;</span> <span class="o">+</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;);&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sql</span>


<div class="viewcode-block" id="DBaseParser.loadQgisVectorLayers"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.loadQgisVectorLayers">[docs]</a>    <span class="k">def</span> <span class="nf">loadQgisVectorLayers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbasetype</span><span class="o">=</span><span class="s1">&#39;spatialite&#39;</span><span class="p">,</span> <span class="n">variante</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;!</span>
<span class="sd">        Load dbase as Qgis layers</span>
<span class="sd">        put the layer in self.dbasetables[&#39;layer&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">=</span> <span class="n">dbasetype</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span> <span class="ow">and</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span> <span class="o">=</span> <span class="n">file</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">spatialite_connect</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">SLITEcursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>


        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span>
              <span class="ow">and</span> <span class="n">host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dbname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
              <span class="ow">and</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pghost</span> <span class="o">=</span> <span class="n">host</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="o">=</span> <span class="n">dbname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pguser</span> <span class="o">=</span> <span class="n">user</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span> <span class="o">=</span> <span class="n">password</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgport</span> <span class="o">=</span> <span class="n">port</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">=</span> <span class="n">schema</span>
            <span class="n">connectstr</span> <span class="o">=</span> <span class="s2">&quot;dbname=&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span> <span class="o">+</span> <span class="s2">&quot;&#39; user=&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pguser</span> <span class="o">+</span> <span class="s2">&quot;&#39; host=&#39;&quot;</span>
            <span class="n">connectstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pghost</span> <span class="o">+</span> <span class="s2">&quot;&#39; password=&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connectstr</span><span class="p">)</span>
            <span class="c1">#self.connPGis.autocommit = True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SET search_path TO &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span> <span class="o">+</span> <span class="s1">&#39;,public&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step1&#39;</span><span class="p">)</span>

        <span class="c1"># self._AddDbaseInRecentsDBase(spatialitefile=file, host=host, port=port, dbname=dbname, schema=schema, user=user,password=password)</span>
        <span class="c1"># self.reInitDBase()</span>

        <span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">workversion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">variante</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT metier, repertoireressources,crs, version   FROM Basedonnees;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="nb">type</span><span class="p">,</span> <span class="n">resdir</span><span class="p">,</span> <span class="n">crs</span> <span class="p">,</span> <span class="n">version</span>  <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT  workversion  FROM Basedonnees;&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">workversion</span>  <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT  variante  FROM Basedonnees;&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">variante</span>  <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        except:</span>
<span class="sd">            sql = &quot;SELECT metier, repertoireressources,crs, version FROM Basedonnees;&quot;</span>
<span class="sd">            query = self.query(sql)</span>
<span class="sd">            type, resdir, crs , version= [row[0:4] for row in query][0]</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="n">resdir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span> <span class="p">),</span> <span class="n">resdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">resdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span> <span class="o">=</span> <span class="n">crs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qgiscrs</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsCoordinateReferenceSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="o">=</span> <span class="n">workversion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variante</span> <span class="o">=</span> <span class="n">variante</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">resdir</span><span class="p">,</span> <span class="n">crs</span> <span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">workversion</span><span class="p">,</span> <span class="n">variante</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createRessourcesDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step2&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlsreader</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">configdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">configdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>





            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT MAX(pk_revision) FROM Revision;&quot;</span>
                <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;rev : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span> <span class="p">)</span>


            <span class="c1"># create a list of tables to load</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">listoftabletoload</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="p">:</span>
                        <span class="n">listoftabletoload</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tablename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;geom&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">listoftabletoload</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tablename</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

            <span class="c1"># load the table as qgsvectorlayer</span>
            <span class="c1">#for tablename, geom in listoftabletoload:</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsDataSourceURI</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsDataSourceUri</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                    <span class="n">uri</span><span class="o">.</span><span class="n">setDatabase</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                    <span class="c1"># raw layer</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="n">tablename</span><span class="p">):</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="s1">&#39;geom&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">)</span>

                    <span class="c1"># view layer qgis</span>

                    <span class="c1">#get id column</span>
                    <span class="n">idcolumnname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFirstIdColumn</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">)</span>
                    <span class="c1"># print(&#39;***&#39;, tablename + &#39;_qgis&#39; , idcolumnname)</span>
                    <span class="c1">#if sys.version_info.major == 2:       #bug on qgis 3</span>
                    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_qgis&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="s1">&#39;spatialindex&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>    <span class="c1">#qis 3 bug</span>
                                <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;(SELECT * FROM &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis)&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">idcolumnname</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">idcolumnname</span><span class="p">)</span>

                            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;spatialindex&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                    <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">idcolumnname</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1">#uri.setDataSource(&#39;&#39;, str(tablename)+&#39;_qgis&#39;, &#39;geom&#39;, &#39;&#39;, &quot;id_&quot; + str(tablename).lower())</span>
                                    <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">idcolumnname</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1">#uri.setDataSource(&#39;&#39;, str(tablename) + &#39;_qgis&#39;, &#39;&#39;, &#39;&#39;, &quot;id_&quot; + str(tablename).lower())</span>
                            <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">idcolumnname</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">)</span>


                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">):</span>
                                <span class="c1"># uri.setDataSource(&#39;&#39;, str(tablename)+&#39;_qgis&#39;, &#39;geom&#39;, &#39;&#39;, &quot;id_&quot; + str(tablename).lower())</span>
                                <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;(SELECT * FROM &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis)&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">idcolumnname</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># uri.setDataSource(&#39;&#39;, str(tablename) + &#39;_qgis&#39;, &#39;&#39;, &#39;&#39;, &quot;id_&quot; + str(tablename).lower())</span>
                                <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;(SELECT * FROM &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">idcolumnname</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span>
                                                                                                <span class="s1">&#39;spatialite&#39;</span><span class="p">)</span>

                    <span class="c1"># view layer django</span>
                    <span class="n">idcolumnname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFirstIdColumn</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_django&#39;</span><span class="p">)</span>
                    <span class="c1"># print(&#39;***&#39;, tablename+ &#39;_django&#39; , idcolumnname)</span>

                    <span class="c1">#if geom is not None:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_django&#39;</span><span class="p">):</span>
                        <span class="c1">#uri.setDataSource(&#39;&#39;, str(tablename)+&#39;_django&#39;, &#39;geom&#39;, &#39;&#39;, &quot;id_&quot; + str(tablename).lower())</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_django&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">idcolumnname</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># uri.setDataSource(&#39;&#39;, str(tablename) + &#39;_django&#39;, &#39;&#39;, &#39;&#39;, &quot;id_&quot; + str(tablename).lower())</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_django&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">idcolumnname</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerdjango&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">)</span>




                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                    <span class="n">uri</span><span class="o">.</span><span class="n">setConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pghost</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgport</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pguser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span><span class="p">)</span>
                    <span class="n">tablenamelayer</span> <span class="o">=</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c1"># raw layer</span>
                    <span class="c1"># if geom is not None:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">):</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">),</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">)</span>
                    <span class="c1"># view layer qgis</span>
                    <span class="c1">#if geom is not None:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">):</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_qgis&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">)</span>
                    <span class="c1"># view layer django</span>
                    <span class="c1">#if geom is not None:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTableSpatial</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_django&#39;</span><span class="p">):</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_django&#39;</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_django&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablenamelayer</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerdjango&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># style and loading</span>
                    <span class="n">stylepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;DBASE&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.qml&#39;</span><span class="p">)</span>


                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">stylepath</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loadNamedStyle</span><span class="p">(</span><span class="n">stylepath</span><span class="p">)</span>

                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1">#load qgsvectorlayers and add to canvas if #showinqgis</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">],</span>
                                                                                 <span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">],</span>
                                                                                 <span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span>
                                                                                 <span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span>
                                                                                 <span class="kc">False</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;scale&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setScaleBasedVisibility</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setMaximumScale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setMinimumScale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">stylepath</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loadNamedStyle</span><span class="p">(</span><span class="n">stylepath</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;showinqgis&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span>
                                                                                 <span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span>
                                                                                 <span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;step3&#39;</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">updateQgsCoordinateTransformFromLayerToCanvas</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxRevision</span><span class="p">()</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">dBaseLoaded</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>


        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">createQgsVectorLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tablename</span><span class="o">=</span><span class="s1">&#39;tempvectorlayer&#39;</span><span class="p">,</span><span class="n">isspatial</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tableid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">tableid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">finaltableid</span> <span class="o">=</span> <span class="n">tableid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finaltableid</span> <span class="o">=</span> <span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsDataSourceURI</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsDataSourceUri</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;SELECT&#39;</span> <span class="ow">in</span> <span class="n">sql</span> <span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="c1"># uri.setDataSource(&quot;public&quot;,&quot;japan_ver52&quot;,&quot;the_geom&quot;,&quot;&quot;,&quot;gid&quot;)</span>
            <span class="c1"># uri.setDataSource(&quot;&quot;,sql,&quot;the_geom&quot;,&quot;&quot;,&quot;gid&quot;)</span>
            <span class="n">uri</span><span class="o">.</span><span class="n">setDatabase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatialitefile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isspatial</span><span class="p">:</span>
                <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sql</span> <span class="p">,</span> <span class="s1">&#39;geom&#39;</span> <span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">finaltableid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">finaltableid</span><span class="p">)</span>

            <span class="n">layer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">featureCount</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>



        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">uri</span><span class="o">.</span><span class="n">setConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pghost</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgport</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgdb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pguser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgpassword</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isspatial</span><span class="p">:</span>
                <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">finaltableid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pgschema</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sql</span> <span class="p">,</span> <span class="n">finaltableid</span> <span class="p">)</span>

            <span class="n">layer</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">layer</span>


    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span><span class="n">arguments</span><span class="o">=</span><span class="p">[],</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="p">:</span>
            <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="c1"># cursor = self.connSLITE.cursor()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLITEcursor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># self.connSLITE = db.connect(self.spatialitefile)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SLITEcursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">docommit</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>

                <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLITEcursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">arguments</span><span class="p">)</span>
                <span class="n">returnquery</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">docommit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcenocommit</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">returnquery</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">OperationalError</span> <span class="p">,</span><span class="n">IntegrityError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errorquerymessage</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error query&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">None</span>




        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># connectstr = &quot;dbname=&#39;&quot; + self.pgdb + &quot;&#39; user=&#39;&quot; + self.pguser + &quot;&#39; host=&#39;&quot;</span>
                <span class="c1"># connectstr += self.pghost + &quot;&#39; password=&#39;&quot; + self.pgpassword + &quot;&#39;&quot;</span>
                <span class="c1"># self.connPGis = psycopg2.connect(connectstr)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error query&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">sql</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">returnrows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">docommit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Lamia&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestart</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">returnrows</span>
                <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error query&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errorquerymessage</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">None</span>



    <span class="k">def</span> <span class="nf">updateQueryTableNow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlin</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#sqllist = sqlin.split(&#39; &#39;)</span>
        <span class="n">sqllist</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; |,|\(|\)|\.|=&#39;</span><span class="p">,</span> <span class="n">sqlin</span><span class="p">)</span>
        <span class="n">withsql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">alreadytables</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">sqlword</span> <span class="ow">in</span> <span class="n">sqllist</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_now&#39;</span> <span class="ow">in</span> <span class="n">sqlword</span><span class="p">:</span>
                <span class="n">tablename</span><span class="o">=</span><span class="n">sqlword</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_now&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="n">alreadytables</span><span class="p">:</span>
                    <span class="n">alreadytables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="n">withsql</span> <span class="o">+=</span>  <span class="n">sqlword</span> <span class="o">+</span> <span class="s2">&quot; AS &quot;</span>
                    <span class="n">withsql</span> <span class="o">+=</span> <span class="s2">&quot; (SELECT * FROM &quot;</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s2">&quot;_qgis WHERE &quot;</span>
                    <span class="c1"># withsql += &quot; (SELECT * FROM &quot; + tablename + &quot;_qgis WHERE &quot;</span>
                    <span class="n">withsql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dateVersionConstraintSQL</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
                    <span class="n">withsql</span> <span class="o">+=</span> <span class="s2">&quot;), &quot;</span>

        <span class="n">withsql</span> <span class="o">=</span> <span class="n">withsql</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">withsql</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">withsql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">sqltemp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitSQLSelectFromWhereOrderby</span><span class="p">(</span><span class="n">sqlin</span><span class="p">)</span>

        <span class="n">sqlout</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;WITH&#39;</span> <span class="ow">in</span> <span class="n">sqltemp1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39;WITH &#39;</span> <span class="o">+</span> <span class="n">sqltemp1</span><span class="p">[</span><span class="s1">&#39;WITH&#39;</span><span class="p">]</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">withsql</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; SELECT &#39;</span> <span class="o">+</span> <span class="n">sqltemp1</span><span class="p">[</span><span class="s1">&#39;SELECT&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; FROM &#39;</span> <span class="o">+</span> <span class="n">sqltemp1</span><span class="p">[</span><span class="s1">&#39;FROM&#39;</span><span class="p">]</span><span class="o">+</span> <span class="s1">&#39; WHERE &#39;</span> <span class="o">+</span> <span class="n">sqltemp1</span><span class="p">[</span><span class="s1">&#39;WHERE&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;ORDER&#39;</span> <span class="ow">in</span> <span class="n">sqltemp1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; ORDER BY &#39;</span> <span class="o">+</span> <span class="n">sqltemp1</span><span class="p">[</span><span class="s1">&#39;ORDER&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;GROUP&#39;</span> <span class="ow">in</span> <span class="n">sqltemp1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; GROUP BY &#39;</span> <span class="o">+</span> <span class="n">sqltemp1</span><span class="p">[</span><span class="s1">&#39;GROUP&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">withsql</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39;WITH &#39;</span> <span class="o">+</span> <span class="n">withsql</span> <span class="o">+</span> <span class="n">sqlin</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="n">sqlin</span>



        <span class="k">return</span> <span class="n">sqlout</span>



    <span class="k">def</span> <span class="nf">splitSQLSelectFromWhereOrderby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sqlin</span><span class="p">):</span>
        <span class="n">sqltemp</span> <span class="o">=</span> <span class="n">sqlin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">indexparenthesis</span><span class="o">=</span><span class="mi">0</span>

        <span class="n">specwords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;WITH&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="s1">&#39;WHERE&#39;</span><span class="p">,</span> <span class="s1">&#39;GROUP&#39;</span><span class="p">,</span><span class="s1">&#39;ORDER&#39;</span><span class="p">]</span>
        <span class="n">listres</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">actualsqlword</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">sqlword</span> <span class="ow">in</span> <span class="n">sqltemp</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">sqlword</span> <span class="ow">or</span> <span class="s1">&#39;)&#39;</span> <span class="ow">in</span> <span class="n">sqlword</span><span class="p">:</span>
                <span class="n">indexparenthesis</span> <span class="o">+=</span> <span class="n">sqlword</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
                <span class="n">indexparenthesis</span> <span class="o">+=</span> <span class="o">-</span> <span class="n">sqlword</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="n">listres</span><span class="p">[</span><span class="n">actualsqlword</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sqlword</span>
            <span class="k">elif</span>  <span class="n">sqlword</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">specwords</span> <span class="ow">and</span> <span class="n">indexparenthesis</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="n">actualsqlword</span> <span class="o">=</span> <span class="n">sqlword</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">listres</span><span class="p">[</span><span class="n">actualsqlword</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">actualsqlword</span><span class="p">:</span>
                    <span class="n">listres</span><span class="p">[</span><span class="n">actualsqlword</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sqlword</span>

        <span class="k">if</span> <span class="s1">&#39;GROUP&#39;</span> <span class="ow">in</span> <span class="n">listres</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">listres</span><span class="p">[</span><span class="s1">&#39;GROUP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">listres</span><span class="p">[</span><span class="s1">&#39;GROUP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">return</span> <span class="n">listres</span>

    <span class="k">def</span> <span class="nf">rebuildSplittedQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlin</span><span class="p">):</span>
        <span class="n">sqlout</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;WITH&#39;</span> <span class="ow">in</span> <span class="n">sqlin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; WITH &#39;</span> <span class="o">+</span> <span class="n">sqlin</span><span class="p">[</span><span class="s1">&#39;WITH&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;SELECT&#39;</span> <span class="ow">in</span> <span class="n">sqlin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; SELECT &#39;</span> <span class="o">+</span> <span class="n">sqlin</span><span class="p">[</span><span class="s1">&#39;SELECT&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;FROM&#39;</span> <span class="ow">in</span> <span class="n">sqlin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; FROM &#39;</span> <span class="o">+</span> <span class="n">sqlin</span><span class="p">[</span><span class="s1">&#39;FROM&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;WHERE&#39;</span> <span class="ow">in</span> <span class="n">sqlin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; WHERE &#39;</span> <span class="o">+</span> <span class="n">sqlin</span><span class="p">[</span><span class="s1">&#39;WHERE&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;GROUP&#39;</span> <span class="ow">in</span> <span class="n">sqlin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; GROUP BY &#39;</span> <span class="o">+</span> <span class="n">sqlin</span><span class="p">[</span><span class="s1">&#39;GROUP&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;ORDER&#39;</span> <span class="ow">in</span> <span class="n">sqlin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sqlout</span> <span class="o">+=</span> <span class="s1">&#39; ORDER BY &#39;</span> <span class="o">+</span> <span class="n">sqlin</span><span class="p">[</span><span class="s1">&#39;ORDER&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sqlout</span>



    <span class="k">def</span> <span class="nf">query2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="c1"># cursor = self.connSLITE.cursor()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLITEcursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">query</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PGiscursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">rows</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="DBaseParser.vacuum"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.vacuum">[docs]</a>    <span class="k">def</span> <span class="nf">vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methode invoquée pour faire des vacuum dans la BD lamia en cours d&#39;utilisation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>   <span class="c1">#nedd to be done before vacuum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;VACUUM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">old_isolation_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span><span class="o">.</span><span class="n">isolation_level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;VACUUM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">old_isolation_level</span><span class="p">)</span></div>


<div class="viewcode-block" id="DBaseParser.commit"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methode invoquée pour faire des commits dans la BD lamia en cours d&#39;utilisation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connSLITE</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connPGis</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_readRecentDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lit le fichier des bases de données recentes et rempli le  menu//Fichier//base de données recentes</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">pathrecentproject</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;recentprojects.txt&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathrecentproject</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recentDBaseChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_AddDbaseInRecentsDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatialitefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                                    <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Methode appelée lors du chargement d&#39;une BD lamia</span>
<span class="sd">            Ajoute le chemin dans le fichier chargé dans Menu//Fichier//base de données recentes</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spatialitefile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spatialitefile</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spatialitefile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saveRecentDBase</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recentDBaseChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span><span class="n">schema</span>  <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="n">password</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saveRecentDBase</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recentDBaseChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>


        <span class="k">def</span> <span class="nf">_saveRecentDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Sauve le path de la BD lamia en cours d&#39;utilisation dans le ficier employé dans</span>
<span class="sd">            menu//Fichier//base de données recentes</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">pathrecentproject</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;recentprojects.txt&#39;</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathrecentproject</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recentsdbase</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recentDBaseChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">reInitDBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="kc">None</span>



<div class="viewcode-block" id="DBaseParser.reInitDBase2"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.reInitDBase2">[docs]</a>    <span class="k">def</span> <span class="nf">reInitDBase2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methode appelée lors d&#39;un changement de base de données</span>
<span class="sd">        Reinitialise toutes les variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layername</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;layer&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">removeMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">removeMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                <span class="k">if</span> <span class="s1">&#39;layerqgis&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">removeMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">removeMapLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                <span class="k">if</span> <span class="s1">&#39;widget&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                            <span class="n">tablewdgs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tablewdgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">tablewdg</span> <span class="ow">in</span> <span class="n">tablewdgs</span><span class="p">:</span>
                            <span class="n">tablewdg</span><span class="o">.</span><span class="n">onActivationRaw</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">tablewdg</span><span class="o">.</span><span class="n">unloadWidgetinMainTree</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unload&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>


                            <span class="k">if</span> <span class="n">tablewdg</span><span class="o">.</span><span class="n">linkedtreewidget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">tablewdg</span><span class="o">.</span><span class="n">linkedtreewidget</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="n">tablewdg</span><span class="o">.</span><span class="n">dbasetable</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DBaseParser.updateWorkingDate"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.updateWorkingDate">[docs]</a>    <span class="k">def</span> <span class="nf">updateWorkingDate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methode appelée lorsque la date de travail (self.workingdate) ou la version de travail (self.currentrevision)</span>
<span class="sd">        est modifiée</span>
<span class="sd">        Change les filtres de toutes les tables qgis en fonction</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">workingdatemodif</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingdate</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addDays</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="n">subsetstring</span> <span class="o">=</span> <span class="s1">&#39;&quot;datecreation&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;datedestruction&quot; IS NOT NULL  THEN &quot;datedestruction&quot; &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE 1 END&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND &quot;revisionbegin&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;revisionend&quot; IS NOT NULL  THEN &quot;revisionend&quot; &gt; &#39;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39; ELSE 1 END&#39;</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="n">subsetstring</span> <span class="o">=</span> <span class="s1">&#39;&quot;datecreation&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;datedestruction&quot; IS NOT NULL  THEN &quot;datedestruction&quot; &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE TRUE END&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND &quot;revisionbegin&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;revisionend&quot; IS NOT NULL  THEN &quot;revisionend&quot; &gt; &#39;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39; ELSE TRUE END&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="n">subsetstring</span> <span class="o">=</span> <span class="s1">&#39;&quot;datetimecreation&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;datetimedestruction&quot; IS NOT NULL  THEN &quot;datetimedestruction&quot; &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE 1 END&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND &quot;lpk_revision_begin&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;lpk_revision_end&quot; IS NOT NULL  THEN &quot;lpk_revision_end&quot; &gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ELSE 1 END&#39;</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="n">subsetstring</span> <span class="o">=</span> <span class="s1">&#39;&quot;datetimecreation&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;datetimedestruction&quot; IS NOT NULL  THEN &quot;datetimedestruction&quot; &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE TRUE END&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND &quot;lpk_revision_begin&quot; &lt;= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">subsetstring</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN &quot;lpk_revision_end&quot; IS NOT NULL  THEN &quot;lpk_revision_end&quot; &gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ELSE TRUE END&#39;</span>


        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">()]</span>
            <span class="k">if</span> <span class="s1">&#39;datecreation&#39;</span> <span class="ow">in</span> <span class="n">fieldnames</span> <span class="ow">or</span> <span class="s1">&#39;datetimecreation&#39;</span> <span class="ow">in</span> <span class="n">fieldnames</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setSubsetString</span><span class="p">(</span><span class="n">subsetstring</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggerRepaint</span><span class="p">()</span></div>


<div class="viewcode-block" id="DBaseParser.updateQgsCoordinateTransformFromLayerToCanvas"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.updateQgsCoordinateTransformFromLayerToCanvas">[docs]</a>    <span class="k">def</span> <span class="nf">updateQgsCoordinateTransformFromLayerToCanvas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methode appellée lorsque le crs du canvas qgis change</span>
<span class="sd">        met à jour self.xform et self.xformreverse pour effectuer les transformations crs canvas &lt;-&gt; crs lamia</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgiscrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xform</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsCoordinateTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgiscrs</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapSettings</span><span class="p">()</span><span class="o">.</span><span class="n">destinationCrs</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xformreverse</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsCoordinateTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapSettings</span><span class="p">()</span><span class="o">.</span><span class="n">destinationCrs</span><span class="p">(),</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">qgiscrs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xform</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsCoordinateTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgiscrs</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapSettings</span><span class="p">()</span><span class="o">.</span><span class="n">destinationCrs</span><span class="p">(),</span>
                                                              <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xformreverse</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsCoordinateTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mapSettings</span><span class="p">()</span><span class="o">.</span><span class="n">destinationCrs</span><span class="p">(),</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">qgiscrs</span><span class="p">,</span>
                                                                    <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span> <span class="p">)</span></div>


<div class="viewcode-block" id="DBaseParser.getConstraintRawValueFromText"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getConstraintRawValueFromText">[docs]</a>    <span class="k">def</span> <span class="nf">getConstraintRawValueFromText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">txt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convertie la valeur textuelle  txt de la table lamia &quot;table&quot; vers sa valeur trigramme</span>
<span class="sd">        :param table: la table lamia considérée</span>
<span class="sd">        :param field: la colonne considérée</span>
<span class="sd">        :param txt: la valeur textuelle</span>
<span class="sd">        :return: le trigramme</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;_getConstraintRawValueFromText&#39;,[value[0] for value in self.dbasetables[table][&#39;fields&#39;][field][&#39;Cst&#39;]], txt )</span>
        <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span>  <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;error </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span><span class="n">field</span> <span class="p">,</span> <span class="nb">str</span><span class="p">([</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]]</span> <span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;error </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span><span class="n">field</span> <span class="p">,</span> <span class="s1">&#39;No contraint&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">txt</span></div>

<div class="viewcode-block" id="DBaseParser.getConstraintTextFromRawValue"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getConstraintTextFromRawValue">[docs]</a>    <span class="k">def</span> <span class="nf">getConstraintTextFromRawValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">rawvalue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convertie le trigramme rawvalue de la table lamia &quot;table&quot; vers sa valeur textuelle</span>
<span class="sd">        :param table: la table lamia considérée</span>
<span class="sd">        :param field: la colonne considérée</span>
<span class="sd">        :param rawvalue: le trigramme ou valeur stockée considérée</span>
<span class="sd">        :return: la valeur textuelle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;_getConstraintTextFromRawValue&#39;,table, self.dbasetables[table][&#39;fields&#39;][field], rawvalue,field)</span>
        <span class="c1"># print(&#39;_getConstraintTextFromRawValue&#39;,table, field, rawvalue )</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="ow">and</span> <span class="s1">&#39;Cst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
            <span class="c1">#if field in dbasetable[&#39;fields&#39;].keys() and &#39;Cst&#39; in dbasetable[&#39;fields&#39;][field].keys():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAttributeNull</span><span class="p">(</span><span class="n">rawvalue</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rawvalue</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rawvalue</span><span class="p">,</span> <span class="n">long</span><span class="p">):</span>
                    <span class="n">rawvalue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rawvalue</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rawvalue</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">qgis</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">iface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;getConstraintTextFromRawValue error&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;Cst&#39;</span><span class="p">]])</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">rawvalue</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAttributeNull</span><span class="p">(</span><span class="n">rawvalue</span><span class="p">):</span>
                <span class="c1"># print(table, field, rawvalue, type(rawvalue))</span>
                <span class="k">return</span> <span class="n">rawvalue</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rawvalue</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">rawvalue</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">rawvalue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">rawvalue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="DBaseParser.isAttributeNull"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.isAttributeNull">[docs]</a>    <span class="k">def</span> <span class="nf">isAttributeNull</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vérifie si un qgisfeature attribute est NULL - piégeux car le NULL peu prendre plusieurs formes</span>
<span class="sd">        :param attr: get an qgisfeature attribute</span>
<span class="sd">        :return: True if NULL, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPyNullVariant</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">220</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">unicode</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="nb">str</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;NULL&#39;</span> <span class="ow">or</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DBaseParser.isTableSpatial"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.isTableSpatial">[docs]</a>    <span class="k">def</span> <span class="nf">isTableSpatial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permet de savoir si une table lamia est spatiale en cherchant le mot clé &#39;geom&#39; dans la liste des colonnes</span>
<span class="sd">        :param tablename: la table à analyser</span>
<span class="sd">        :return: True si &#39;geom&#39; est trouvé, False sinon</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;PRAGMA table_info(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
            <span class="c1">#print(result)</span>
            <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT column_name FROM information_schema.columns WHERE table_name  = &#39;&quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DBaseParser.getNearestPk"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getNearestPk">[docs]</a>    <span class="k">def</span> <span class="nf">getNearestPk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbasetable</span><span class="p">,</span> <span class="n">dbasetablename</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">comefromcanvas</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permet d&#39;avoir le pk du feature le plus proche du qgsvectorlayer correspondant à dbasetablename</span>
<span class="sd">        pas besoin de filtre sur les dates et versions on travaille avec le qgsectorlyaer de la table</span>
<span class="sd">        qui dispose déjà d&#39;un filtre en fonction de la date et de la version</span>
<span class="sd">        :param dbasetable: la dbasetable considérée</span>
<span class="sd">        :param dbasetablename:  le nom de la dbasetable</span>
<span class="sd">        :param point: le point dont on veut connaitre le plus proche élément</span>
<span class="sd">        :param comefromcanvas: spécifie sir le point provient du canvas qgis (nécessité de trasformation) ou non</span>
<span class="sd">        :return: le pk de la table dbasetablenamele plus proche du point</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">timestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTimeNow</span><span class="p">()</span>

        <span class="c1"># vérifie que la table est spatiale</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">218</span><span class="p">:</span>
            <span class="n">isspatial</span> <span class="o">=</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isspatial</span> <span class="o">=</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isSpatial</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isspatial</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Effectue la transformation geographique si necessaire</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;pointbefore </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">comefromcanvas</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">point2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xformreverse</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">point2</span> <span class="o">=</span> <span class="n">point</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">point2</span> <span class="o">=</span> <span class="n">point</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;pointafter </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">point2</span><span class="p">))</span>

        <span class="c1"># créé l&#39;index spatial</span>
        <span class="n">spindex</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsSpatialIndex</span><span class="p">(</span><span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">())</span>

        <span class="n">layernearestid</span> <span class="o">=</span> <span class="n">spindex</span><span class="o">.</span><span class="n">nearestNeighbor</span><span class="p">(</span><span class="n">point2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1">#on cherche la geometry du nearestid</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="n">point2geom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">point2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">point2geom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPointXY</span><span class="p">(</span><span class="n">point2</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
            <span class="n">nearestfet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLayerFeatureById</span><span class="p">(</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">layernearestid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nearestfet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">layernearestid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">nearestfetgeom</span> <span class="o">=</span> <span class="n">nearestfet</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>



        <span class="c1"># cas d&#39;un point : le nearestNeighbor renvoi la bonne valeur</span>
        <span class="k">if</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;layerqgis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">geometryType</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">disfrompoint</span> <span class="o">=</span> <span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point2geom</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">layernearestid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">disfrompoint</span>




        <span class="c1"># cas d&#39;une ligne ou polygone : comme la recherce se fait su une boundingbox, il faut filtrer les</span>
        <span class="c1"># elements dans cette box</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># clean nearestfet geometry if not valid</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">isGeosValid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nearestfetgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsPoint</span><span class="p">(</span><span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">isGeosValid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nearestfetgeom</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPointXY</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsPointXY</span><span class="p">(</span><span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="n">disfrompoint</span> <span class="o">=</span> <span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point2geom</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;nearestfetgeom - dist </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nearestfetgeom</span><span class="o">.</span><span class="n">exportToWkt</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">disfrompoint</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">disfrompoint</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">disfrompoint</span> <span class="o">=</span> <span class="mf">0.1</span>

            <span class="n">bboxtofilter</span> <span class="o">=</span> <span class="n">point2geom</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">disfrompoint</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">()</span>
            <span class="n">idsintersectingbbox</span> <span class="o">=</span> <span class="n">spindex</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">bboxtofilter</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;idsintersectingbbox </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idsintersectingbbox</span><span class="p">))</span>

            <span class="c1"># search nearest geom in bbox</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">nearestindex</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">finalgeomispoint</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">distanceratio</span> <span class="o">=</span> <span class="mf">1.2</span>

            <span class="k">for</span> <span class="n">intersectingid</span> <span class="ow">in</span> <span class="n">idsintersectingbbox</span><span class="p">:</span>
                <span class="n">ispoint</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLayerFeatureById</span><span class="p">(</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">intersectingid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLayerFeatureByPk</span><span class="p">(</span><span class="n">dbasetablename</span><span class="p">,</span> <span class="n">intersectingid</span><span class="p">)</span>
                <span class="n">featgeom</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;intersectingid </span><span class="si">%s</span><span class="s1">  - is valid : </span><span class="si">%s</span><span class="s1"> - type : </span><span class="si">%s</span><span class="s1"> - multi : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                                                           <span class="nb">str</span><span class="p">(</span><span class="n">intersectingid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">isGeosValid</span><span class="p">()),</span>
                                                           <span class="nb">str</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">isMultipart</span><span class="p">()))</span>

                <span class="k">if</span> <span class="n">featgeom</span><span class="o">.</span><span class="n">isGeosValid</span><span class="p">():</span>  <span class="c1"># if not valid, return dist = -1...</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">featgeom</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point2geom</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># point</span>
                    <span class="k">if</span> <span class="n">featgeom</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">featgeom</span><span class="o">.</span><span class="n">isMultipart</span><span class="p">():</span>

                        <span class="n">ispoint</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># polyline of 1 point</span>
                                <span class="n">dist</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsPoint</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point2geom</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">dist</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsPoint</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point2geom</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># polyline of 1 point</span>
                                <span class="n">dist</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPointXY</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsPointXY</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point2geom</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">dist</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPointXY</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsPointXY</span><span class="p">(</span><span class="n">featgeom</span><span class="o">.</span><span class="n">asPolyline</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point2geom</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;distance : </span><span class="si">%s</span><span class="s1"> - ispoint : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dist</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ispoint</span><span class="p">))</span>
                <span class="c1"># algo for keeping point in linestring layer as nearest</span>
                <span class="c1"># if point is nearest than 1.2 x dist from nearest line</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;distance : </span><span class="si">%s</span><span class="s1"> - ispoint : </span><span class="si">%s</span><span class="s1"> - geomfinalispoint : </span><span class="si">%s</span><span class="s1"> - finaldist : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="p">,</span>
                                                           <span class="nb">str</span><span class="p">(</span><span class="n">dist</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ispoint</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">finalgeomispoint</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="n">nearestindex</span> <span class="o">=</span> <span class="n">intersectingid</span>
                    <span class="n">finalgeomispoint</span> <span class="o">=</span> <span class="n">ispoint</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">finalgeomispoint</span> <span class="ow">and</span> <span class="n">ispoint</span> <span class="ow">and</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">*</span><span class="n">distanceratio</span><span class="p">:</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="n">nearestindex</span> <span class="o">=</span> <span class="n">intersectingid</span>
                    <span class="n">finalgeomispoint</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">finalgeomispoint</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ispoint</span> <span class="ow">and</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">/</span><span class="n">distanceratio</span><span class="p">:</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="n">nearestindex</span> <span class="o">=</span> <span class="n">intersectingid</span>
                    <span class="n">finalgeomispoint</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">finalgeomispoint</span> <span class="o">==</span> <span class="n">ispoint</span> <span class="ow">and</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="n">nearestindex</span> <span class="o">=</span> <span class="n">intersectingid</span>
                    <span class="n">finalgeomispoint</span> <span class="o">=</span> <span class="n">ispoint</span>


        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;nearestpk, dist </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nearestindex</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">nearestindex</span><span class="p">,</span> <span class="n">distance</span></div>

<div class="viewcode-block" id="DBaseParser.areNodesEquals"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.areNodesEquals">[docs]</a>    <span class="k">def</span> <span class="nf">areNodesEquals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction pour examiner l&#39;égalité géographique de deux points.</span>
<span class="sd">        Nécessaire car parfois les arrondis des coordonnées géographiques font que deux points égaux ont une</span>
<span class="sd">        différence de qques micromètres</span>
<span class="sd">        :param node1: point1 (list 2x1)</span>
<span class="sd">        :param node2: point2 (list 2x1)</span>
<span class="sd">        :return: Boolean, en fonction de l&#39;égalité geographique des points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">node2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">node2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">node1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DBaseParser.getLayerFeatureById"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getLayerFeatureById">[docs]</a>    <span class="k">def</span> <span class="nf">getLayerFeatureById</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layername</span><span class="p">,</span> <span class="n">fid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renvoie le QgsFeature de la table lamia nommée layername dont le id est fid</span>
<span class="sd">        Remarque : on demande ici l&#39;id et non la cle primaire de la table</span>
<span class="sd">        Remarquebis : on fait la requete sur le qgsvectorlayer de la table (dans self.dbasetables[layername][&#39;layerqgis&#39;])</span>
<span class="sd">                      du coup, comme ce qgsvectorlayer dispose déjà d&#39;un filtre en fonction de la date et de la version,</span>
<span class="sd">                      pas besoin de requeter en plus sur ce sujet</span>
<span class="sd">        :param layername: le nom de la table dans la BD lamia</span>
<span class="sd">        :param fid: le id dont on veut le feature</span>
<span class="sd">        :return: le QgsFeature associé au id demandé</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeatureRequest</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeature</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># requete pour avoir le feature avec l&#39;id demandé, puis on ndemande le pk_XXX de ce feature</span>
            <span class="c1"># ex : request =  qgis.core.QgsFeatureRequest().setFilterExpression(&#39; &quot;some_field_name&quot; = \&#39;some_value\&#39; &#39;)</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">layername</span> <span class="o">+</span> <span class="s1">&#39;_qgis  &#39;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39;WHERE id_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; AND &#39;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dateVersionConstraintSQL</span><span class="p">()</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeatureRequest</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeature</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span>
                <span class="n">txtrequest</span> <span class="o">=</span> <span class="s1">&#39; &quot;id_&#39;</span> <span class="o">+</span> <span class="n">layername</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot; =  &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                <span class="n">request</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterExpression</span><span class="p">(</span><span class="n">txtrequest</span><span class="p">)</span>
                <span class="c1"># request.setFlags(qgis.core.QgsFeatureRequest.NoGeometry)</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                    <span class="n">qgisfeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qgisfeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span><span class="s2">&quot;_qgis &quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;WHERE id_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dateVersionConstraintSQL</span><span class="p">()</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                    <span class="n">qgisfeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeatureRequest</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qgisfeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeature</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

                <span class="c1"># print(txtrequest, qgisfeat.id(), qgisfeat.attributes())</span>

            <span class="k">return</span> <span class="n">qgisfeat</span></div>

<div class="viewcode-block" id="DBaseParser.getLayerFeatureByPk"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getLayerFeatureByPk">[docs]</a>    <span class="k">def</span> <span class="nf">getLayerFeatureByPk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layername</span><span class="p">,</span> <span class="n">fid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renvoie le QgsFeature de la table lamia nommée layername dont le pk est fid</span>
<span class="sd">        :param layername: le nom de la table dans la BD lamia</span>
<span class="sd">        :param fid: le pk dont on veut le feature</span>
<span class="sd">        :return: le QgsFeature associé au pk demandé</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&#39;featpk&#39;)</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">fid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">layername</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeatureRequest</span><span class="p">(</span><span class="n">fid</span><span class="p">))</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">layername</span><span class="p">][</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getFeature</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">getValuesFromPk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbasename</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="c1"># print(&#39;getValuesFromPk&#39;,type(fields) )</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fields</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbasename</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">dbasename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span>  <span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">createNewObjet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">datecreation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
        <span class="n">lastobjetid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastId</span><span class="p">(</span><span class="s1">&#39;Objet&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Objet (id_objet, lpk_revision_begin, datetimecreation, datetimemodification ) &quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;VALUES(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lastobjetid</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&#39;&quot;</span> <span class="o">+</span> <span class="n">datecreation</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="n">datecreation</span> <span class="o">+</span> <span class="s2">&quot;&#39; )&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="n">docommit</span><span class="p">)</span>
        <span class="c1">#self.dbase.commit()</span>
        <span class="n">pkobjet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRowId</span><span class="p">(</span><span class="s1">&#39;Objet&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pkobjet</span>



    <span class="k">def</span> <span class="nf">createNewLineVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dbname</span><span class="p">,</span> <span class="n">rawpk</span><span class="p">):</span>

        <span class="c1">#first be sure</span>
        <span class="n">pkobjet</span><span class="p">,</span> <span class="n">revbegin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="n">dbname</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pk_objet&#39;</span><span class="p">,</span><span class="s1">&#39;lpk_revision_begin&#39;</span><span class="p">],</span> <span class="n">rawpk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">revbegin</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">:</span>

            <span class="c1">#first close object</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;Objet&#39;</span><span class="p">,</span>
                                              <span class="p">[</span><span class="s1">&#39;lpk_revision_end&#39;</span><span class="p">],</span>
                                              <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">])</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkobjet</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="c1"># then clone parents</span>
            <span class="n">parenttables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParentTable</span><span class="p">(</span><span class="n">dbname</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dbname</span><span class="p">]</span>
            <span class="c1"># get pkparents</span>
            <span class="n">pknames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pk_&#39;</span> <span class="o">+</span> <span class="n">parenttablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">parenttablename</span> <span class="ow">in</span> <span class="n">parenttables</span><span class="p">]</span>
            <span class="n">parentspk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span><span class="p">,</span> <span class="n">pknames</span><span class="p">,</span> <span class="n">rawpk</span><span class="p">)</span>

            <span class="n">lastpk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parenttables</span><span class="p">):</span>
                <span class="n">pkfields</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">nonpkfields</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fields</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getColumns</span><span class="p">(</span><span class="n">tablename</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pk_&#39;</span> <span class="ow">or</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lpk_&#39;</span><span class="p">:</span>
                        <span class="n">pkfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">fields</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                        <span class="n">nonpkfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ST_AsText(geom)&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nonpkfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValuesFromPk</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">nonpkfields</span><span class="p">,</span><span class="n">parentspk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>

                <span class="n">nonpkfields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geom&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;ST_AsText(geom)&#39;</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nonpkfields</span><span class="p">]</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="s1">&#39;INSERT&#39;</span><span class="p">,</span>
                                                  <span class="n">tablename</span><span class="p">,</span>
                                                  <span class="n">nonpkfields</span><span class="p">,</span>
                                                  <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="n">lastpk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLastRowId</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
                <span class="n">fieldstoupdate</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">valuestoupdate</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">if</span> <span class="s1">&#39;lpk_revision_begin&#39;</span> <span class="ow">in</span> <span class="n">pkfields</span><span class="p">:</span>
                    <span class="n">fieldstoupdate</span> <span class="o">+=</span><span class="p">[</span><span class="s1">&#39;lpk_revision_begin&#39;</span><span class="p">,</span> <span class="s1">&#39;lpk_revision_end&#39;</span><span class="p">]</span>
                    <span class="n">valuestoupdate</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;datetimemodification&#39;</span> <span class="ow">in</span> <span class="n">nonpkfields</span><span class="p">:</span>
                    <span class="n">datemodif</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
                    <span class="n">fieldstoupdate</span> <span class="o">+=</span><span class="p">[</span><span class="s1">&#39;datetimemodification&#39;</span><span class="p">]</span>
                    <span class="n">valuestoupdate</span> <span class="o">+=</span> <span class="p">[</span><span class="n">datemodif</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;lpk_&#39;</span> <span class="o">+</span> <span class="n">parenttables</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">pkfields</span><span class="p">:</span>
                    <span class="n">fieldstoupdate</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;lpk_&quot;</span> <span class="o">+</span> <span class="n">parenttables</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                    <span class="n">valuestoupdate</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lastpk</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

                <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span>
                                                  <span class="n">tablename</span><span class="p">,</span>
                                                  <span class="n">fieldstoupdate</span><span class="p">,</span>
                                                  <span class="n">valuestoupdate</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lastpk</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>





<div class="viewcode-block" id="DBaseParser.dateVersionConstraintSQL"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.dateVersionConstraintSQL">[docs]</a>    <span class="k">def</span> <span class="nf">dateVersionConstraintSQL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specialdate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crée une chaine à rajouter à la fin d&#39;autre requetes pour spécifier la date et la version voulue</span>
<span class="sd">        :return: requete sql comprenant les éléments nécessaires pour filtrer les dates et les versions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">specialdate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">specialdate</span> <span class="o">==</span> <span class="s1">&#39;now&#39;</span><span class="p">:</span>
            <span class="n">workingdatemodif</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingdate</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addDays</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">workingdatemodif</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="n">specialdate</span><span class="p">,</span> <span class="s1">&#39;dd/MM/yyyy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addDays</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span>



        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">sqlin</span> <span class="o">=</span> <span class="s1">&#39; datecreation &lt;= &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="n">sqlin</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN datedestruction IS NOT NULL  &#39;</span>
                <span class="n">sqlin</span> <span class="o">+=</span> <span class="s1">&#39;THEN DateDestruction &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE TRUE END&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; AND revisionbegin &lt;= &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; AND CASE WHEN revisionend IS NOT NULL THEN &quot;</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; revisionend &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; ELSE TRUE END &quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="n">sqlin</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN datedestruction IS NOT NULL  &#39;</span>
                <span class="n">sqlin</span> <span class="o">+=</span> <span class="s1">&#39;THEN datedestruction &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE 1 END&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; AND revisionbegin &lt;= &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; AND CASE WHEN revisionend IS NOT NULL THEN &quot;</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; revisionend &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; ELSE 1 END&quot;</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">sqlin</span> <span class="o">=</span> <span class="s1">&#39; datetimecreation &lt;= &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="n">sqlin</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN datetimedestruction IS NOT NULL  &#39;</span>
                <span class="n">sqlin</span> <span class="o">+=</span> <span class="s1">&#39;THEN datetimedestruction &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE TRUE END&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_begin &lt;= &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; AND CASE WHEN lpk_revision_end IS NOT NULL THEN &quot;</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; lpk_revision_end &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; ELSE TRUE END &quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="n">sqlin</span> <span class="o">+=</span> <span class="s1">&#39; AND CASE WHEN datetimedestruction IS NOT NULL  &#39;</span>
                <span class="n">sqlin</span> <span class="o">+=</span> <span class="s1">&#39;THEN datetimedestruction &gt; &#39;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">workingdatemodif</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39; ELSE 1 END&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_begin &lt;= &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; AND CASE WHEN lpk_revision_end IS NOT NULL THEN &quot;</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; lpk_revision_end &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span><span class="p">)</span>
                    <span class="n">sqlin</span> <span class="o">+=</span> <span class="s2">&quot; ELSE 1 END&quot;</span>

        <span class="k">return</span> <span class="n">sqlin</span></div>


<div class="viewcode-block" id="DBaseParser.completePathOfFile"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.completePathOfFile">[docs]</a>    <span class="k">def</span> <span class="nf">completePathOfFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filetoprocess</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Génère le path complet du filetoprocess demandé. Utile quand on a un chemin relatif</span>
<span class="sd">        :param filetoprocess: le chemin rentré (relatif ou absolu)</span>
<span class="sd">        :return: le chemin absolu</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">completefile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filetoprocess</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPyNullVariant</span><span class="p">):</span>
            <span class="n">filetoprocess</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">filetoprocess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">completefile</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filetoprocess</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filetoprocess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">completefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span> <span class="n">filetoprocess</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">completefile</span> <span class="o">=</span> <span class="n">filetoprocess</span>
            <span class="n">completefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">completefile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">completefile</span></div>


<div class="viewcode-block" id="DBaseParser.getLastId"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getLastId">[docs]</a>    <span class="k">def</span> <span class="nf">getLastId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        renvoi l&#39;id maximum de la table lamia demandée</span>
<span class="sd">        :param table: la table lamia dont on veut l&#39;id max</span>
<span class="sd">        :return: l&#39;id max</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT MAX(id_&quot;</span> <span class="o">+</span> <span class="n">table</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;) FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span>  <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>       <span class="c1">#initialization</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="DBaseParser.getLastPk"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getLastPk">[docs]</a>    <span class="k">def</span> <span class="nf">getLastPk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        renvoi le pk maximum de la table lamia demandée</span>
<span class="sd">        :param table: la table lamia dont on veut le pk max</span>
<span class="sd">        :return: le pk max</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT MAX(pk_&quot;</span> <span class="o">+</span> <span class="n">table</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;) FROM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>       <span class="c1"># initialization</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DBaseParser.getLastRowId"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getLastRowId">[docs]</a>    <span class="k">def</span> <span class="nf">getLastRowId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renvoi le dernier pk ajouté dans la table lamia &#39;table&#39;</span>
<span class="sd">        :param table: la table dont on veut le dernier pk ajouté</span>
<span class="sd">        :return: le dernier pk ajouté</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT last_insert_rowid()&#39;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">tablelower</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT currval(&#39;&quot;</span> <span class="o">+</span> <span class="n">tablelower</span> <span class="o">+</span> <span class="s2">&quot;_id_&quot;</span> <span class="o">+</span> <span class="n">tablelower</span> <span class="o">+</span> <span class="s2">&quot;_seq&#39;);&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT currval(&#39;&quot;</span> <span class="o">+</span> <span class="n">tablelower</span> <span class="o">+</span> <span class="s2">&quot;_pk_&quot;</span> <span class="o">+</span> <span class="n">tablelower</span> <span class="o">+</span> <span class="s2">&quot;_seq&#39;);&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">id</span></div>


    <span class="k">def</span> <span class="nf">getColumns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;PRAGMA table_info(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT column_name FROM information_schema.columns WHERE table_name  = &#39;&quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="DBaseParser.getFirstIdColumn"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getFirstIdColumn">[docs]</a>    <span class="k">def</span> <span class="nf">getFirstIdColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permet d&#39;avoir la premiere colonne de la table lamia tablename avec pk_ en prefixe</span>
<span class="sd">        :param tablename: la table lamia</span>
<span class="sd">        :return: le nom du premier champ trouvé avec pk_ en sufixe</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;PRAGMA table_info(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
            <span class="c1">#print(result)</span>
            <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;pk_&#39;</span> <span class="ow">in</span> <span class="n">fieldname</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">fieldname</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;id_&#39;</span> <span class="ow">in</span> <span class="n">fieldname</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">fieldname</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT column_name FROM information_schema.columns WHERE table_name  = &#39;&quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">revisionwork</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;pk_&#39;</span> <span class="ow">in</span> <span class="n">fieldname</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">fieldname</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;id_&#39;</span> <span class="ow">in</span> <span class="n">fieldname</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">fieldname</span>



        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DBaseParser.getLatestVersion"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getLatestVersion">[docs]</a>    <span class="k">def</span> <span class="nf">getLatestVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renvoi la version max de la table Revision</span>
<span class="sd">        :return: la version max de la table Revision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT MAX(pk_revision) FROM Revision;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DBaseParser.getMaxRevision"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getMaxRevision">[docs]</a>    <span class="k">def</span> <span class="nf">getMaxRevision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renvoi la version max de la table Revision</span>
<span class="sd">        :return: la version max de la table Revision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastPk</span><span class="p">(</span><span class="s1">&#39;Revision&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">exportBase2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exportdbase</span><span class="p">):</span>

        <span class="c1"># load all features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># copy features</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="c1"># dbasename = &#39;_&#39;.join(layer.name().split(&#39;_&#39;)[0:-1])</span>
            <span class="k">if</span> <span class="s1">&#39;_point&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">():</span>
                <span class="n">dbasename</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;_line&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">():</span>
                <span class="n">dbasename</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbasename</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
            <span class="n">exec</span> <span class="p">(</span><span class="s2">&quot;dbase = self.dbase_&quot;</span> <span class="o">+</span> <span class="n">dbasename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dbasename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="p">[</span><span class="n">dbasename</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">layerexport</span> <span class="ow">in</span> <span class="n">exportdbase</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="n">layerexport</span><span class="o">.</span><span class="n">name</span><span class="p">():</span>
                    <span class="n">layerexport</span><span class="o">.</span><span class="n">featureAdded</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureAdded</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">fields</span><span class="p">()</span> <span class="o">==</span> <span class="n">layerexport</span><span class="o">.</span><span class="n">fields</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">():</span>
                            <span class="k">with</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">layerexport</span><span class="p">):</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbase</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                <span class="n">fet</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
                                <span class="n">idparent</span> <span class="o">=</span> <span class="n">fet</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
                                <span class="n">fet</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="nb">bool</span> <span class="o">=</span> <span class="n">layerexport</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">fet</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">bool</span><span class="p">:</span>
                                    <span class="n">layerexport</span><span class="o">.</span><span class="n">updateFeature</span><span class="p">(</span><span class="n">fet</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="n">idparent</span><span class="p">,</span> <span class="s1">&#39;non exporte&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="p">[</span><span class="n">dbasename</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">idparent</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureaddedid</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">():</span>
                            <span class="k">with</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">layerexport</span><span class="p">):</span>
                                <span class="n">fet</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeature</span><span class="p">(</span><span class="n">layerexport</span><span class="o">.</span><span class="n">fields</span><span class="p">())</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbase</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">fet</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
                                <span class="n">idparent</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
                                <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">layerexport</span><span class="o">.</span><span class="n">fields</span><span class="p">()]</span>
                                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">fields</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">:</span>
                                        <span class="n">fet</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span>
                                <span class="n">fet</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="nb">bool</span> <span class="o">=</span> <span class="n">layerexport</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">fet</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">bool</span><span class="p">:</span>
                                    <span class="n">layerexport</span><span class="o">.</span><span class="n">updateFeature</span><span class="p">(</span><span class="n">fet</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="n">idparent</span><span class="p">,</span> <span class="s1">&#39;non exporte&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="p">[</span><span class="n">dbasename</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">idparent</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureaddedid</span><span class="p">)</span>
                    <span class="n">layerexport</span><span class="o">.</span><span class="n">featureAdded</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureAdded</span><span class="p">)</span>

        <span class="c1"># print(self.linkedids)</span>

        <span class="c1"># reassign linked ids</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">exportdbase</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;_point&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">():</span>
                <span class="n">dbasename</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;_line&#39;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">():</span>
                <span class="n">dbasename</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbasename</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
            <span class="n">exec</span> <span class="p">(</span><span class="s2">&quot;dbase = self.dbase_&quot;</span> <span class="o">+</span> <span class="n">dbasename</span><span class="p">)</span>

            <span class="c1"># if dbasename in self.linkedids.keys():</span>

            <span class="k">if</span> <span class="n">dbase</span><span class="p">[</span><span class="s1">&#39;linkfield&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">dbase</span><span class="p">[</span><span class="s1">&#39;linkfield&#39;</span><span class="p">]:</span>
                    <span class="c1"># print(dbasename,link)</span>
                    <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dbasename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                            <span class="n">linkparenttouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">linkchildtouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="p">[</span><span class="n">dbasename</span><span class="p">]</span>

                            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">dbasename</span><span class="p">,</span> <span class="s1">&#39;***************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">linkparenttouse</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">linkchildtouse</span><span class="p">)</span>

                            <span class="n">request</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterFids</span><span class="p">(</span><span class="n">linkchildtouse</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="k">with</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPyNullVariant</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span> <span class="ow">in</span> <span class="n">linkparenttouse</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                            <span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">linkparenttouse</span><span class="p">[</span><span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
                                            <span class="n">layer</span><span class="o">.</span><span class="n">updateFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                                            <span class="n">layer</span><span class="o">.</span><span class="n">updateFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                                        <span class="n">layer</span><span class="o">.</span><span class="n">updateFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dbasename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                            <span class="n">linkchildtouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="p">[</span><span class="n">dbasename</span><span class="p">]</span>
                            <span class="n">request</span> <span class="o">=</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterFids</span><span class="p">(</span><span class="n">linkchildtouse</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="k">with</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
                                    <span class="n">parentlayertrigram</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                    <span class="k">if</span> <span class="n">parentlayertrigram</span> <span class="ow">in</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase_tables</span><span class="p">]:</span>
                                        <span class="n">parentlayername</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase_tables</span><span class="p">[[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbase_tables</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parentlayertrigram</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="n">parentlayername</span> <span class="ow">in</span>  <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                            <span class="n">linkparenttouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkedids</span><span class="p">[</span><span class="n">parentlayername</span><span class="p">]</span>

                                            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                                                <span class="nb">print</span><span class="p">(</span><span class="n">dbasename</span><span class="p">,</span> <span class="s1">&#39;***************&#39;</span><span class="p">)</span>
                                                <span class="nb">print</span><span class="p">(</span><span class="n">linkparenttouse</span><span class="p">)</span>
                                                <span class="nb">print</span><span class="p">(</span><span class="n">linkchildtouse</span><span class="p">)</span>

                                            <span class="k">if</span> <span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">linkparenttouse</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                                <span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">linkparenttouse</span><span class="p">[</span><span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
                                                <span class="n">layer</span><span class="o">.</span><span class="n">updateFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">feat</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                                                <span class="n">layer</span><span class="o">.</span><span class="n">updateFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>

<div class="viewcode-block" id="DBaseParser.featureAdded"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.featureAdded">[docs]</a>    <span class="k">def</span> <span class="nf">featureAdded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Méthode connectée au signal featureAdded d&#39;un qgsvectorlayer pour connaitre le pk du feature ajouté</span>
<span class="sd">        assigne cette valeur à self.featureaddedid</span>
<span class="sd">        :param id: le pk fourni par le signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureaddedid</span> <span class="o">=</span> <span class="nb">id</span></div>

<div class="viewcode-block" id="DBaseParser.getMaxVersionRepository"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getMaxVersionRepository">[docs]</a>    <span class="k">def</span> <span class="nf">getMaxVersionRepository</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typemetier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        REcherche dans Lamia/DBASE/create le repertoire qui correspond au typemetier, avec la plus grande version</span>
<span class="sd">        s&#39;il n&#39;y a pas de version (lamia avant sept.2018) , renvoi le repertoire avec version = None</span>

<span class="sd">        :param typemetier:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">repository</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">createfilesdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;DBASE&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">)</span>
        <span class="n">listrep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">listrep</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">typemetier</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="p">:</span>
                    <span class="n">versiontemp</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">versiontemp</span> <span class="o">&gt;</span> <span class="n">version</span><span class="p">:</span>
                        <span class="n">repository</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span><span class="n">rep</span><span class="p">)</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="n">versiontemp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">typemetier</span> <span class="o">==</span> <span class="n">rep</span> <span class="p">:</span>
                    <span class="n">repository</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span><span class="n">rep</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">repository</span><span class="p">,</span> <span class="n">version</span></div>



<div class="viewcode-block" id="DBaseParser.getVersionRepositories2"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getVersionRepositories2">[docs]</a>    <span class="k">def</span> <span class="nf">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typemetier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        REcherche dans Lamia/DBASE/create le repertoire qui correspond au typemetier, avec la plus grande version</span>
<span class="sd">        s&#39;il n&#39;y a pas de version (lamia avant sept.2018) , renvoi le repertoire avec version = None</span>

<span class="sd">        :param typemetier:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">createfilesdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;DBASE&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;dbase dir : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">))</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">listrep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">listrep</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">typemetier</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="p">:</span>
                        <span class="n">versiontemp</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
                        <span class="k">if</span> <span class="n">versiontemp</span> <span class="o">&gt;</span> <span class="n">version</span><span class="p">:</span>
                            <span class="n">repository</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span><span class="n">rep</span><span class="p">)</span>
                            <span class="n">version</span> <span class="o">=</span> <span class="n">versiontemp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">typemetier</span> <span class="o">==</span> <span class="n">rep</span> <span class="p">:</span>
                        <span class="n">repository</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span><span class="n">rep</span><span class="p">)</span>

        <span class="n">listfiles</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">listfiles</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span><span class="n">filename</span> <span class="p">)</span>
            <span class="n">filebasename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.xls&#39;</span><span class="p">,</span> <span class="s1">&#39;.xlsx&#39;</span><span class="p">]:</span>
                <span class="n">filebasenamesplitted</span> <span class="o">=</span> <span class="n">filebasename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filebasenamesplitted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">filebasenamesplitted</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">filebasenamesplitted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>
                        <span class="ow">and</span> <span class="n">typemetier</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filebasenamesplitted</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="p">):</span>     <span class="c1">#case child of dabse2</span>
                    <span class="n">versiontemp</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filebasename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
                    <span class="n">repository</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">versiontemp</span><span class="p">,</span> <span class="n">repository</span><span class="p">])</span>

                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filebasename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="n">typemetier</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filebasename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="p">:</span>

                            <span class="n">versiontemp</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filebasename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
                            <span class="n">repository</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">versiontemp</span><span class="p">,</span><span class="n">repository</span> <span class="p">])</span>

                            <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">versiontemp</span> <span class="o">&gt;</span> <span class="n">version</span><span class="p">:</span>
                                <span class="n">repository</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
                                <span class="n">version</span> <span class="o">=</span> <span class="n">versiontemp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">typemetier</span> <span class="o">==</span> <span class="n">filebasename</span> <span class="p">:</span>
                            <span class="n">repository</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">createfilesdir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;results: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>

        <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;results: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">results</span></div>



    <span class="k">def</span> <span class="nf">updateDBaseVersion2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Mise à jour de la base de données...&quot;</span><span class="p">)</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;DBASE need an update&#39;</span><span class="p">)</span>

        <span class="n">workversions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">baseversions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">workversionmax</span><span class="p">,</span>  <span class="n">createfilesdir</span><span class="p">,</span> <span class="o">=</span> <span class="n">workversions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">baseversionmax</span><span class="p">,</span> <span class="n">createfilesdirbase</span> <span class="o">=</span> <span class="n">baseversions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;main version projet : </span><span class="si">%s</span><span class="s1">, new : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">),</span>
                                                   <span class="nb">str</span><span class="p">(</span><span class="n">baseversionmax</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;work version projet : </span><span class="si">%s</span><span class="s1">, new : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">),</span>
                                                   <span class="nb">str</span><span class="p">(</span><span class="n">workversionmax</span><span class="p">))</span>

        <span class="n">indexbaseversion</span> <span class="o">=</span> <span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">baseversions</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">indexworkversion</span> <span class="o">=</span> <span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">workversions</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">indexversion</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indexbaseversion</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">baseversions</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateTables</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span>
                              <span class="n">baseversions</span><span class="p">[</span><span class="n">indexversion</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">baseversions</span><span class="p">[</span><span class="n">indexversion</span> <span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>


        <span class="k">for</span> <span class="n">indexversion</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indexworkversion</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">workversions</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateTables</span><span class="p">(</span><span class="s1">&#39;metier&#39;</span><span class="p">,</span>
                              <span class="n">workversions</span><span class="p">[</span><span class="n">indexworkversion</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">workversions</span><span class="p">[</span><span class="n">indexworkversion</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Mise à jour de la base de données terminée&quot;</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">updateTables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typebase</span><span class="p">,</span> <span class="n">oldversion</span><span class="p">,</span> <span class="n">newversion</span> <span class="p">):</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> - old : </span><span class="si">%s</span><span class="s1">, new : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">typebase</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">oldversion</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">newversion</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;type base :&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">typebase</span><span class="p">),</span> <span class="s1">&#39; - oldversion : &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">oldversion</span><span class="p">),</span> <span class="s1">&#39; - newversion &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">newversion</span><span class="p">))</span>


        <span class="n">baseversions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">workversions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersionRepositories2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">typebase</span> <span class="o">==</span> <span class="s1">&#39;base&#39;</span><span class="p">:</span>
            <span class="n">indexnewversion</span> <span class="o">=</span> <span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">baseversions</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">newversion</span><span class="p">)</span>
            <span class="n">filenewversion</span> <span class="o">=</span> <span class="n">baseversions</span><span class="p">[</span><span class="n">indexnewversion</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#updates new columsns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="n">oldversion</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">)</span>
            <span class="n">dictold</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="n">newversion</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">)</span>
            <span class="n">dictnew</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">typebase</span> <span class="o">==</span> <span class="s1">&#39;metier&#39;</span><span class="p">:</span>
            <span class="n">indexnewversion</span> <span class="o">=</span> <span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">workversions</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">newversion</span><span class="p">)</span>
            <span class="n">filenewversion</span> <span class="o">=</span> <span class="n">workversions</span><span class="p">[</span><span class="n">indexnewversion</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#updates new columsns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="n">oldversion</span><span class="p">)</span>
            <span class="n">dictold</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="n">newversion</span><span class="p">)</span>
            <span class="n">dictnew</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">)</span>



        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">dictnew</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dictnew</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dictold</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;diff : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;diff :&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE &#39;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s1">&#39; ADD COLUMN &#39;</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;VARCHAR&#39;</span> <span class="ow">in</span> <span class="n">dictnew</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; TEXT &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgtypetosltype</span><span class="p">[</span><span class="n">dictnew</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="n">dictnew</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="c1"># read potential python file</span>
        <span class="n">pythonfile</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filenewversion</span><span class="p">)</span>
        <span class="n">pythonfile</span> <span class="o">=</span> <span class="n">pythonfile</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pythonfile</span><span class="p">):</span>
            <span class="n">pyfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pythonfile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">pyfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">pyfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">exec</span> <span class="p">(</span><span class="n">text</span><span class="p">)</span>


        <span class="c1">#update version</span>
        <span class="k">if</span> <span class="n">typebase</span> <span class="o">==</span> <span class="s1">&#39;base&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">newversion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span>
        <span class="k">elif</span> <span class="n">typebase</span> <span class="o">==</span> <span class="s1">&#39;metier&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="o">=</span> <span class="n">newversion</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Basedonnees SET version = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workversion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;,workversion = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">updateDBaseVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Mise à jour de la base de données...&quot;</span><span class="p">)</span>


        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;DBASE need an update&#39;</span><span class="p">)</span>

        <span class="n">createfilesdir</span><span class="p">,</span> <span class="n">workversionmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxVersionRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">createfilesdirbase</span><span class="p">,</span> <span class="n">baseversionmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxVersionRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;main version projet : </span><span class="si">%s</span><span class="s1">, new : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">baseversionmax</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;work version projet : </span><span class="si">%s</span><span class="s1">, new : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">workversionmax</span><span class="p">))</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlsreader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">)</span>
            <span class="n">dictold</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="n">baseversionmax</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="n">workversionmax</span><span class="p">)</span>
            <span class="n">dictnew</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workversion</span><span class="p">)</span>
            <span class="n">dictold</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDBDictionary2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">baseversiontoread</span><span class="o">=</span><span class="n">baseversionmax</span><span class="p">,</span> <span class="n">workversiontoread</span><span class="o">=</span><span class="n">workversionmax</span><span class="p">)</span>
            <span class="n">dictnew</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">)</span>





        <span class="n">results</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">dictnew</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dictnew</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dictold</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;diff : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>


        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE &#39;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s1">&#39; ADD COLUMN &#39;</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;spatialite&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlsreader</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pgtypetosltype</span><span class="p">[</span><span class="n">dictnew</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="n">dictnew</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;SLtype&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetype</span> <span class="o">==</span> <span class="s1">&#39;postgis&#39;</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="n">dictnew</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;PGtype&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>



        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Basedonnees SET version = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">baseversionmax</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">if</span> <span class="n">workversionmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;,workversion = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">workversionmax</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Mise à jour de la base de données terminée&quot;</span><span class="p">)</span>






<div class="viewcode-block" id="DBaseParser.getParentTable"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.getParentTable">[docs]</a>    <span class="k">def</span> <span class="nf">getParentTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Parents table name</span>
<span class="sd">        :param tablename:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parenttablenamelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
        <span class="n">continuesearchparent</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">while</span> <span class="n">continuesearchparent</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dbasetable</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">continuesearchparent</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="s1">&#39;lpk_&#39;</span> <span class="o">==</span> <span class="n">field</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
                    <span class="n">tablename</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                    <span class="n">parenttablenamelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
                    <span class="n">dbasetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;objet&#39;</span><span class="p">:</span>
                        <span class="n">continuesearchparent</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">continuesearchparent</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">parenttablenamelist</span></div>




<div class="viewcode-block" id="DBaseParser.importDbase"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.importDbase">[docs]</a>    <span class="k">def</span> <span class="nf">importDbase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbaseparserfrom</span><span class="p">,</span> <span class="n">typeimport</span><span class="o">=</span><span class="s1">&#39;nouvelle&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param dbaseparserfrom:</span>
<span class="sd">        :param typeimport:  nouvelle import_terrain</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start &#39;</span><span class="p">)</span>
            <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backupBase</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#if not self.dbase.standalone:</span>
            <span class="n">progressMessageBar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">createMessage</span><span class="p">(</span><span class="s2">&quot;Import des donnees...&quot;</span><span class="p">)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">()</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span><span class="p">)</span>
            <span class="n">progressMessageBar</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>
            <span class="c1">#len</span>
            <span class="n">maxprogress</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">maxprogress</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ********** Variables générales ***********************************</span>
        <span class="c1"># import dict : {tablename : {...{idfrom : idto} ...} }</span>
        <span class="c1"># utilise pour la correspondance entre les id de la table d&#39;import et les id de la table main</span>
        <span class="n">importdictid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># import dict : {tablename : {...{pkfrom : pkto} ...} }</span>
        <span class="c1"># utilise pour la correspondance entre les pk de la table d&#39;import et les pk de la table main</span>
        <span class="n">importdictpk</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># import dict : {tablename : [pk1, pk2,..] }</span>
        <span class="c1"># utilise pour se souvenir des pk qui ont un revsionend</span>
        <span class="n">importdictdeletedpk</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#conflictobjetids dict : {..., idobjet:{fields : [], importvalue:[], mainvalue:[]},... }</span>
        <span class="n">conflictobjetids</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># ************** add version</span>
        <span class="n">datedebutimport</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">typeimport</span> <span class="o">==</span> <span class="s1">&#39;nouvelle&#39;</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;import&#39;</span>
        <span class="k">elif</span> <span class="n">typeimport</span> <span class="o">==</span> <span class="s1">&#39;import_terrain&#39;</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;import_terrain&#39;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Revision(datetimerevision, commentaire) &quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; VALUES(&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datedebutimport</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">comment</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxRevision</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentrevision</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateWorkingDate</span><span class="p">()</span>

        <span class="c1"># **************** date de la version d&#39;import</span>
        <span class="n">datetravailhorsligne</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">typeimport</span> <span class="o">==</span> <span class="s1">&#39;import_terrain&#39;</span><span class="p">:</span>
            <span class="c1"># datetravailhorsligne</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT datetimerevision FROM Revision WHERE pk_revision = 2&quot;</span>
            <span class="n">datetravailhorsligne</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># **************** debut de l&#39;iteration sur les tables à importer</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">:</span>

                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span> <span class="n">progressMessageBar</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Import des donnees... : &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setLoadingProgressBar</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>



                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; ******************* </span><span class="si">%s</span><span class="s1"> *********  &#39;</span><span class="p">,</span> <span class="n">dbname</span><span class="p">)</span>

                    <span class="c1"># initialisation des variables génerales</span>
                    <span class="n">importdictid</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">importdictpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># get non critical fields (not pk and non id)</span>
                    <span class="n">noncriticalfield</span> <span class="o">=</span> <span class="p">[]</span>           <span class="c1"># the &quot;non-critical&quot; fields</span>
                    <span class="n">pkidfields</span> <span class="o">=</span> <span class="p">[]</span>                 <span class="c1"># the &quot;critical&quot; fields (pk; id, lpk, lid)</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id_&#39;</span><span class="p">,</span> <span class="s1">&#39;pk_&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lpk_&#39;</span><span class="p">,</span> <span class="s1">&#39;lid_&#39;</span><span class="p">]:</span>
                            <span class="n">pkidfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="c1">#add geom at rank-1</span>
                    <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ST_AsText(ST_Transform(geom,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">noncriticalfield</span><span class="p">:</span>
                        <span class="n">noncriticalfield</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; fields, critical : </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span>
                                                               <span class="nb">str</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">pkidfields</span><span class="p">))</span>

                    <span class="c1"># request results from dbaseparserfrom</span>
                    <span class="k">if</span> <span class="n">typeimport</span> <span class="o">==</span> <span class="s1">&#39;nouvelle&#39;</span><span class="p">:</span>
                        <span class="n">sqlconstraint</span> <span class="o">=</span> <span class="s2">&quot; WHERE lpk_revision_end IS NULL&quot;</span>
                    <span class="k">elif</span> <span class="n">typeimport</span> <span class="o">==</span> <span class="s1">&#39;import_terrain&#39;</span><span class="p">:</span>
                        <span class="n">sqlconstraint</span> <span class="o">=</span> <span class="s2">&quot; WHERE lpk_revision_begin = 2 OR lpk_revision_end = 2&quot;</span>

                    <span class="n">sql</span><span class="p">,</span> <span class="n">sqlpk</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;Objet&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParentTable</span><span class="p">(</span><span class="n">dbname</span><span class="p">):</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="n">sqlconstraint</span>
                        <span class="n">sqlpk</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkidfields</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                        <span class="n">sqlpk</span> <span class="o">+=</span> <span class="n">sqlconstraint</span>
                    <span class="k">elif</span> <span class="s1">&#39;lpk_revision_end&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="n">sqlconstraint</span>
                        <span class="n">sqlpk</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkidfields</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">sqlpk</span> <span class="o">+=</span> <span class="n">sqlconstraint</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">sqlpk</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkidfields</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                    <span class="n">resultpk</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqlpk</span><span class="p">)</span>


                    <span class="n">strtofind</span> <span class="o">=</span> <span class="s1">&#39;ST_AsText(ST_Transform(geom,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span>
                    <span class="k">if</span> <span class="n">strtofind</span> <span class="ow">in</span> <span class="n">noncriticalfield</span><span class="p">:</span>
                        <span class="n">noncriticalfield</span><span class="p">[</span><span class="n">noncriticalfield</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">strtofind</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;geom&#39;</span>

                    <span class="c1"># get previoux existing id and other things for import terrain</span>
                    <span class="n">resultsid</span> <span class="o">=</span> <span class="kc">None</span>            <span class="c1"># the existing id in main table</span>
                    <span class="n">indexidfield</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># the index of id_ column</span>
                    <span class="n">indexrevisionend</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># the index of lpk_revision_end</span>
                    <span class="n">indexpkdbase</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># the index of pk_ column</span>
                    <span class="n">importid</span> <span class="o">=</span> <span class="kc">None</span>             <span class="c1"># the id in the table lines iteration</span>
                    <span class="n">parenttable</span> <span class="o">=</span> <span class="kc">None</span>          <span class="c1"># the parent table of actual table - defined as lpk_(parenttable)</span>
                    <span class="n">indexlkparenttable</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># the index of parent table in pkidfields</span>

                    <span class="k">if</span> <span class="n">typeimport</span> <span class="o">==</span> <span class="s1">&#39;import_terrain&#39;</span><span class="p">:</span>
                        <span class="c1"># get resultsid and indexidfield</span>
                        <span class="k">if</span> <span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">pkidfields</span><span class="p">:</span>
                            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">sqlid</span> <span class="o">=</span> <span class="s2">&quot;SELECT id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                                <span class="n">sqlid</span> <span class="o">+=</span> <span class="s2">&quot; WHERE lpk_revision_begin = 1 &quot;</span>
                                <span class="n">resultsid</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqlid</span><span class="p">)]</span>

                            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                                <span class="n">sqlid</span> <span class="o">=</span> <span class="s2">&quot;SELECT id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                                <span class="n">sqlid</span> <span class="o">+=</span> <span class="s2">&quot; WHERE datetimecreation &lt; &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetravailhorsligne</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                <span class="n">resultsid</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqlid</span><span class="p">)]</span>
                            <span class="n">indexidfield</span> <span class="o">=</span> <span class="n">pkidfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                        <span class="c1"># get indexrevisionend</span>
                        <span class="k">if</span> <span class="s2">&quot;lpk_revision_end&quot;</span> <span class="ow">in</span> <span class="n">pkidfields</span><span class="p">:</span>
                            <span class="n">indexrevisionend</span> <span class="o">=</span> <span class="n">pkidfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;lpk_revision_end&#39;</span><span class="p">)</span>
                        <span class="n">indexpkdbase</span> <span class="o">=</span> <span class="n">pkidfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                        <span class="c1"># get eventual parenttable</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pkidfields</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">fieldname</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lpk_&#39;</span><span class="p">:</span>
                                <span class="n">parenttable</span> <span class="o">=</span> <span class="n">fieldname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">indexlkparenttable</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; parenttable, index : </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span>
                                                                   <span class="nb">str</span><span class="p">(</span><span class="n">parenttable</span><span class="p">),</span>
                                                                   <span class="nb">str</span><span class="p">(</span><span class="n">indexlkparenttable</span><span class="p">))</span>

                    <span class="c1"># start the iteration in table lines</span>
                    <span class="c1"># if results is not None:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; result : </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">resultsid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">importid</span> <span class="o">=</span> <span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexidfield</span><span class="p">]</span>

                        <span class="c1"># id already exists before - search if it was modified</span>
                        <span class="k">if</span> <span class="n">resultsid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">importid</span> <span class="ow">in</span> <span class="n">resultsid</span><span class="p">:</span>
                            <span class="c1"># get its  datemodif</span>
                            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                                <span class="n">sqldate</span> <span class="o">=</span> <span class="s2">&quot; SELECT datetimemodification FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                                <span class="n">sqldate</span> <span class="o">+=</span> <span class="s2">&quot; WHERE id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">)</span>
                                <span class="n">sqldate</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end IS NULL&quot;</span>
                            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">sqldate</span> <span class="o">=</span> <span class="s2">&quot; SELECT MAX(datetimemodification) FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                                <span class="n">sqldate</span> <span class="o">+=</span> <span class="s2">&quot; WHERE id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">)</span>
                            <span class="n">resultdatesql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqldate</span><span class="p">)</span>
                            <span class="n">resultdate</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">resultdatesql</span> <span class="p">:</span> <span class="c1"># cases 3, 5, 6, 8, 9</span>
                                <span class="n">resultdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqldate</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>       <span class="c1"># case 4 or 7 : line deleted in main</span>
                                <span class="k">pass</span>

                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>  <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;**** existing id : </span><span class="si">%s</span><span class="s1"> / date main : </span><span class="si">%s</span><span class="s1"> / date2 : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">resultdate</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetravailhorsligne</span><span class="p">))</span>

                            <span class="c1"># Search if possible conflict</span>
                            <span class="c1"># isinconflict = False</span>
                            <span class="k">if</span> <span class="n">resultdate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>  <span class="c1"># case 4 or 7</span>
                                <span class="c1"># not modified while field investigation- create new version - done</span>
                                <span class="k">if</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;objet&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">isinconflict</span><span class="p">,</span> <span class="n">listfields</span><span class="p">,</span> <span class="n">listvaluemain</span><span class="p">,</span> <span class="n">listvalueimport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInConflict</span><span class="p">(</span><span class="n">dbaseparserfrom</span><span class="p">,</span> <span class="n">importid</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;in conflict : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">isinconflict</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;date : </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">resultdate</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetravailhorsligne</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">isinconflict</span><span class="p">:</span>
                                        <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">importid</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
                                        <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">importid</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">listfields</span>
                                        <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">importid</span><span class="p">][</span><span class="s1">&#39;mainvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listvaluemain</span>
                                        <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">importid</span><span class="p">][</span><span class="s1">&#39;importvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listvalueimport</span>

                            <span class="k">elif</span> <span class="n">resultdate</span> <span class="o">&lt;</span> <span class="n">datetravailhorsligne</span> <span class="ow">or</span> <span class="n">resultdate</span> <span class="o">&gt;</span> <span class="n">datedebutimport</span><span class="p">:</span>     <span class="c1">#case 1, 3 - no conflict</span>
                                <span class="k">pass</span>






                            <span class="k">else</span><span class="p">:</span>     <span class="c1"># cases  5, 6, 8, 9</span>
                                <span class="k">if</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;objet&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">isinconflict</span><span class="p">,</span> <span class="n">listfields</span><span class="p">,</span> <span class="n">listvaluemain</span><span class="p">,</span> <span class="n">listvalueimport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInConflict</span><span class="p">(</span><span class="n">dbaseparserfrom</span><span class="p">,</span> <span class="n">importid</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;in conflict : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">isinconflict</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;date : </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">resultdate</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetravailhorsligne</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">isinconflict</span><span class="p">:</span>
                                        <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">importid</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
                                        <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">importid</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">listfields</span>
                                        <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">importid</span><span class="p">][</span><span class="s1">&#39;mainvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listvaluemain</span>
                                        <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">importid</span><span class="p">][</span><span class="s1">&#39;importvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listvalueimport</span>

                            <span class="c1"># **** in all cases, create a new line or set revisionend  with import table value *****</span>
                            <span class="c1">#   eventualy rewrite it when conflict process</span>

                            <span class="c1"># deleted id case</span>
                            <span class="c1"># its sure its an existing pk</span>
                            <span class="c1"># case 3a, 4a, 5a, 6a, 7a, 8a, 9a</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">typeimport</span> <span class="o">==</span> <span class="s1">&#39;import_terrain&#39;</span> <span class="ow">and</span> <span class="n">indexrevisionend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                    <span class="ow">and</span> <span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexrevisionend</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>

                                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; set revisionend id, date: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">resultdate</span><span class="p">))</span>

                                <span class="c1"># case 4a or 7a</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">resultdate</span><span class="p">:</span>
                                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">)</span>
                                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end IS NULL&quot;</span>
                                    <span class="n">resultcase</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">resultcase</span><span class="p">:</span>  <span class="c1"># case 4a : do nothing - wait for active rev line</span>
                                        <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>    <span class="c1"># case 7a : do nothing</span>
                                        <span class="k">pass</span>

                                <span class="c1"># cases 3a, 5a, 6a, 8a, 9a, 10a, 11a</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># simply set lpk_revision_end to main table</span>
                                    <span class="k">if</span> <span class="s1">&#39;lpk_revision_end&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                        <span class="c1"># search latest pk in main with same id</span>
                                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM  &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">)</span>
                                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end IS NULL&quot;</span>
                                        <span class="n">sqlpkmain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                                        <span class="c1"># sqlpkimport = dbaseparserfrom.query(sql)</span>

                                        <span class="c1"># add pk to importdictdeletedpk</span>
                                        <span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexpkdbase</span><span class="p">])</span>

                                        <span class="k">if</span> <span class="n">sqlpkmain</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="n">pkmain</span> <span class="o">=</span> <span class="n">sqlpkmain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">datesuppr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
                                            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; SET lpk_revision_end = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
                                            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; , datetimemodification = &#39;&quot;</span> <span class="o">+</span> <span class="n">datesuppr</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkmain</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


                                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>

                                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">)</span>
                                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end IS NULL &quot;</span>
                                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND datetimemodification &gt; &#39;&quot;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetravailhorsligne</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                        <span class="n">resultcase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                                        <span class="k">if</span> <span class="n">resultcase</span><span class="p">:</span>  <span class="c1">#case 3a, 6a, 9a : revend to main line without possible conflict</span>
                                            <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">pass</span>


                                        <span class="k">if</span> <span class="s1">&#39;lpk_revision_end&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                            <span class="n">datesuppr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
                                            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; SET lpk_revision_end = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
                                            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; , datetimemodification = &#39;&quot;</span> <span class="o">+</span> <span class="n">datesuppr</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexpkdbase</span><span class="p">])</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                                            <span class="c1"># add pk to importdictdeletedpk</span>
                                            <span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexpkdbase</span><span class="p">])</span>

                                            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                                                <span class="c1"># search if another id is in main and not in import</span>
                                                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM  &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE id_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">)</span>
                                                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end IS NULL&quot;</span>
                                                <span class="n">idmain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                                                <span class="n">idimport</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                                                <span class="k">if</span> <span class="ow">not</span> <span class="n">idimport</span> <span class="ow">and</span> <span class="n">idmain</span><span class="p">:</span>        <span class="c1"># simple delete from import and remain in main</span>
                                                    <span class="n">pkmain</span> <span class="o">=</span> <span class="n">idmain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; SET lpk_revision_end = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
                                                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; , datetimemodification = &#39;&quot;</span> <span class="o">+</span> <span class="n">datesuppr</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                                                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkmain</span><span class="p">)</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>





                            <span class="c1"># if parent table pk is in  importdictdeletedpk</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">parenttable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                  <span class="ow">and</span> <span class="n">parenttable</span> <span class="ow">in</span> <span class="n">importdictdeletedpk</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                  <span class="ow">and</span> <span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexlkparenttable</span><span class="p">]</span> <span class="ow">in</span> <span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">parenttable</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; parent revisionend : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">))</span>
                                <span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexpkdbase</span><span class="p">])</span>


                            <span class="c1"># new version case</span>
                            <span class="c1"># case 3b, 4b, 5b, 6b, 11b</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; new elem : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">))</span>
                                <span class="c1"># insert new line in main table</span>
                                <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;INSERT&#39;</span><span class="p">,</span>
                                                                  <span class="n">tablename</span><span class="o">=</span><span class="n">dbname</span><span class="p">,</span>
                                                                  <span class="n">listoffields</span><span class="o">=</span><span class="n">noncriticalfield</span><span class="p">,</span>
                                                                  <span class="n">listofrawvalues</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="c1"># udpate id/pk fields without changing id_table value</span>
                                <span class="n">sqlup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updateIdPkSqL</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="n">dbname</span><span class="p">,</span>
                                                           <span class="n">listoffields</span><span class="o">=</span><span class="n">pkidfields</span><span class="p">,</span>
                                                           <span class="n">listofrawvalues</span><span class="o">=</span><span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                           <span class="n">dictpk</span><span class="o">=</span><span class="n">importdictpk</span><span class="p">,</span>
                                                           <span class="n">dictid</span><span class="o">=</span><span class="n">importdictid</span><span class="p">,</span>
                                                           <span class="n">changeID</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqlup</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>



                        <span class="c1"># id does not exists before - create new line or for tc</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;****  new elem id : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">))</span>

                            <span class="k">if</span> <span class="p">(</span><span class="n">typeimport</span> <span class="o">==</span> <span class="s1">&#39;import_terrain&#39;</span> <span class="ow">and</span> <span class="n">indexrevisionend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                    <span class="ow">and</span> <span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexrevisionend</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                                <span class="c1"># case of line deleted in main and deleted in import - dont t process it</span>
                                <span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexpkdbase</span><span class="p">])</span>



                            <span class="k">elif</span> <span class="p">(</span><span class="n">parenttable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                  <span class="ow">and</span> <span class="n">parenttable</span> <span class="ow">in</span> <span class="n">importdictdeletedpk</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                  <span class="ow">and</span> <span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexlkparenttable</span><span class="p">]</span> <span class="ow">in</span> <span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">parenttable</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; parent revisionend : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">importid</span><span class="p">))</span>
                                <span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indexpkdbase</span><span class="p">])</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># traite la mise en forme du result</span>
                                <span class="k">if</span> <span class="n">noncriticalfield</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]:</span>
                                    <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;INSERT&#39;</span><span class="p">,</span>
                                                                      <span class="n">tablename</span><span class="o">=</span><span class="n">dbname</span><span class="p">,</span>
                                                                      <span class="n">listoffields</span><span class="o">=</span><span class="n">noncriticalfield</span><span class="p">,</span>
                                                                      <span class="n">listofrawvalues</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO &quot;</span> <span class="o">+</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s2">&quot; DEFAULT VALUES&quot;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                                <span class="c1"># traite les id, pk et lid et lpk</span>
                                <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="n">sqlup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updateIdPkSqL</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="n">dbname</span><span class="p">,</span>
                                                               <span class="n">listoffields</span><span class="o">=</span><span class="n">pkidfields</span><span class="p">,</span>
                                                               <span class="n">listofrawvalues</span><span class="o">=</span><span class="n">resultpk</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                               <span class="n">dictpk</span><span class="o">=</span><span class="n">importdictpk</span><span class="p">,</span>
                                                               <span class="n">dictid</span><span class="o">=</span><span class="n">importdictid</span><span class="p">,</span>
                                                               <span class="n">changeID</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


                                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sqlup</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                                <span class="c1"># Ressource case : copy file</span>
                                <span class="k">if</span> <span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;Ressource&#39;</span><span class="p">:</span>
                                    <span class="n">indexfile</span> <span class="o">=</span> <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
                                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">indexfile</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAttributeNull</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                                        <span class="n">filefrom</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">completePathOfFile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                                        <span class="n">fileto</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">copyRessourceFile</span><span class="p">(</span><span class="n">fromfile</span><span class="o">=</span><span class="n">filefrom</span><span class="p">,</span>
                                                               <span class="n">tofile</span><span class="o">=</span><span class="n">fileto</span><span class="p">,</span>
                                                               <span class="n">withthumbnail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                               <span class="n">copywholedirforraster</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># Finaly commit all</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; importdictid </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">importdictid</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]))</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; importdictpk </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">importdictpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]))</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; importdictdeletedpk </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">importdictdeletedpk</span><span class="p">[</span><span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]))</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; conflictobjetids </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetids</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolveConflict</span><span class="p">(</span><span class="n">dbaseparserfrom</span><span class="p">,</span><span class="n">conflictobjetids</span> <span class="p">)</span>


        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refreshAllLayers</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">clearWidgets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalMessage</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Import termine&quot;</span><span class="p">)</span></div>




<div class="viewcode-block" id="DBaseParser.isInConflict"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.isInConflict">[docs]</a>    <span class="k">def</span> <span class="nf">isInConflict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbaseparserfrom</span><span class="p">,</span> <span class="n">conflictobjetid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        cases: (datet : datetravail)</span>
<span class="sd">        MAin                                             Import</span>
<span class="sd">        case n° datem       revbegin    revend          datem       revbegin    revend      Action                              Action on import                    Action if main retained</span>
<span class="sd">        1       &lt;datet      11                          &lt;datet      1                       nothing modified                    /                                   /</span>
<span class="sd">        2       &gt;datet      11                          &lt;datet      1                       only main modified - ok             /                                   /</span>
<span class="sd">        3       &lt;datet      11                          &gt;datet      1           2           only import modified ok             close lastrev and create new rev    /</span>
<span class="sd">                                                        &gt;datet      2</span>
<span class="sd">        4       suppr                                   &gt;datet      1           2           conflict                            add new rev with same id            close new rev</span>
<span class="sd">                                                        &gt;datet      2</span>
<span class="sd">        5       &gt;datet      11          12              &gt;datet      1           2           conflict                            rewrite main new rev                rewrite new rev with main</span>
<span class="sd">                &gt;datet      12                          &gt;datet      2</span>
<span class="sd">        6       &gt;datet      11          12              &gt;datet      1           2           conflict                            add new rev                         close new rev</span>
<span class="sd">                                                        &gt;datet      2</span>
<span class="sd">        7       suppr                                   &gt;datet      1           2           ok : deleted on main and import     /                                   /</span>
<span class="sd">        8       &gt;datet      11          12              &gt;datet      1           2           conflict                            close lastrev                      write new rev with main</span>
<span class="sd">                &gt;datet      12</span>
<span class="sd">        9       &gt;datet      11                          &gt;datet      1           2           conflit                             close lastrev                       unclose lastrev</span>
<span class="sd">        10      &gt;datet      11          12              &gt;datet      1           2           ok : deleted on main and import     /                                   /</span>
<span class="sd">        11      &gt;datet      11          12              &gt;datet      1           2           conlit                              add new rev                         /  close las rev</span>
<span class="sd">                                                        &gt;datet      2</span>

<span class="sd">        :param dbaseparserfrom:</span>
<span class="sd">        :param conflictobjetid:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; isInConflict - idobjet : </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetid</span><span class="p">))</span>

        <span class="c1"># get mainpkobjet and importpkobjet</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT MAX(pk_objet) FROM Objet WHERE id_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetid</span><span class="p">)</span>
        <span class="n">mainpkobjetsql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">importpkobjetsql</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>





        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT pk_objet FROM Objet WHERE id_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetid</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end IS NULL&quot;</span>
            <span class="n">mainpkobjet</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">resmain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resmain</span><span class="p">:</span>
                <span class="n">mainpkobjet</span> <span class="o">=</span> <span class="n">resmain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">importpkobjet</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">resimport</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resimport</span><span class="p">:</span>
                <span class="n">importpkobjet</span> <span class="o">=</span> <span class="n">resimport</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">mainpkobjet</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT pk_objet FROM Objet WHERE id_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetid</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end = MAX(lpk_revision_end)&quot;</span>


        <span class="c1"># print(&#39;mainpkobjetsql&#39;,mainpkobjetsql,conflictobjetid)</span>
        <span class="k">if</span> <span class="n">mainpkobjetsql</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#cases 3, 5, 6, 8, 9</span>

            <span class="n">mainpkobjet</span> <span class="o">=</span> <span class="n">mainpkobjetsql</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">importpkobjet</span> <span class="o">=</span> <span class="n">importpkobjetsql</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># get child table name and pk</span>
            <span class="n">mainconflictdbname</span><span class="p">,</span> <span class="n">mainconflictpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchChildfeatureFromPkObjet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mainpkobjet</span><span class="p">)</span>
            <span class="n">importconflictdbname</span><span class="p">,</span> <span class="n">importconflictpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchChildfeatureFromPkObjet</span><span class="p">(</span><span class="n">dbaseparserfrom</span><span class="p">,</span> <span class="n">importpkobjet</span><span class="p">)</span>

            <span class="c1">#get revend of pk</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT lpk_revision_end FROM &quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mainconflictpk</span><span class="p">)</span>
            <span class="n">revendmain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT lpk_revision_end FROM &quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importconflictpk</span><span class="p">)</span>
            <span class="n">revendimport</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


            <span class="k">if</span> <span class="n">revendimport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">revendmain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>     <span class="c1"># main and import has been deleted - non conflict</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="c1"># construct column names (usefull if both tables are not in same order)</span>
            <span class="c1"># allfields = &#39;, &#39;.join(self.getAllFields(mainconflictdbname))</span>
            <span class="n">allfieldslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAllFields</span><span class="p">(</span><span class="n">mainconflictdbname</span><span class="p">)</span>


            <span class="c1"># values from child table</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allfieldslist</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mainconflictpk</span><span class="p">)</span>
            <span class="n">resmain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allfieldslist</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importconflictpk</span><span class="p">)</span>
            <span class="n">resimport</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># fields = self.getColumns(mainconflictdbname.lower() + &quot;_qgis&quot;)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">allfieldslist</span>

            <span class="c1"># get geom</span>
            <span class="n">resgeom1</span><span class="p">,</span> <span class="n">resgeom2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT ST_AsText(geom) FROM &quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mainconflictpk</span><span class="p">)</span>
                <span class="n">resgeommain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT ST_AsText(geom) FROM &quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importconflictpk</span><span class="p">)</span>
                <span class="n">resgeomimport</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;resmain&#39;</span><span class="p">,</span><span class="n">resmain</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;resimport&#39;</span><span class="p">,</span><span class="n">resimport</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;resgeommain&#39;</span><span class="p">,</span><span class="n">resgeommain</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;resgeomimport&#39;</span><span class="p">,</span> <span class="n">resgeomimport</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT pk_objet FROM Objet WHERE id_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetid</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end = 2&quot;</span>
            <span class="n">mainpkobjetsql</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="n">mainpkobjet</span> <span class="o">=</span> <span class="n">mainpkobjetsql</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">importpkobjet</span> <span class="o">=</span> <span class="n">importpkobjetsql</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">mainpkobjet</span> <span class="o">==</span> <span class="n">importpkobjet</span><span class="p">:</span>   <span class="c1">#main was deleted and import also - no conflict</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>



            <span class="n">mainconflictdbname</span><span class="p">,</span> <span class="n">mainconflictpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchChildfeatureFromPkObjet</span><span class="p">(</span><span class="n">dbaseparserfrom</span><span class="p">,</span> <span class="n">mainpkobjet</span><span class="p">)</span>
            <span class="n">importconflictdbname</span><span class="p">,</span> <span class="n">importconflictpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchChildfeatureFromPkObjet</span><span class="p">(</span><span class="n">dbaseparserfrom</span><span class="p">,</span> <span class="n">importpkobjet</span><span class="p">)</span>

            <span class="c1"># construct column names (usefull if both tables are not in same order)</span>
            <span class="n">allfieldslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAllFields</span><span class="p">(</span><span class="n">mainconflictdbname</span><span class="p">)</span>

            <span class="c1"># values from child table</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allfieldslist</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mainconflictpk</span><span class="p">)</span>
            <span class="n">resmain</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allfieldslist</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importconflictpk</span><span class="p">)</span>
            <span class="n">resimport</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># fields = self.getColumns(mainconflictdbname.lower() + &quot;_qgis&quot;)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">allfieldslist</span>

            <span class="c1"># get geom</span>
            <span class="n">resgeom1</span><span class="p">,</span> <span class="n">resgeom2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT ST_AsText(geom) FROM &quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">mainconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mainconflictpk</span><span class="p">)</span>
                <span class="n">resgeommain</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT ST_AsText(geom) FROM &quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">importconflictdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">importconflictpk</span><span class="p">)</span>
                <span class="n">resgeomimport</span> <span class="o">=</span> <span class="n">dbaseparserfrom</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>




        <span class="c1"># manage fields in conflict</span>
        <span class="n">conflict1values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># conflict value in main table</span>
        <span class="n">conflict2values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># conflict value in import table</span>
        <span class="n">conflictfields</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># conflict fields in import table</span>


        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">restemp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resmain</span><span class="p">):</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="s1">&#39;datetimecreation&#39;</span><span class="p">,</span> <span class="s1">&#39;datetimemodification&#39;</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;pk_&quot;</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;lpk_&quot;</span>
                    <span class="ow">and</span> <span class="n">restemp</span> <span class="o">!=</span> <span class="n">resimport</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">conflict1values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">restemp</span><span class="p">)</span>
                <span class="n">conflict2values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resimport</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">conflictfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">and</span> <span class="n">resgeommain</span> <span class="o">!=</span> <span class="n">resgeomimport</span><span class="p">:</span>
                <span class="n">conflict1values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resgeommain</span><span class="p">)</span>
                <span class="n">conflict2values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resgeomimport</span><span class="p">)</span>
                <span class="n">conflictfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; isInConflict - conflictfields : </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictfields</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; isInConflict - conflict1values : </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflict1values</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; isInConflict - conflict2values : </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflict2values</span><span class="p">))</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conflict1values</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">conflictfields</span><span class="p">,</span> <span class="n">conflict1values</span><span class="p">,</span> <span class="n">conflict2values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="nf">getAllFields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbasetablename</span><span class="p">):</span>
        <span class="n">parenttables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParentTable</span><span class="p">(</span><span class="n">dbasetablename</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dbasetablename</span><span class="p">]</span>
        <span class="n">fieldlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">parenttables</span><span class="p">:</span>
            <span class="n">fieldlist</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">fieldlist</span>




<div class="viewcode-block" id="DBaseParser.resolveConflict"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.resolveConflict">[docs]</a>    <span class="k">def</span> <span class="nf">resolveConflict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dbaseparserfrom</span><span class="p">,</span><span class="n">conflictobjetids</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                conflictobjetpks[importid][&#39;fields&#39;] =  listfields</span>
<span class="sd">        conflictobjetpks[importid][&#39;mainvalue&#39;] = listvaluemain</span>
<span class="sd">        conflictobjetpks[importid][&#39;importvalue&#39;] = listvalueimport</span>
<span class="sd">        :param dbaseparserfrom:</span>
<span class="sd">        :param conflictobjetpks:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">conflictobjetid</span> <span class="ow">in</span> <span class="n">conflictobjetids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="c1"># cas ou la ligne main a ete supprimee</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT lpk_revision_end FROM Objet WHERE id_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetid</span><span class="p">)</span>
            <span class="n">resendpks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="n">listrevendpks</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">resendpks</span><span class="p">]</span>
            <span class="c1"># id was suppressed before import - re delet it</span>
            <span class="c1"># print(&#39;listrevendpks&#39;, listrevendpks)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span> <span class="ow">in</span> <span class="n">listrevendpks</span><span class="p">:</span>
                <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;mainvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Supprime&#39;</span>

            <span class="c1"># cas ou la ligne import a ete supprimee</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT MAX(pk_objet) FROM Objet WHERE id_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetid</span><span class="p">)</span>
            <span class="n">pkobjet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pkobjet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT  lpk_revision_end FROM Objet WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkobjet</span><span class="p">)</span>
                <span class="n">mainrevend</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mainrevend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;importvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Supprime&#39;</span>

            <span class="c1"># ui demande</span>
            <span class="n">message</span> <span class="o">=</span>  <span class="s2">&quot;ID objet       : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;champs         : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;valeurs import : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;importvalue&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;valeurs main   : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;mainvalue&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">reply</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Keep import values ?&#39;</span><span class="p">,</span>
                                         <span class="n">message</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">)</span>

            <span class="c1"># retour a la valeur du main</span>
            <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;mainvalue&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Supprime&#39;</span><span class="p">:</span>
                    <span class="n">datesuppr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; UPDATE Objet SET &quot;</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;lpk_revision_begin = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;, lpk_revision_end = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;, datetimedestruction = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datesuppr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkobjet</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;importvalue&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Supprime&#39;</span><span class="p">:</span>
                    <span class="c1"># to know if deleted object - case of deleted objet in import and not in main</span>
                    <span class="c1"># sql = &quot; SELECT  lpk_revision_end FROM Objet WHERE pk_objet = &quot; + str(pkobjet)</span>
                    <span class="c1"># mainrevend  = self.query(sql)[0][0]</span>
                    <span class="c1"># if mainrevend is not None:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; UPDATE Objet SET lpk_revision_end = NULL, datetimedestruction = NULL WHERE pk_objet = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkobjet</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


                <span class="n">childdbname</span><span class="p">,</span> <span class="n">childpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchChildfeatureFromPkObjet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkobjet</span><span class="p">)</span>
                <span class="n">parenttables</span> <span class="o">=</span> <span class="p">[</span><span class="n">childdbname</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParentTable</span><span class="p">(</span><span class="n">childdbname</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">parenttables</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT pk_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span>  <span class="n">childdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">childdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">childpk</span><span class="p">)</span>
                    <span class="n">pktable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fieldstomodif</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">valuetoinsert</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]):</span>
                        <span class="c1">#for i, field in enumerate(self.dbasetables[tablename][&#39;fields&#39;]):</span>
                        <span class="c1">#if field in conflictobjetids[conflictobjetid][&#39;fields&#39;]:</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># print(i, field, conflictobjetids[conflictobjetid][&#39;mainvalue&#39;])</span>
                            <span class="n">fieldstomodif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                            <span class="n">valuetoinsert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;mainvalue&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">and</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">fieldstomodif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                            <span class="n">valuetoinsert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conflictobjetids</span><span class="p">[</span><span class="n">conflictobjetid</span><span class="p">][</span><span class="s1">&#39;mainvalue&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">fieldstomodif</span><span class="p">:</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span>
                                                          <span class="n">tablename</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span>
                                                          <span class="n">listoffields</span><span class="o">=</span><span class="n">fieldstomodif</span><span class="p">,</span>
                                                          <span class="n">listofrawvalues</span><span class="o">=</span><span class="n">valuetoinsert</span><span class="p">)</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pktable</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsql</span> <span class="o">=</span> <span class="kc">False</span>


            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span></div>



    <span class="k">def</span> <span class="nf">searchChildfeatureFromPkObjet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dbaseparser</span><span class="p">,</span> <span class="n">pkobjet</span><span class="p">):</span>

        <span class="n">currentdbname</span> <span class="o">=</span> <span class="s2">&quot;Objet&quot;</span>
        <span class="n">currentpk</span> <span class="o">=</span> <span class="n">pkobjet</span>

        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;lpk_&quot;</span> <span class="o">+</span> <span class="n">currentdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT pk_&quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE lpk_&quot;</span> <span class="o">+</span> <span class="n">currentdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">currentpk</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">dbaseparser</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
                            <span class="n">currentdbname</span> <span class="o">=</span> <span class="n">dbname</span>
                            <span class="n">currentpk</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">break</span>

        <span class="k">return</span> <span class="n">currentdbname</span><span class="p">,</span> <span class="n">currentpk</span>




    <span class="k">def</span> <span class="nf">exportDbase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">exportfile</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if not self.dbase.standalone:</span>
            <span class="n">progressMessageBar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">createMessage</span><span class="p">(</span><span class="s2">&quot;Backup...&quot;</span><span class="p">)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">()</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span><span class="p">)</span>
            <span class="n">progressMessageBar</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>
            <span class="c1"># len</span>
            <span class="n">maxprogress</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">maxprogress</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">exportparser</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
        <span class="n">exportparser</span><span class="o">.</span><span class="n">createDbase</span><span class="p">(</span><span class="n">slfile</span><span class="o">=</span><span class="n">exportfile</span><span class="p">,</span>
                                 <span class="n">crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">,</span>
                                 <span class="n">worktype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span> <span class="n">progressMessageBar</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Import des donnees... : &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setLoadingProgressBar</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>

                    <span class="n">noncriticalfield</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>


                    <span class="c1">#add geom at rank-1</span>
                    <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ST_AsText(ST_Transform(geom,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span><span class="p">)</span>


                    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;Objet&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParentTable</span><span class="p">(</span><span class="n">dbname</span><span class="p">):</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_qgis&quot;</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE lpk_revision_end IS NULL&quot;</span>


                    <span class="k">elif</span> <span class="s1">&#39;lpk_revision_end&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE lpk_revision_end IS NULL&quot;</span>


                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;ST_AsText(ST_Transform(geom,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span> <span class="ow">in</span> <span class="n">noncriticalfield</span> <span class="p">:</span>
                        <span class="n">noncriticalfield</span><span class="p">[</span><span class="n">noncriticalfield</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;ST_AsText(ST_Transform(geom,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;geom&#39;</span>


                    <span class="c1"># noncriticalfield.insert(0, &quot;id_&quot; + dbname)</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>

                        <span class="c1">#traite la mise en forme du result</span>
                        <span class="n">restemp</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">noncriticalfield</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">noncriticalfield</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lpk_revision_begin&#39;</span><span class="p">:</span>
                                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                                    <span class="c1"># elif isinstance(res, str) or  ( isinstance(res, unicode) and noncriticalfield[l] != &#39;geom&#39;) :</span>
                                <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">unicode</span><span class="p">))</span> <span class="ow">and</span> <span class="n">noncriticalfield</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                                            <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

                                <span class="k">elif</span> <span class="n">noncriticalfield</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">and</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="c1"># print(&#39;geom&#39;, &quot;ST_GeomFromText(&#39;&quot; + res + &quot;&#39;, &quot; + str(self.crsnumber)  + &quot;)&quot;)</span>
                                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ST_GeomFromText(&#39;&quot;</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span>  <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

                                <span class="k">elif</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

                            <span class="c1"># copy les valeurs</span>
                            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO &quot;</span> <span class="o">+</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; VALUES(&quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">restemp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                                <span class="n">exportparser</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>



                            <span class="c1">#ressource</span>
                            <span class="k">if</span> <span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;Ressource&#39;</span><span class="p">:</span>
                                <span class="n">fileindex</span> <span class="o">=</span> <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">fileindex</span><span class="p">]</span>

                                <span class="n">pkobjetindex</span> <span class="o">=</span> <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;lpk_objet&#39;</span><span class="p">)</span>
                                <span class="n">pkobjet</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">pkobjetindex</span><span class="p">]</span>

                                <span class="n">childdbname</span><span class="p">,</span> <span class="n">childpk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchChildfeatureFromPkObjet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkobjet</span><span class="p">)</span>

                                <span class="c1"># only export reference rasters</span>
                                <span class="k">if</span> <span class="n">childdbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rasters&#39;</span><span class="p">:</span>
                                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT typeraster FROM Rasters_qgis WHERE pk_rasters = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">childpk</span><span class="p">)</span>
                                    <span class="n">typeraster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">typeraster</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ORF&#39;</span><span class="p">,</span> <span class="s1">&#39;IRF&#39;</span><span class="p">]:</span>
                                        <span class="k">continue</span>


                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAttributeNull</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>

                                    <span class="c1"># print(self.dbaseressourcesdirectory,filepath,  exportparser.dbaseressourcesdirectory)</span>

                                    <span class="n">fromfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
                                    <span class="n">tofile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exportparser</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

                                    <span class="bp">self</span><span class="o">.</span><span class="n">copyRessourceFile</span><span class="p">(</span><span class="n">fromfile</span><span class="o">=</span><span class="n">fromfile</span><span class="p">,</span>
                                                           <span class="n">tofile</span><span class="o">=</span><span class="n">tofile</span><span class="p">,</span>
                                                           <span class="n">withthumbnail</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                           <span class="n">copywholedirforraster</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>


                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO &quot;</span> <span class="o">+</span> <span class="n">dbname</span> <span class="o">+</span> <span class="s2">&quot; DEFAULT VALUES&quot;</span>
                            <span class="n">exportparser</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


                    <span class="n">exportparser</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


        <span class="c1">#update seq file to remember last pk of each table</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM sqlite_sequence &quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Revision&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE sqlite_sequence SET seq = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE name = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">exportparser</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="n">datecreation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Revision(datetimerevision, commentaire)  &quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; VALUES(&#39;&quot;</span> <span class="o">+</span> <span class="n">datecreation</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;travail horsligne&#39;)&quot;</span>
        <span class="n">exportparser</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">clearWidgets</span><span class="p">()</span>



    <span class="k">def</span> <span class="nf">backupBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#if not self.dbase.standalone:</span>
            <span class="n">progressMessageBar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">createMessage</span><span class="p">(</span><span class="s2">&quot;Backup...&quot;</span><span class="p">)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">()</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span><span class="p">)</span>
            <span class="n">progressMessageBar</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qgisversion_int</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushWidget</span><span class="p">(</span><span class="n">progressMessageBar</span><span class="p">,</span> <span class="n">qgis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>
            <span class="c1">#len</span>
            <span class="n">maxprogress</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">maxprogress</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start &#39;</span><span class="p">)</span>


        <span class="n">datesuppr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">__%H_%M_%S&quot;</span><span class="p">))</span>
        <span class="c1"># fileexport = os.path.join(exportdir, &#39;backup_&#39; + datesuppr + &#39;.sqlite&#39;)</span>
        <span class="n">exportdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbaseressourcesdirectory</span> <span class="p">,</span> <span class="s1">&#39;backup&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exportdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">exportdir</span><span class="p">)</span>

        <span class="n">fileexport</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exportdir</span><span class="p">,</span> <span class="s1">&#39;backup_&#39;</span> <span class="o">+</span> <span class="n">datesuppr</span> <span class="o">+</span> <span class="s1">&#39;.sqlite&#39;</span><span class="p">)</span>

        <span class="n">exportparser</span> <span class="o">=</span> <span class="n">DBaseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
        <span class="n">exportparser</span><span class="o">.</span><span class="n">createDbase</span><span class="p">(</span><span class="n">slfile</span><span class="o">=</span><span class="n">fileexport</span><span class="p">,</span>
                                 <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">,</span>
                                 <span class="n">worktype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>


        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setLoadingProgressBar</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;basedonnees&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># self.normalMessage.emit(&quot;Export de &quot; + str(dbname))</span>

                    <span class="n">noncriticalfield</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">][</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

                    <span class="c1">#add geom at rank-1</span>
                    <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbasetables</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">noncriticalfield</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ST_AsText(ST_Transform(geom,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span><span class="p">)</span>

                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">noncriticalfield</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;ST_AsText(ST_Transform(geom,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span> <span class="ow">in</span> <span class="n">noncriticalfield</span> <span class="p">:</span>
                        <span class="n">noncriticalfield</span><span class="p">[</span><span class="n">noncriticalfield</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;ST_AsText(ST_Transform(geom,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;geom&#39;</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">dbname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;revision&#39;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1">#traite la mise en forme du result</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSetValueSentence</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;INSERT&#39;</span><span class="p">,</span>
                                                          <span class="n">tablename</span><span class="o">=</span><span class="n">dbname</span><span class="p">,</span>
                                                          <span class="n">listoffields</span><span class="o">=</span><span class="n">noncriticalfield</span><span class="p">,</span>
                                                          <span class="n">listofrawvalues</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
                        <span class="n">exportparser</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">exportparser</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1">#update seq file to remember last pk of each table</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM sqlite_sequence &quot;</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Revision&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE sqlite_sequence SET seq = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE name = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">exportparser</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="n">datecreation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Revision(datetimerevision, commentaire)  &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; VALUES(&#39;&quot;</span> <span class="o">+</span> <span class="n">datecreation</span> <span class="o">+</span> <span class="s2">&quot;&#39;,&#39;travail horsligne&#39;)&quot;</span>
            <span class="n">exportparser</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qgsiface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">clearWidgets</span><span class="p">()</span>
        <span class="c1"># print(self.dbasetables)</span>







    <span class="k">def</span> <span class="nf">updateIdPkSqL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">listoffields</span><span class="o">=</span><span class="p">[],</span> <span class="n">listofrawvalues</span><span class="o">=</span><span class="p">[],</span> <span class="n">dictpk</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">dictid</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">changeID</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">pktable</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">listoffields</span><span class="p">):</span>

            <span class="k">if</span> <span class="s2">&quot;pk_&quot;</span> <span class="o">==</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">pktable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastRowId</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
                <span class="c1"># print(pktable)</span>
                <span class="n">pkoldtable</span> <span class="o">=</span> <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">dictpk</span><span class="p">[</span><span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="n">pkoldtable</span><span class="p">]</span> <span class="o">=</span> <span class="n">pktable</span>


            <span class="k">elif</span> <span class="s2">&quot;id_&quot;</span> <span class="o">==</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>

                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">changeID</span> <span class="p">:</span>
                    <span class="n">idtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLastId</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idtable</span> <span class="o">=</span> <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idtable</span><span class="p">))</span>

                <span class="n">oldid</span> <span class="o">=</span> <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">dictid</span><span class="p">[</span><span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="n">oldid</span><span class="p">]</span> <span class="o">=</span> <span class="n">idtable</span>

            <span class="k">elif</span> <span class="s2">&quot;lid_&quot;</span> <span class="o">==</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dictid</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dictid</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictid</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]][</span><span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span>  <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>    <span class="p">))</span>

                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error lid_&#39;</span> <span class="p">)</span>
                            <span class="c1"># print(dictid[field.split(&#39;_&#39;)[1]].keys())</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;base : &#39;</span> <span class="p">,</span><span class="n">tablename</span><span class="p">,</span> <span class="s1">&#39; - column : &#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="s1">&#39; - lid value : &#39;</span><span class="p">,</span><span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>  <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>

            <span class="k">elif</span> <span class="s2">&quot;lpk_&quot;</span> <span class="o">==</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>

                <span class="c1">#if &quot;lpk_revision_begin&quot; in self.dbasetables[tablename][&#39;fields&#39;].keys():</span>
                <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;lpk_revision_begin&quot;</span><span class="p">:</span>
                    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lpk_revision_begin&#39;</span><span class="p">)</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">))</span>



                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dictpk</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dictpk</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictpk</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]][</span><span class="n">listofrawvalues</span><span class="p">[</span><span class="n">k</span><span class="p">]]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error lpk_&#39;</span><span class="p">,</span> <span class="n">listofrawvalues</span><span class="p">)</span>


        <span class="k">if</span> <span class="s2">&quot;lpk_revision_begin&quot;</span> <span class="ow">in</span> <span class="n">listoffields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">changeID</span><span class="p">:</span>
            <span class="c1">#pkcurrentable</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; SELECT pk_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FROM &quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE id_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idtable</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND lpk_revision_end IS NULL&quot;</span>

            <span class="n">tempres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempres</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">pkcurrenttable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; SET lpk_revision_end = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrevision</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkcurrenttable</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">docommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># if i % 50 == 0:</span>
            <span class="c1"># if debug: logging.getLogger(&quot;Lamia&quot;).debug(&#39; field, value : %s %s  &#39;, str(fields), str(values))</span>

        <span class="k">if</span> <span class="n">pktable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># update line</span>
            <span class="n">sqlup</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; SET &quot;</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
                <span class="n">sqlup</span> <span class="o">+=</span> <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
            <span class="n">sqlup</span> <span class="o">=</span> <span class="n">sqlup</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sqlup</span> <span class="o">+=</span> <span class="s2">&quot; WHERE pk_&quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pktable</span><span class="p">)</span>

            <span class="c1">#self.query(sqlup, docommit=False)</span>



        <span class="k">return</span> <span class="n">sqlup</span>





    <span class="k">def</span> <span class="nf">createSetValueSentence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;INSERT&#39;</span><span class="p">,</span><span class="n">tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">listoffields</span><span class="o">=</span><span class="p">[],</span> <span class="n">listofrawvalues</span><span class="o">=</span><span class="p">[]):</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; fields / rawvalues </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">listoffields</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">listofrawvalues</span><span class="p">))</span>

        <span class="n">restemp</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">listofrawvalues</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">listoffields</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;geom&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                        <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">listoffields</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">and</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># print(&#39;geom&#39;, &quot;ST_GeomFromText(&#39;&quot; + res + &quot;&#39;, &quot; + str(self.crsnumber)  + &quot;)&quot;)</span>
                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ST_GeomFromText(&#39;&quot;</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1">#print(res, str(type(res)))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>  <span class="ow">and</span> <span class="n">listoffields</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;geom&#39;</span><span class="p">:</span>
                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">listoffields</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">and</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># print(&#39;geom&#39;, &quot;ST_GeomFromText(&#39;&quot; + res + &quot;&#39;, &quot; + str(self.crsnumber)  + &quot;)&quot;)</span>
                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ST_GeomFromText(&#39;&quot;</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crsnumber</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">restemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;INSERT&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO &quot;</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">listoffields</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; VALUES(&quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">restemp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;UPDATE&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot; UPDATE &quot;</span> <span class="o">+</span> <span class="n">tablename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; SET &quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">listoffields</span><span class="p">):</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">restemp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">sql</span>



<div class="viewcode-block" id="DBaseParser.copyRessourceFile"><a class="viewcode-back" href="../../../API.html#Lamia.main.DBaseParser.DBaseParser.copyRessourceFile">[docs]</a>    <span class="k">def</span> <span class="nf">copyRessourceFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fromfile</span><span class="p">,</span> <span class="n">tofile</span><span class="p">,</span> <span class="n">withthumbnail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copywholedirforraster</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param fromrep:</span>
<span class="sd">        :param fromfile:</span>
<span class="sd">        :param torep:</span>
<span class="sd">        :param withthumbnail: 0 : copy  file + create thumbnail ; 1 : copy only thumnail; 2 : copyonly file</span>
<span class="sd">        :param copywholedirforraster:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Copy </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fromfile</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">tofile</span><span class="p">))</span>

        <span class="n">fromfile</span> <span class="o">=</span> <span class="n">fromfile</span>
        <span class="n">fromdir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fromfile</span><span class="p">)</span>
        <span class="n">fromfilename</span><span class="p">,</span> <span class="n">fromfileext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fromfile</span><span class="p">))</span>
        <span class="n">destinationfile</span> <span class="o">=</span> <span class="n">tofile</span>
        <span class="n">destinationdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">destinationfile</span><span class="p">)</span>
        <span class="n">destinationfilename</span><span class="p">,</span> <span class="n">destinationfileext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">destinationfile</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fromfile</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">copywholedirforraster</span> <span class="ow">and</span> <span class="s1">&#39;Rasters&#39;</span> <span class="ow">in</span> <span class="n">fromfile</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destinationdir</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">fromdir</span><span class="p">,</span> <span class="n">destinationdir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destinationdir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destinationdir</span><span class="p">)</span>

                <span class="n">fromfilebase</span><span class="p">,</span> <span class="n">fromext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fromfile</span><span class="p">)</span>
                <span class="n">tofilebase</span><span class="p">,</span> <span class="n">toext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">destinationfile</span><span class="p">)</span>


                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fromfilebase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">fromfilebase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;croquis&#39;</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fromfile</span><span class="p">,</span> <span class="n">destinationfile</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">fromext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.shp&#39;</span><span class="p">]:</span>
                    <span class="n">dirfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fromdir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fromdir</span><span class="p">,</span><span class="n">f</span><span class="p">))]</span>
                    <span class="k">for</span> <span class="n">dirfile</span> <span class="ow">in</span> <span class="n">dirfiles</span><span class="p">:</span>
                        <span class="n">dirfilebase</span><span class="p">,</span> <span class="n">dirfileext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">dirfile</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dirfilebase</span> <span class="o">==</span> <span class="n">fromfilename</span><span class="p">:</span>
                            <span class="n">fromshpfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fromdir</span><span class="p">,</span><span class="n">dirfilebase</span> <span class="o">+</span> <span class="n">dirfileext</span> <span class="p">)</span>
                            <span class="n">toshpfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destinationdir</span><span class="p">,</span><span class="n">destinationfilename</span> <span class="o">+</span> <span class="n">dirfileext</span><span class="p">)</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fromshpfile</span><span class="p">,</span> <span class="n">toshpfile</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">withthumbnail</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">PILexists</span> <span class="ow">and</span> <span class="n">fromext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]:</span>

                        <span class="n">possibletbnailfile</span> <span class="o">=</span> <span class="n">fromfilebase</span> <span class="o">+</span> <span class="s2">&quot;_thumbnail.png&quot;</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">possibletbnailfile</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">possibletbnailfile</span> <span class="o">!=</span> <span class="n">tofilebase</span> <span class="o">+</span> <span class="s2">&quot;_thumbnail.png&quot;</span><span class="p">:</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">possibletbnailfile</span><span class="p">,</span> <span class="n">tofilebase</span> <span class="o">+</span> <span class="s2">&quot;_thumbnail.png&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span>
                            <span class="n">im</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fromfile</span><span class="p">)</span>
                            <span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tofilebase</span> <span class="o">+</span> <span class="s2">&quot;_thumbnail.png&quot;</span><span class="p">,</span> <span class="s2">&quot;PNG&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">withthumbnail</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fromfile</span><span class="p">,</span> <span class="n">destinationfile</span><span class="p">)</span></div>




    <span class="k">def</span> <span class="nf">setLoadingProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progressbar</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">progressbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progressbar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Lamia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Chargement </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">val</span> <span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>




    <span class="k">def</span> <span class="nf">getTimeNow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span>  <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">process_time</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Artelia

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>