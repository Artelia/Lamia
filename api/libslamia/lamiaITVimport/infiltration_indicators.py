# -*- coding: utf-8 -*-

"""
This file is part of LAMIA.

    LAMIA is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    LAMIA is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Foobar.  If not, see <https://www.gnu.org/licenses/>.

"""
"""
  * Copyright (c) 2017-2020 ARTELIA Commit <lamia@arteliagroup.com>
  * 
  * SPDX-License-Identifier: GPL-3.0-or-later
  * License-Filename: LICENSING.md
 """


import os, importlib, tempfile, pprint, shutil
from collections import OrderedDict
import sys, glob, inspect, logging, textwrap
import Lamia
from ..abstractlibslamia import AbstractLibsLamia

import qgis
from qgis.PyQt import QtGui, uic, QtCore, QtXml

import pandas as pd
import numpy as np

# dictionary with code of deformations as key
# first value is the factor or alpha parameter
# second value is L if you multiply by observated length or P if you multiply by P parameter
# we sum and threshold to defined a value in [1, 2, 3, 4]
all_infiltration_indicators = {
    "INF4":
    {
        "BAA"	:[1,	"P"],	# DEFORMATION
        "BAAA"	:[0,	"P"],	# DEFORMATION VERTICALE / REDUCTION VERTICALE DE LA SECTION
        "BAAB"	:[1,	"P"],	# DEFORMATION HORIZONTALE
        "BABA"	:[1,	"L"],	# MICRO-FISSURE
        "BABB"	:[1,	"L"],	# FISSURE FERMEE
        "BABBA"	:[0,	"L"],	# FISSURE FERMEE LONGITUDINALE
        "BABBB"	:[0,	"L"],	# FISSURE FERMEE CIRCONFERENTIELLE
        "BABBC"	:[0,	"L"],	# FISSURE - FERMEE - COMPLEXE 
        "BABBD"	:[0,	"L"],	# FISSURE FERMEE HELICOIDALE
        "BABC"	:[2,	"L"],	# FISSURE OUVERTE
        "BABCA"	:[2,	"L"],	# FISSURE - OUVERTE - LONGITUDINALE
        "BABCB"	:[2,	"L"],	# FISSURE OUVERTE CIRCONFERENTIELLE
        "BABCC"	:[2,	"L"],	# FISSURE - OUVERTE - COMPLEXE
        "BABCD"	:[2,	"L"],	# FISSURE OUVERTE HELICOIDALE
        "BACA"	:[2,	"P"],	# RUPTURE / EFFONDREMENT - RUPTURE
        "BACB"	:[3,	"P"],	# EFFONDREMENT PARTIEL
        "BACC"	:[3,	"P"],	# EFFONDREMENT TOTAL
        # "BAD"	:[	,	"#"], MACONNERIE
        "BADA"	:[1,	"P"],	# MACONNERIE DEPLACEE
        "BADB"	:[2,	"P"],	# PIECES DE MAÃ‡ONNERIE MANQUANTES
        "BADBA"	:[2,	"P"],	# PIECES MANQUANTES -AUTRE COUCHE VISIBLE 
        "BADBB"	:[2,	"P"],	# PIECES MANQUANTES - RIEN DE VISIBLE
        "BADC"	:[2,	"P"],	# AFFAISSEMENT DE RADIER
        "BADD"	:[3,	"P"],	# EFFONDREMENT
        # "BAE"	:[	,	"#"], MORTIER
        "BAFA"	:[0,	"L"],	# DEGRADATION DE SURFACE - RUGOSITE ACCRUE
        "BAFAA"	:[0,	"L"],	# DEGRADATION DE SURFACE - RUGOSITE ACCRUE - ABRASION
        "BAFAB"	:[0,	"L"],	# DEGRADATION DE SURFACE - RUGOSITE ACCRUE - ATTAQUE CHIMIQUE - GENERALE
        "BAFAC"	:[0,	"L"],	# DEGRADATION DE SURFACE - RUGOSITE ACCRUE - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFAD"	:[0,	"L"],	# DEGRADATION DE SURFACE - RUGOSITE ACCRUE - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFAE"	:[0,	"L"],	# DEGRADATION DE SURFACE - RUGOSITE ACCRUE - AUCUNE CAUSE EVIDENTE
        "BAFB"	:[2,	"L"],	# DEGRADATION DE SURFACE - ECAILLAGE CORROSION
        "BAFBA"	:[2,	"L"],	# DEGRADATION DE SURFACE - ECAILLAGE - ABRASION
        "BAFBB"	:[2,	"L"],	# DEGRADATION DE SURFACE - ECAILLAGE - ATTAQUE CHIMIQUE - GENERALE
        "BAFBC"	:[2,	"L"],	# DEGRADATION DE SURFACE - ECAILLAGE - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFBD"	:[2,	"L"],	# DEGRADATION DE SURFACE - ECAILLAGE - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFBE"	:[2,	"L"],	# DEGRADATION DE SURFACE - ECAILLAGE - AUCUNE CAUSE EVIDENTE
        "BAFC"	:[0,	"L"],	#  DEGRADATION DE SURFACE - GRANULATS EXPOSES
        "BAFCA"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS EXPOSES - ABRASION
        "BAFCB"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS EXPOSES - ATTAQUE CHIMIQUE - GENERALE
        "BAFCC"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS EXPOSES - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFCD"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS EXPOSES - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFCE"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS EXPOSES - AUCUNE CAUSE EVIDENTE
        "BAFD"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS DECHAUSSES
        "BAFDA"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS DECHAUSSES - ABRASION
        "BAFDB"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS DECHAUSSES - ATTAQUE CHIMIQUE - GENERALE
        "BAFDC"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS DECHAUSSES - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFDD"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS DECHAUSSES - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFDE"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS DECHAUSSES - AUCUNE CAUSE EVIDENTE
        "BAFE"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS MANQUANTS
        "BAFEA"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS MANQUANTS - ABRASION
        "BAFEB"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS MANQUANTS - ATTAQUE CHIMIQUE - GENERALE
        "BAFEC"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS MANQUANTS - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFED"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS MANQUANTS - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFEE"	:[0,	"L"],	# DEGRADATION DE SURFACE - GRANULATS MANQUANTS - AUCUNE CAUSE EVIDENTE
        "BAFF"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE VISIBLE
        "BAFFA"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE VISIBLE - ABRASION
        "BAFFB"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE VISIBLE - ATTAQUE CHIMIQUE - GENERALE
        "BAFFC"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE VISIBLE - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFFD"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE VISIBLE - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFFE"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE VISIBLE - AUCUNE CAUSE EVIDENTE
        "BAFG"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE DEPASSANT SURFACE
        "BAFGA"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE DEPASSANT SURFACE - ABRASION
        "BAFGB"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE DEPASSANT SURFACE - ATTAQUE CHIMIQUE - GENERALE
        "BAFGC"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE DEPASSANT SURFACE - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFGD"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE DEPASSANT SURFACE - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFGE"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE DEPASSANT SURFACE - AUCUNE CAUSE EVIDENTE
        "BAFH"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE CORRODEE
        "BAFHA"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE CORRODEE - ABRASION
        "BAFHB"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE CORRODEE - ATTAQUE CHIMIQUE - GENERALE
        "BAFHC"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE CORRODEE - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFHD"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE CORRODEE - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFHE"	:[0,	"L"],	# DEGRADATION DE SURFACE - ARMATURE CORRODEE - AUCUNE CAUSE EVIDENTE
        "BAFI"	:[3,	"L"],	# DEGRADATION DE SURFACE - PAROI MANQUANTE
        "BAFIA"	:[3,	"L"],	# DEGRADATIONS DE SURFACE - PAROI MANQUANTE - ABRASION
        "BAFIB"	:[3,	"L"],	# DEGRADATION DE SURFACE - PAROI MANQUANTE - ATTAQUE CHIMIQUE - GENERALE
        "BAFIC"	:[3,	"L"],	# DEGRADATION DE SURFACE - PAROI MANQUANTE - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFID"	:[3,	"L"],	# DEGRADATION DE SURFACE - PAROI MANQUANTE - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFIE"	:[3,	"L"],	# DEGRADATIONS DE SURFACE - PAROI MANQUANTE - AUCUNE CAUSE EVIDENTE
        "BAFJ"	:[0,	"L"],	# DEGRADATION DE SURFACE - PRODUITS CORROSIFS EN SURFACE
        "BAFJA"	:[0,	"L"],	# DEGRADATION DE SURFACE - PRODUITS CORROSIFS EN SURFACE - ABRASION
        "BAFJB"	:[0,	"L"],	# DEGRADATION DE SURFACE - PRODUITS CORROSIFS EN SURFACE - ATTAQUE CHIMIQUE - GENERALE
        "BAFJC"	:[0,	"L"],	# DEGRADATION DE SURFACE - PRODUITS CORROSIFS EN SURFACE - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFJD"	:[0,	"L"],	# DEGRADATION DE SURFACE - PRODUITS CORROSIFS EN SURFACE - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFJE"	:[0,	"L"],	# DEGRADATION DE SURFACE - PRODUITS CORROSIFS EN SURFACE - AUCUNE CAUSE EVIDENTE
        "BAFKA"	:[0,	"L"],	# DEGRADATIONS DE SURFACE - POINCONNEMENT
        "BAFZ"	:[3,	"L"],	# DEGRADATION DE SURFACE - AUTRES DEGRADATIONS
        "BAFZA"	:[3,	"L"],	# DEGRADATION DE SURFACE - AUTRES DEGRADATIONS - ABRASION
        "BAFZB"	:[3,	"L"],	# DEGRADATION DE SURFACE - AUTRES DEGRADATIONS - ATTAQUE CHIMIQUE - GENERALE
        "BAFZC"	:[3,	"L"],	# DEGRADATION DE SURFACE - AUTRES DEGRADATIONS - ATTAQUE CHIMIQUE - DUE A H2SO4 - AU DESSUS DU NIVEAU DE L'EAU
        "BAFZD"	:[3,	"L"],	# DEGRADATION DE SURFACE - AUTRES DEGRADATIONS - ATTAQUE CHIMIQUE - DUE AUX EU - AU DESSOUS DU NIVEAU DE L'EAU
        "BAFZE"	:[3,	"L"],	# DEGRADATION DE SURFACE - AUTRES DEGRADATIONS - AUCUNE CAUSE EVIDENTE
        # "BAG"	:[	,	"#"], BRANCHEMENT PENETRANT
        "BAHA"	:[0,	"P"],	# POSITION INCORRECTE DU BRANCHEMENT SUR LA CANALISATION
        "BAHB"	:[2,	"P"],	# PRESENCE D'UN VIDE ENTRE LA CONDUITE DE RACCORDEMENT ET LA CANALISATION PRINCIPAL
        "BAHC"	:[2,	"P"],	# PRESENCE D'UN VIDE PARTIEL ENTRE LA CONDUITE DE RACCORDEMENT ET LA CANALISATION PRINCIPAL
        "BAHD"	:[2,	"P"],	# CONDUITE DE RACCORDEMENT ENDOMMAGEE
        "BAHE"	:[0,	"P"],	# CONDUITE DE RACCORDEMENT OBTRUEE
        "BAHZ"	:[0,	"P"],	# RACCORDEMENT DEFECTUEUX
        "BAIA"	:[3,	"P"],	# ANNEAU D'ETANCHEITE
        "BAIAA"	:[3,	"P"],	# JOINT D'ETANCHEITE APPARENT - ANNEAU D'ETANCHEITE AVEC BOUCLE DEPLACEE MAIS NE DEPASSANT PAS DANS LA CANALISATION
        "BAIAB"	:[3,	"P"],	# JOINT D'ETANCHEITE APPARENT - PENETRANT MAIS NON ROMPU (AU-DESSUS DE LA MEDIANE)
        "BAIAC"	:[3,	"P"],	# JOINT D'ETANCHEITE APPARENT - PENETRANT MAIS NON ROMPU (AU-DESSOUS DE LA MEDIANE)
        "BAIAD"	:[3,	"P"],	# JOINT D'ETANCHEITE APPARENT - PENETRANT - ROMPU
        "BAIZ"	:[0,	"P"],	# AUTRE ELEMENT D'ETANCHEITE
        "BAJA"	:[0,	"P"],	# DEBOITEMENT LONGITUDINAL
        "BAJB"	:[0,	"P"],	# DECENTRAGE RADIAL
        "BAJC"	:[0,	"P"],	# DEVIATION ANGULAIRE
        # "BAKA"	:[	,	"#"], REVETEMENT DE CANALISATION  DETACHE
        # "BAKB"	:[	,	"#"], DECOLORATION DU REVETEMENT
        # "BAKC"	:[	,	"#"], EXTREMITE DU REVETEMENT DEFECTUEUSE
        # "BAKD"	:[	,	"#"], REVETEMENT ONDULE
        # "BAKDA"	:[	,	"#"], REVETEMENT ONDULE - LONGITUDINALEMENT
        # "BAKDB"	:[	,	"#"], REVETEMENT ONDULE - CIRCONFERENTIELLEMENT
        # "BAKDC"	:[	,	"#"], REVETEMENT ONDULE - COMPLEXE
        # "BAKE"	:[	,	"#"], REVETEMENT CLOQUE
        # "BAKZ"	:[	,	"#"], AUTRE DE FAUT DE REVETEMENT
        "BAN"	:[0,	"L"],	# CONDUITE POREUSE
        "BAO"	:[3,	"P"],	# SOL VISIBLE PAR LE DEFAUT
        "BAP"	:[3,	"P"],	# VIDE VISIBLE PAR LE DEFAUT
        "BBAA"	:[0,	"P"],	# GROSSE RACINE ISOLEE
        "BBAB"	:[0,	"P"],	# RADICELLES
        "BBAC"	:[0,	"P"],	# ENSEMBLE COMPLEXE DE RACINES
        "BBBA"	:[2,	"P"],	# DEPOTS ADHERENTS - CONCRETION
        "BBBB"	:[0,	"P"],	# DEPOTS ADHERENTS - GRAISSE
        "BBBC"	:[0,	"P"],	# DEPOTS ADHERENTS - ENCRASSEMENT
        "BBBZ"	:[0,	"P"],	# DEPOTS ADHERENTS - AUTRE
        # "BBCA"	:[	,	"#"], DEPOTS - FINS
        # "BBCB"	:[	,	"#"], DEPOTS -  GROSSIERS
        # "BBCC"	:[	,	"#"], DEPOTS - DURS OU COMPACTES
        # "BBCZ"	:[	,	"#"], DEPOTS - AUTRES
        # "BBDA"	:[	,	"#"], ENTREE DE TERRE - SABLE
        # "BBDB"	:[	,	"#"], ENTREE DE TERRE - TOURBE
        # "BBDC"	:[	,	"#"], ENTREE DE TERRE - MATERIAU FIN
        # "BBDD"	:[	,	"#"], ENTREE DE TERRE - GRAVIER
        # "BBDZ"	:[	,	"#"], ENTREE DE TERRE - AUTRE
        # "BBEA"	:[	,	"#"], AUTRES OBSTABLES - BRIQUETAGE OU MACONNERIE GISANT SUR LE RADIER
        # "BBEB"	:[	,	"#"], AUTRES OBSTABLES - FRAGMENT DE CONDUITE BRISEE GISANT SUR LE RADIER
        # "BBEC"	:[	,	"#"], AUTRES OBSTACLES - OBJET SUR LE RADIER
        # "BBED"	:[	,	"#"], AUTRES OBSTABLES - OBSTACLE DEPASSANT DE LA PAROI
        # "BBEE"	:[	,	"#"], AUTRES OBSTACLES - OBSTACLE COINCE DANS L'ASSEMBLAGE
        # "BBEF"	:[	,	"#"], AUTRES OBSTABLES - OBSTACLE TRAVERSANT UN RACCORDEMENT OU UNE CONDUITE DE RACCORDEMENT
        # "BBEG"	:[	,	"#"], AUTRES OBSTACLES - CONDUITE EXTERNE OU CABLES INSERES DANS LA CANALISATION
        # "BBEH"	:[	,	"#"], AUTRES OBSTABLES - OBSTACLE INTEGRE A LA STRUCTURE
        # "BBEZ"	:[	,	"#"], AUTRES OBSTACLES - AUTRE
        "BBFA"	:[2,	"P"],	# INFILTRATION - SUINTEMENT
        "BBFB"	:[2,	"P"],	# INFILTRATION - GOUTTE A GOUTTE
        "BBFC"	:[3,	"P"],	# INFILTRATION - ECOULEMENT CONTINU
        "BBFD"	:[3,	"P"],	# INFILTRATION - JAILLISSEMENT
        # "BCAA"	:[	,	"#"], RACCORDEMENT - CULOTTE
        "BCAB"	:[2,	"1"],	# RACCORDEMENT - SELLE - CAROTTEE
        "BCAC"	:[2,	"1"],	# RACCORDEMENT - SELLE - BURINEE
        "BCAD"	:[2,	"1"],	# RACCORDEMENT - PIQUAGE DIRECT - CAROTTE
        "BCAE"	:[2,	"1"],	# RACCORDEMENT - PIQUAGE DIRECT - BURINE
        # "BCAF"	:[	,	"#"], RACCORDEMENT - RACCORD AUTRE QUE CULOTTE
        # "BCAG"	:[	,	"#"], RACCORDEMENT - TYPE DE RACCORD INCONNU
        # "BCAZ"	:[	,	"#"], RACCORDEMENT - AUTRE TYPE DE RACCORDEMENT
        # "BCC"	:[	,	"#"], COURBURE COLLECTEUR
        # "BCCA"	:[	,	"#"], COURBURE COLLECTEUR - VERS LA GAUCHE
        # "BCCAA"	:[	,	"#"], COURBURE COLLECTEUR - VERS LA GAUCHE - VERS LE HAUT
        # "BCCAB"	:[	,	"#"], COURBURE COLLECTEUR - VERS LA GAUCHE - VERS LE BAS
        # "BCCB"	:[	,	"#"], COURBURE COLLECTEUR - VERS LA DROITE
        # "BCCBA"	:[	,	"#"], COURBURE COLLECTEUR - VERS LA DROITE - VERS LE HAUT
        # "BCCBB"	:[	,	"#"], COURBURE COLLECTEUR - VERS LA DROITE - VERS LE BAS
        "D"     :[2,	"P"],   # CONTRE PENTE
        "DACB"	:[3,	"P"],	# EFFONDREMENT PARTIEL
        "DBAB"	:[0,	"P"],	# RADICELLES
        "DBAC"	:[0,	"P"],	# ENSEMBLE COMPLEXE DE RACINES
        # "DBCB"	:[	,	"#"], DEPOTS -  GROSSIERS
        # "DBEG"	:[	,	"#"], AUTRES OBSTACLES - CONDUITE EXTERNE OU CABLES INSERES DANS LA CANALISATION
    },
}
